---
title: Class 05 - Pentesting
date: 2024-10-10 05:00:00 +0200
categories: [categories]
tags: [tags]     # TAG names should always be lowercase
---

<!-- <hr style="border: none; height: 10px; background-color: gray;" />
# 0. Demo de introducción
<hr style="border: none; height: 10px; background-color: gray;" /> -->


# Buffer Overflows

- Hoy vamos a explorar la vulnerabilidad CVE-2015-1635.
- Está relacionada con el servidor web de Microsoft, Internet Information , Services (IIS), específicamente en las versiones 6.0, 7.0, 7.5, y 8.0.
- Esta vulnerabilidad reside en el manejo de solicitudes HTTP en el servidor web que el servicio IIS implementa.

## Vulnerabilidad HTTP.sys (CVE-2015-1635): Ejecución Remota de Código en IIS
La vulnerabilidad **CVE-2015-1635**, conocida como la vulnerabilidad de **HTTP.sys**, es un fallo crítico en el controlador **HTTP.sys** de **Windows**, que maneja las solicitudes HTTP en el servidor **IIS** (**Internet Information Services**). 

Esta vulnerabilidad permite la **ejecución remota de código (RCE)**, lo que podría otorgar al atacante acceso completo al sistema con privilegios de nivel SYSTEM.

## Descripción General
**HTTP.sys** es un controlador de modo kernel en Windows que procesa solicitudes y respuestas HTTP, principalmente utilizado por IIS y otros servicios basados en web. Debido a su ejecución en modo kernel, cualquier vulnerabilidad en este controlador puede tener graves consecuencias, ya que el código malicioso que se ejecute a través de esta vulnerabilidad tendrá los mismos privilegios que el sistema.

## Naturaleza de la Vulnerabilidad
- **Tipo**: Ejecución Remota de Código (RCE)
- **CVE**: CVE-2015-1635
- **Sistemas Afectados**: Windows 7, Windows 8.x, Windows Server 2008 R2, Windows Server 2012 R2 y cualquier otro sistema con IIS y HTTP.sys habilitado.
- **Severidad**: Crítica

El fallo surge cuando **HTTP.sys** maneja de manera incorrecta solicitudes HTTP especialmente manipuladas que contienen el encabezado `Range` malformado. El encabezado `Range` permite a los clientes solicitar rangos específicos de bytes de un recurso. Un encabezado `Range` manipulado puede desencadenar una **corrupción de memoria** en el controlador **HTTP.sys**.

## Cómo Funciona el Exploit
1. **Solicitud HTTP Manipulada**: El atacante envía una solicitud HTTP especialmente diseñada que contiene un encabezado `Range` malformado al servidor objetivo.

Por ejemplo:

```bash
GET / HTTP/1.1
Host: servidor-objetivo
Range: bytes=0-18446744073709551615
```

2. **Corrupción de Memoria**: Cuando el controlador HTTP.sys procesa este encabezado `Range` malformado, se produce una corrupción de memoria, lo que lleva a desbordamientos de búfer u otros problemas relacionados con la memoria.

3. **Ejecución Remota de Código**: Gracias al desbordamiento de búfer, el atacante puede tomar el control del flujo de ejecución de la memoria. Esto permite ejecutar código arbitrario con privilegios SYSTEM.

4. **Compromiso del Sistema**: Una vez que el atacante obtiene privilegios de SYSTEM, puede instalar programas maliciosos, robar información sensible, manipular datos o continuar explotando el sistema.

## Impacto de la Vulnerabilidad
- **Ejecución Remota de Código**: El atacante puede tomar control completo del servidor afectado sin necesidad de autenticarse previamente.
- **Escalación de Privilegios**: Dado que **HTTP.sys** se ejecuta en modo kernel, explotar esta vulnerabilidad otorga privilegios de SYSTEM, el nivel más alto de privilegios en un sistema Windows.
- **Superficie de Ataque Amplia**: Cualquier sistema Windows que use IIS o servicios que utilicen **HTTP.sys** es vulnerable si acepta solicitudes HTTP.

# Uso del Módulo de Metasploit `auxiliary/dos/http/ms15_034_ulonglongadd`
Para aprovechar esta vulnerabilidad, Metasploit ofrece un módulo específico que puedes utilizar para probar la presencia de esta vulnerabilidad en un servidor. El módulo que debes usar es el siguiente:

```bash
use auxiliary/dos/http/ms15_034_ulonglongadd
```

### Configuración del Módulo
1. **Cargar el módulo**: Abre Metasploit y carga el módulo con el comando:

```bash
use auxiliary/dos/http/ms15_034_ulonglongadd
```

2. **Configurar la dirección IP del objetivo**: Una vez cargado, configura el objetivo con el siguiente comando:

```bash
set RHOST ip address
```

3. **Ejecutar el ataque**: Ejecuta el módulo para comprobar si el servidor es vulnerable:

```bash
run
```

Este módulo comprobará si el servidor es vulnerable a la ejecución de código remoto o a una denegación de servicio (DoS) basada en el fallo de **HTTP.sys**. Si el servidor es vulnerable, podría colapsar o reiniciarse debido a la corrupción de memoria causada por el ataque.


# Mitigación y Soluciones
Microsoft lanzó un parche como parte de la actualización MS15-034 en abril de 2015 para solucionar esta vulnerabilidad. Se recomienda encarecidamente que se aplique este parche para proteger los sistemas vulnerables.

1. **Instalar el parche de seguridad**: Asegúrate de que todos los sistemas Windows afectados estén actualizados con el parche MS15-034.
2. **Restringir el acceso HTTP**: Limita el acceso a los servicios HTTP, especialmente en redes no confiables, hasta que se pueda aplicar el parche.
3. **Monitorización de logs**: Monitorea las solicitudes HTTP que contengan encabezados Range inusuales, como Range: bytes=0-18446744073709551615.

**Fin del Test**

<hr style="border: none; height: 10px; background-color: gray;" />

# 1. Introducción a Buffer Overflows**

<hr style="border: none; height: 10px; background-color: gray;" />


En este sección abordaremos un ataque de desbordamiento de búfer en Windows de 32 bits, de forma práctica y paso a paso. Al finalizar, serás capaz de llevar a cabo este tipo de ataques por ti mismo, usando Windows y Kali Linux.


**1. Introducción a la Memoria**

En este módulo, estudiaremos la **anatomía de la memoria** y la **estructura de la pila (stack)**. Aquí entenderemos cómo la memoria se organiza y el papel que juegan los registros importantes en los desbordamientos de búfer.

Aprenderemos sobre los siguientes componentes:

- **ESP** (Puntero de la pila)
- **EBP** (Base del marco de la pila)
- **EIP** (Puntero de instrucción)

![alt text](/assets/images/memorystructure.png)

Comprenderemos cómo funciona el espacio de búfer y qué ocurre cuando este se desborda. El objetivo es que al final recnocer cómo el desbordamiento afecta al EIP, lo que permite tomar control del flujo del programa.

![alt text](/assets/images/memorystacks.png)

Si llenamos nuestro buffer space:

![alt text](/assets/images/fillingbuffer.png)

Pero, en un ataque buffer overflow:

![alt text](/assets/images/bufferoverflowattack.png)

2. **Pasos para un Desbordamiento de Búfer**

Los pasos básicos que seguiremos para realizar un ataque de desbordamiento de búfer son los siguientes:

- **Spiking**: Un método que utilizaremos para encontrar partes vulnerables en un programa.
- **Fuzzing**: Enviaremos una gran cantidad de caracteres a un programa para ver si podemos hacerlo fallar y determinar en qué punto sucede el fallo (offset).
- **Control del EIP**: Una vez tengamos el offset, sobrescribiremos el registro EIP para tomar control del flujo del programa.
- **Identificación de caracteres malos**: Limpiaremos el código de los caracteres que puedan causar problemas.
- **Generación de shellcode**: Crearemos un código malicioso que nos permitirá obtener un reverse shell y tomar el control del sistema.

3. **Herramientas a utilizar**

Para completar esta sección, utilizaremos una serie de herramientas:

- **Máquina con Windows**: para ejecutar el servidor vulnerable.
- **Vulnerable Server (Voland Server)**: Este software vulnerable se ejecutará en nuestra máquina Windows.
- **Immunity Debugger**: Nos permitirá analizar el comportamiento del programa y realizar el seguimiento del desbordamiento de búfer.
- **Kali Linux**: Será nuestro sistema atacante, aunque puedes utilizar cualquier distribución de Linux que prefieras.

<hr style="border: none; height: 10px; background-color: gray;" />

# 1. Spiking

<hr style="border: none; height: 10px; background-color: gray;" />

- Antes de comenzar con el proceso de spiking, es importante realizar algunos pasos de preparación. Primero, se debe **desactivar la protección en tiempo real de Windows Defender**, ya que este podría bloquear el servidor vulnerable **Voland Server** cuando se intenten ejecutar exploits o acciones maliciosas.

- Además, es necesario que **Immunity Debugger** y **Voland Server** se ejecuten como administrador. Esto es esencial, ya que si no se ejecutan con privilegios de administrador, **Immunity Debugger** no podrá detectar que **Voland Server** está en ejecución y no se podrá acceder al mismo. Además, ejecutar **Voland Server** como administrador también asegurará que, cuando se obtenga un shell inverso, se obtengan permisos de **root** automáticamente, lo que facilitará el proceso.

## Ejecución de Voland Server e Immunity Debugger

- Una vez que ambos programas estén configurados, es hora de ejecutar **Voland Server**. Después de haber extraído el archivo en una carpeta, simplemente se debe hacer clic derecho sobre el archivo ejecutable y seleccionar "*Ejecutar como administrador*". Cuando el servidor esté en funcionamiento, deberá verse una ventana de consola indicando que está listo.

- Luego, se debe iniciar **Immunity Debugger** también como administrador. Dentro de **Immunity**, se debe seleccionar **File > Attach**, buscar el proceso de **Voland Server**, y adjuntarlo. En la esquina inferior derecha, debería aparecer "**paused**". Simplemente se debe presionar el botón de "**play**" para que aparezca el estado de "**running**". Si todo está en orden, ambos programas estarán funcionando y listos para las siguientes etapas.

## Proceso de Spiking

- El spiking es un método que se utiliza para identificar partes vulnerables en un programa. El objetivo es enviar grandes cantidades de datos a un comando específico y ver si se produce un desbordamiento del búfer, lo que resultaría en un fallo o un bloqueo del programa. Si el programa falla, se identifica esa parte como vulnerable. Si no, se pasa al siguiente comando.

- En este caso, el servidor vulnerable escucha en el puerto **9999**, y los comandos válidos se pueden ver escribiendo **HELP** una vez conectado al servidor usando **Netcat**. Entre los comandos listados, el comando **TRUN** será el foco, ya que es vulnerable a un desbordamiento de búfer.

## Conexión con Netcat

En la máquina Kali Linux, se puede usar **Netcat** para conectarse a **Voland Server**. El comando sería el siguiente:

```bash
nc IP_del_servidor_Windows 9999
```

- Una vez conectado, se puede ingresar el comando **HELP** para ver la lista de comandos válidos. La idea detrás del spiking es tomar uno de estos comandos, en este caso **TRUN**, y enviarle grandes cantidades de datos para ver si ocurre un desbordamiento.

## Uso de Herramientas de Spiking

Para realizar spiking, se utilizará la herramienta **Generic Send TCP**. Esta herramienta permite enviar datos aleatorios de diferentes tamaños a un programa para ver si ocurre un fallo. Aquí está la estructura básica del comando:

```bash
generic_send_tcp <host> <puerto> <script_spike> 0 0
```

- Un **script de spike** debe ser creado para cada comando que se desee probar. Un ejemplo de script para el comando **STATS** podría verse así:

```bash
s_readline();
s_string("STATS");
s_string_variable();
```

- Esto indica que se va a enviar el comando STATS seguido de una serie de datos aleatorios al servidor. El mismo proceso se aplicará al comando TRUN:

```bash
s_readline();
s_string("TRUN");
s_string_variable();
```

- Se debe guardar cada script con un nombre descriptivo, como stats.spk o trun.spk. Luego, se ejecuta Generic Send TCP con los parámetros adecuados para enviar los datos.

## Interpretación de Resultados

- Si el programa es vulnerable, el servidor vulnerable se detendrá y **Immunity Debugger** mostrará un mensaje de error, indicando una **violación de acceso**. Esto indica que se ha sobrescrito el **registro EIP** con datos controlados por el atacante.

- Por ejemplo, si se observa que el **EIP** se sobrescribió con valores como **41414141** (que representan cuatro letras 'A'), entonces se ha conseguido un desbordamiento de búfer. En este punto, el siguiente paso será tomar control del **EIP** para ejecutar código malicioso.

## Siguiente Paso

En la siguiente sección, se profundizará en el proceso de **fuzzing**, que es una técnica similar al spiking, pero automatizando la generación de grandes volúmenes de datos. Se creará un script en **Python** para realizar fuzzing en el comando **TRUN** y continuar con el análisis del desbordamiento de búfer.

<hr style="border: none; height: 10px; background-color: gray;" />

# 2. Fuzing

<hr style="border: none; height: 10px; background-color: gray;" />

El **fuzzing** es muy similar al proceso de **spiking** en el sentido de que se envían muchos caracteres a un comando específico con la intención de hacer que falle. La diferencia es que mientras que en el spiking se prueban múltiples comandos para encontrar cuál es vulnerable, en el fuzzing ya se sabe qué comando es vulnerable, en este caso el comando **TRUN**, y se procede a atacar ese comando de manera específica.

## Preparación

Antes de empezar con el fuzzing, se deben seguir los siguientes pasos de preparación:

1. Ejecutar **Immunity Debugger** con privilegios de administrador.
2. Ejecutar **Voland Server** también como administrador.

Si en algún momento **Voland Server** se bloquea o se cierra debido al fuzzing, es recomendable reiniciar tanto **Immunity Debugger** como **Voland Server**, y volver a adjuntar el proceso en **Immunity Debugger**.

## Desarrollo del Fuzzing

Para realizar el fuzzing, se ha construido un **script en Python**. El objetivo de este script es enviar grandes cantidades de datos al comando **TRUN** para identificar en qué punto se produce un fallo en el servidor.

## Explicación del Script

El script en Python es el siguiente:

```bash
#!/usr/bin/python
import sys, socket
from time import sleep

buffer = "A" * 100

while True:
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect(('IP_DEL_SERVIDOR_WINDOWS', 9999))
        s.send(('TRUN /.:/' + buffer))
        s.close()
        sleep(1)
        buffer = buffer + "A" * 100
    except:
        print("Fuzzing crash en " + str(len(buffer)) + " bytes")
        sys.exit()
```

Este script sigue el siguiente proceso:

1. Se importan los módulos necesarios: **sys**, **socket** (para la conexión) y **sleep** (para añadir pausas entre envíos).
2. Se declara una variable llamada **buffer**, que inicialmente contiene 100 letras "**A**".
3. El script entra en un bucle **while True**, en el que intenta:
- Conectar al servidor vulnerado en la IP y puerto adecuados (9999 para **Voland Server**).
- Enviar el comando vulnerable **TRUN** seguido de un buffer de caracteres "**A**".
- Cerrar la conexión y dormir por un segundo antes de aumentar el tamaño del buffer en 100 caracteres.
- Continuar este proceso hasta que el servidor falle, lo que indicará que se ha producido un desbordamiento de búfer.
4. Cuando el servidor falla, el script imprime el tamaño del buffer que causó el fallo y se cierra.

## Ejecución del Script

Una vez guardado el script en un archivo (por ejemplo, fuzz.py), se le deben otorgar permisos de ejecución con el siguiente comando en **Kali Linux**:

```bash
chmod +x fuzz.py
```

Luego, se ejecuta el script:

```bash
./fuzz.py
```

En este punto, Voland Server comenzará a recibir conexiones y datos en incrementos de 100 bytes. El servidor debería fallar rápidamente, y se observará que el programa se detiene en Immunity Debugger.

## Análisis del Resultado

- Después de que se produce el fallo, Immunity Debugger mostrará un mensaje de vioación de acceso (access violation). Al revisar los registros, se puede notar que el registro EIP no ha sido sobrescrito, pero lo importante es saber aproximadamente cuántos bytes fueron necesarios para hacer que el servidor falle.

- Por ejemplo, si el programa falla con alrededor de 3000 bytes, esto proporciona un punto de referencia para el siguiente paso, que es encontrar el offset exacto donde se sobrescribe el EIP.

## Siguiente Paso
En la siguiente sección, se cubrirá el proceso de encontrar el offset exacto para sobrescribir el EIP. Esto se logrará utilizando un patrón cíclico de caracteres, que permitirá identificar en qué parte del buffer se encuentra el EIP. Una vez que se tenga control sobre el EIP, se podrá redirigir el flujo del programa hacia un código malicioso.

<hr style="border: none; height: 10px; background-color: gray;" />

# 3. Encontrando el Offset

<hr style="border: none; height: 10px; background-color: gray;" />