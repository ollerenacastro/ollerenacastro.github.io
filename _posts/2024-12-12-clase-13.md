---
title: Clase 13 - Caldera Framework & Procmon/Sysmon (Parte 4)
date: 2024-12-12 00:20:00 -0500
categories: [Cybersecurity,Ethical Hacking,Pentesting,Exploitation Techniques]
tags: [Examen Parcial, evaluation]     # TAG names should always be lowercase
---

<!-- <hr style="border: none; height: 10px; background-color: #003b00;" />

# <font color="#87CEEB">Examen Parcial.</font>

<hr style="border: none; height: 10px; background-color: #003b00;" /> -->

## Lab Setup

![alt text](/assets/images/caldera-setup.png)

Configuración del Setup:

- Ambas máquinas deben estar en modo `Nat Network`.
- Asegurarse que en Virtualbox, en `Tools > Network > NAT Networks` exista una red `NatNetwork` con un rango de IP configurado. Para este ejemplo, usaremos la red `10.0.2.0/24` con el DHCP en `enable`.

    ![alt text](/assets/images/natnetworks-config.png)

- Kali Linux: `10.0.2.18`
- Windows: `10.0.2.20`
- Elasticsearch: `10.0.2.21`

## Monitorización de procesos en Procmon

- Vamos a monitorear el comando `hostname` en Powershell. 
- Abrimos Powershell y configuramos el filtro `Command Line` con la condición `contains` equivalente a `hostname`. Luego, click en `Add`.

    ![alt text](/assets/images/filtro-procmon-hostanme.png)

- Asegurarse que la captura de events esté activa.

- Abrir una terminal de Powershell y ejecutar `hostname`.
- Revisar los events que aparecen en el canvas de Procmon.
- Activar las columnas

    ![alt text](/assets/images/procmon-columnas.png)

- Los eventos en Procmon aparecen ni bien se ejecute el comando `hostname` en la terminal de Powershell.

    ![alt text](/assets/images/procmon-eventos-hostname.png)

- Exportar los eventos: `File > Save`. Asignar un nombre conveniente para este archivo y seleccionar `Events displayed using current filter` sin `Also include profiling events`. En `Format`, seleccionar `Comma-Separated Values (CSV)`:

    ![alt text](/assets/images/procmon-eventos-hostname-export.png)

## Inspección de los eventos exportados desde Procmon

- La revisión de los eventos contenidos en el archivo `csv` recientemente exportado la podemos realizar utilizando Python y, en particular, podemos usar una instancia en Google Colab.

- En el lado izquierdo de la interfaz web, click `File` (ícono de un folder/carpeta) y arrastrar el archivo `csv` que contiene los eventos Procmon. Este archivo se subirá a la instancia de Google Colab y aparecerá debajo de la carpeta `sample_data`.

    ![alt text](/assets/images/procmon-googlecolab.png)

- A continuación, inspeccionaremos el archivo con el objetivo final de final de conocer los valores únicos de la columna `Operation`.

    - Importar la librería Pandas:

        ```python
        import pandas as pd
        ```
    
    - Crear una variable para almacenar la ruta en la plataforma Google Colab del archivo `.csv`. Para obtener la ruta, simplemente dar click derecho en el archivo y luego `Copy path`. Luego, pegar la ruta como el valor que asignaremos a la variable.

        ```python
        csv_file_path = '/content/Logfile-powershell-hostname.CSV'
        ```
    
    - Crear una variable que almacenará el contenido del archivo `.csv` en forma de estructura de datos `dataframe`.

        ```python
        df = pd.read_csv(csv_file_path)
        ```

    - Una vez que hemos creado este `dataframe`, podemos inspeccionar la estructura del dataframe:

        ```python
        df.head()
        ```
    
    - También podemos ver la información macro de este `dataframe`:

        ```python
        df.info()
        ```
    
    - Otros comandos para revisar:

        ```python
        df.columns #imprimir las columnas
        columns = df.select_dtypes(include='object').columns # crea una lista 'columns' conteniendo todas las columnas del dataframe

        # Bucle para imprimir los valores únicos de cada columna
        for x in columns:
            unique_values = df[x].unique()
            print(f"\nUnique values in '{x}' column:")
            print(unique_values)
        ```
    
    - Nos interesa los valores únicos de la columna `Operation`

        ```python
        unique_values_operations = df['Operation'].unique()
        print(unique_values_operations)
        ```

    - En nuestro caso, para el comando `hostname`, los eventos únicos de la columna `Operation` son:

        ```python
        ['Process Start' 'Thread Create' 'Load Image' 'CreateFile'
        'QueryStandardInformationFile' 'ReadFile' 'CloseFile' 'RegOpenKey'
        'RegQueryValue' 'RegCloseKey' 'QueryBasicInformationFile'
        'CreateFileMapping' 'RegQueryKey' 'QueryNameInformationFile'
        'RegCreateKey' 'Thread Exit' 'Process Exit']
        ```

    - Recordar los Eventos en Sysmon:

        | ID  | Tag                    | Event                                    |
        |-----|------------------------|------------------------------------------|
        | 1   | ProcessCreate          | Process Creation                         |
        | 2   | FileCreateTime         | File creation time                       |
        | 3   | NetworkConnect         | Network connection detected              |
        | 4   | n/a                    | Sysmon service state change (cannot be filtered) |
        | 5   | ProcessTerminate       | Process terminated                       |
        | 6   | DriverLoad             | Driver Loaded                            |
        | 7   | ImageLoad              | Image loaded                             |
        | 8   | CreateRemoteThread     | CreateRemoteThread detected              |
        | 9   | RawAccessRead          | RawAccessRead detected                   |
        | 10  | ProcessAccess          | Process accessed                         |
        | 11  | FileCreate             | File created                             |
        | 12  | RegistryEvent          | Registry object added or deleted         |
        | 13  | RegistryEvent          | Registry value set                       |
        | 14  | RegistryEvent          | Registry object renamed                  |
        | 15  | FileCreateStreamHash   | File stream created                      |
        | 16  | n/a                    | Sysmon configuration change (cannot be filtered) |
        | 17  | PipeEvent              | Named pipe created                       |
        | 18  | PipeEvent              | Named pipe connected                     |
        | 19  | WmiEvent               | WMI filter                               |
        | 20  | WmiEvent               | WMI consumer                             |
        | 21  | WmiEvent               | WMI consumer filter                      |
        | 22  | DNSQuery               | DNS query                                |
        | 23  | FileDelete             | File Delete archived                     |
        | 24  | ClipboardChange        | New content in the clipboard             |
        | 25  | ProcessTampering       | Process image change                     |
        | 26  | FileDeleteDetected     | File Delete logged                       |
        | 27  | FileBlockExecutable    | File Block Executable                    |
        | 28  | FileBlockShredding     | File Block Shredding                     |
        | 29  | FileExecutableDetected | File Executable Detected                 |

    - Recordar la "equivalencia" entre los `Operation` de Procmon con los `Events` de Sysmon.

        | ID  | Sysmon Event Tag       | Procmon Operations                       |
        |-----|------------------------|------------------------------------------|
        | 1   | ProcessCreate          | Process Start                            |
        | 2   | FileCreateTime         | CreateFile                               |
        | 3   | NetworkConnect         | TCP Connect, UDP Send, UDP Receive       |
        | 4   | Sysmon service state change  | Not directly captured by Procmon   |
        | 5   | ProcessTerminate       | Process Terminate                        |
        | 6   | DriverLoad             | DeviceIoControl                          |
        | 7   | ImageLoad              | Load Image                               |
        | 8   | CreateRemoteThread     | Threat Create                            |
        | 9   | RawAccessRead          | Read File (sólo para accesos de bajo nivel al disco vía `RawAccessRead`)               |
        | 10  | ProcessAccess          | OpenProcess (Procmon no muestra explícitamente un equivalente a `ProcessAccess`)             |
        | 11  | FileCreate             | CreateFile                             |
        | 12  | RegistryEvent          | RegCreateKey, RegDeleteKey, RegDeleteValue   |
        | 13  | RegistryEvent          | RegSetValue                              |
        | 14  | RegistryEvent          | RegRenameKey (si explícitamente ha sido capturado en Procmon     )                  |
        | 15  | FileCreateStreamHash   | No explícitamente mapeado en Procmon     |
        | 16  | n/a                    | No explícitamente mapeado en Procmon     |
        | 17  | PipeEvent              | CreateNamedPipe                          |
        | 18  | PipeEvent              | ConnectNamedPipe                         |
        | 19  | WmiEvent               | No explícitamente mapeado en Procmon     |
        | 20  | WmiEvent               | No explícitamente mapeado en Procmon     |
        | 21  | WmiEvent               | No explícitamente mapeado en Procmon     |
        | 22  | DNSQuery               | UDP Send/Receive (sólo si las consultas DNS son explícitamente siendo recolectado)|
        | 23  | FileDelete             | File Delete                              |
        | 24  | ClipboardChange        | No capturado en Procmon                  |
        | 25  | ProcessTampering       | No explícitamente mapeado en Procmon     |
        | 26  | FileDeleteDetected     | File Delete                              |
        | 27  | FileBlockExecutable    | No explícitamente mapeado en Procmon     |
        | 28  | FileBlockShredding     | No explícitamente mapeado en Procmon     |
        | 29  | FileExecutableDetected | No explícitamente mapeado en Procmon, pero CreateFIle en archivos ejecutables podría indicar |

    - [Link en documentación](https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon#event-filtering-entries)

    - Algunos eventos de Sysmon, como el cambio de estado del servicio Sysmon o los eventos relacionados con WMI, no tienen equivalentes directos en ninguna operación de Procmon, ya que Procmon se centra en eventos de archivos, registro y procesos.

    - Las operaciones de registro de Procmon se corresponden estrechamente con los eventos de registro de Sysmon (IDs 12-14).

    - El acceso a disco de bajo nivel (por ejemplo, RawAccessRead) generalmente no se registra en Procmon, a menos que se habilite explícitamente mediante filtros.

    - Las consultas DNS se pueden observar en Procmon, pero requieren aplicar filtros para el tráfico UDP.

## Configuración de Filtros en Sysmon

- Dado que las Operaciones en Procmon resultaron ser:

    `'Process Start' -> ProcessCreate`
    `'Thread Create' -> CreateRemoteThread` 
    `'Load Image'  -> ImageLoad`
    `'CreateFile' -> 
    `'QueryStandardInformationFile'  -> 
    `'ReadFile'  -> 
    `'CloseFile'  -> 
    `'RegOpenKey' -> 
    `'RegQueryValue' -> 
    `'RegCloseKey' -> 
    `'QueryBasicInformationFile' -> 
    `'CreateFileMapping' -> 
    `'RegQueryKey' -> 
    `'QueryNameInformationFile' -> 
    `'RegCreateKey' -> 
    `'Thread Exit' -> 
    `'Process Exit' -> 












<!-- 1. Iniciar el servidor Caldera:

```bash
┌──(user㉿kali)-[~]
└─$ cd Caldera
                                                                                                                                           
┌──(user㉿kali)-[~/Caldera]
└─$ source caldera-env/bin/activate
                                                                                                                    
┌──(caldera-env)─(user㉿kali)-[~/Caldera]
└─$ cd 5.0.0 

┌──(caldera-env)─(user㉿kali)-[~/Caldera/5.0.0]
└─$ python server.py  
```

Solamente si es que tienen problemas para acceder al servidor Caldera desde la máquina de Windows (Target), tener en cuenta las siguientes configuraciones:






2. Desde la máquina de  -->