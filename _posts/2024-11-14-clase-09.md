---
title: Clase 09 - Caldera && Sysmon/Procmon
date: 2024-11-14 00:20:00 -0500
categories: [Cybersecurity,Ethical Hacking,Pentesting,Exploitation Techniques]
tags: [Examen Parcial, evaluation]     # TAG names should always be lowercase
---

<!-- <hr style="border: none; height: 10px; background-color: #003b00;" />

# <font color="#87CEEB">Examen Parcial.</font>

<hr style="border: none; height: 10px; background-color: #003b00;" /> -->

## 1. Setup de Laboratorio

### ¿Qué hace Caldera?
![alt text](/assets/images/caldera-setup.png)

### ¿Qué hace Sysmon y Procmon?

![alt text](/assets/images/sysmon-setup.png)

## 2. Instalando Caldera en el Kali Linux

### Actualización del Kali y preliminares

- Actualizar repositorios y hacer upgrade:

```bash
┌──(user㉿kali)-[~]
└─$ sudo apt update && sudo apt upgrade -y
```

- Crear una carpeta `Caldera`

```bash
┌──(user㉿kali)-[~]
└─$ mkdir ~/Caldera
```

### Crear un entorno virtual de python

- Por buenas prácticas, siempre es bueno crear un entorno virtual de python para instalar una aplicación basada en Python.

```bash
┌──(user㉿kali)-[~]
└─$ cd ~/Caldera
└─$ python -m venv caldera-env
```

- Activar el entorno virtual

```bash
┌──(user㉿kali)-[~/Caldera]
└─$ source caldera-env/bin/activate
                                                                                                                     
┌──(caldera-env)─(user㉿kali)-[~/Caldera]
```

### Descarga de Go

- Link de descarga de Go Installer [Link](https://go.dev/dl/)
- Link de pasos de instalación de Go en Linux [Link](https://go.dev/doc/install)


- Descargar el instalador para Linux

```bash
┌──(user㉿kali)-[~/Caldera]
└─$ cd ~/Downloads
┌──(user㉿kali)-[~/Downloads]
└─$ wget https://go.dev/dl/go1.23.3.linux-amd64.tar.gz
```

- Eliminar cualquier instalación de Go y descomprimir el archivo descargado en `/usr/local`

```bash
┌──(user㉿kali)-[~/Downloads]
└─$ sudo rm -rf /usr/local/go && sudo tar -C /usr/local -xzf go1.23.3.linux-amd64.tar.gz
```

- Añadir `/usr/local/go/bin` a la variable de entorno `PATH`

```bash
(caldera-env)─(user㉿kali)-[~/Downloads]
└─$ sudo nano /etc/profile
```

Add `export PATH=$PATH:/usr/local/go/bin` to `/etc/profile`

![alt text](/assets/images/export-to-profile.png)

- Comprobar la versión de go

```bash
┌──(caldera-env)─(user㉿kali)-[~/Downloads]
└─$ go version 
Command 'go' not found, but can be installed with:
sudo apt install gccgo-go 
sudo apt install golang-go
```

- Reiniciar

- Comprobar nuevamente la version de Go

```bash
┌──(user㉿kali)-[~/Downloads]
└─$ go version
go version go1.23.3 linux/amd64
```

### Instalar NodeJs

```bash
┌──(user㉿kali)-[~/Downloads]
└─$ sudo apt install nodejs
└─$ node -v
v20.17.0
```

### Instalar Npm
```bash
┌──(user㉿kali)-[~/Downloads]
└─$ sudo apt install npm
└─$ npm -v

```




### Verificamos los requerimientos 

- Any Linux or MacOS (**Check**)
- Python 3.8+ (with Pip3) (**Check**)
- Recommended hardware to run on is 8GB+ RAM and 2+ CPUs (**Check**)
- Recommended: GoLang 1.17+ to dynamically compile GoLang-based agents. (**Check**)
- NodeJS (v16+ recommended for v5 VueJS UI) (**Check**)

### Instalar Caldera

- Descargar Caldera de manera recursiva apuntando hacia un determinado version/release.

```bash
┌──(user㉿kali)-[~/Downloads]
└─$ cd ~/Caldera
└─$ git clone https://github.com/mitre/caldera.git --recursive --tag 5.0.0
```

```bash
┌──(user㉿kali)-[~/Caldera]
└─$ source caldera-env/bin/activate
┌──(caldera-env)─(user㉿kali)-[~/Caldera]
└─$ cd 5.0.0
┌──(caldera-env)─(user㉿kali)-[~/Caldera/5.0.0]
└─$ pip3 install -r requirements.txt
```

![alt text](/assets/images/requirements-installation.png)

- Iniciamos el Caldera server

```bash
┌──(caldera-env)─(user㉿kali)-[~/Caldera/5.0.0]
└─$ python3 server.py --insecure --build
```
- En caso de que aparezcan errores, `CTRL+C` para detener el servidor Caldera y resolver errores.

### Resolviendo errores

- Si aparece algún error, generalmente es por paquetes ausentes.
- Si acusara algo relacionado al paquete `distutils`, ejecutar:

```bash
┌──(caldera-env)─(user㉿kali)-[~/Caldera/5.0.0]
└─$ pip install setuptools 
```

- Si acusa algún error relacionado con `docker`, ejecutar:

```bash
┌──(caldera-env)─(user㉿kali)-[~/Caldera/5.0.0]
└─$ pip install docker
```

### Volver a iniciar el servidor Caldera

```bash
┌──(caldera-env)─(user㉿kali)-[~/Caldera/5.0.0]
└─$ python3 server.py --build
```

## Habilitando el Plugin EMU

```bash
┌──(caldera-env)─(user㉿kali)-[~/Caldera/5.0.0]
└─$ cp conf/default.yml conf/local.yml
```

```bash
┌──(caldera-env)─(user㉿kali)-[~/Caldera/5.0.0]
└─$ nano conf/local.yml
```

- Añadir `- emu` a la lista de plugins

![alt text](/assets/images/adding-emu-to-localyml.png)

- Instalamos el `pyminizip`

```bash
┌──(caldera-env)─(user㉿kali)-[~/Caldera/5.0.0]
└─$ pip install pyminizip    
```

- Vamos hasta la carpeta `emu`

```bash
┌──(caldera-env)─(user㉿kali)-[~/…/5.0.0/plugins/emu/data]
└─$ cd ..              
                                                                                                                     
┌──(caldera-env)─(user㉿kali)-[~/Caldera/5.0.0/plugins/emu]
└─$ ls
LICENSE    __pycache__  conf  download_payloads.sh  hook.py   requirements.txt  tests
README.md  app          data  gui                   payloads  templates         tox.ini
```

- Ejecutamos la descarga de archivos del plugin `emu`

```bash
┌──(caldera-env)─(user㉿kali)-[~/Caldera/5.0.0/plugins/emu]
└─$ ./download_payloads.sh  
```

- Password para el archivo `AdFind.exe` es `NotMalware`

```bash
[payloads/AdFind.zip] AdFind.exe password: 
```

- Volvemos a la ruta de caldera

```bash
┌──(caldera-env)─(user㉿kali)-[~/Caldera/5.0.0/plugins/emu]
└─$ cd ~/Caldera/5.0.0
```

- Iniciamos el Caldera server nuevamente con el flag `--build`

```bash
┌──(caldera-env)─(user㉿kali)-[~/Caldera/5.0.0]
└─$ python3 server.py --build
```

- Aparecerán algunos warnings, pero los vamos a desconsiderar

```bash
2024-11-14 09:51:10 WARNING  Could not find payload ryuk.exe within                                    emu_svc.py:320
                             plugins/emu/data/adversary-emulation-plans.                                             
                    WARNING  Could not find payload dumpWebBrowserCreds.exe within                     emu_svc.py:320
                             plugins/emu/data/adversary-emulation-plans.                                             
                    WARNING  Could not find payload m64.exe within                                     emu_svc.py:320
                             plugins/emu/data/adversary-emulation-plans.                                             
                    WARNING  Could not find payload rubeus.exe within                                  emu_svc.py:320
                             plugins/emu/data/adversary-emulation-plans.                                            
```
- Ingresamos al firefox y vamos al web interface del caldera server (`localhost:8888`)

![alt text](/assets/images/localhost8888.png)

- Ingresamos con `admin:admin`

![alt text](/assets/images/calderalogin.png)

![alt text](/assets/images/calderadashboard.png)

